# frozen_string_literal: true

# This class mimics the AttachmentUploader and reuses the existing "uploads" bucket for storage
# but skips the RecordsUploads concern to prevent generating Upload records (now discouraged).

module Security
  module VulnerabilityScanning
    class SbomScanResultUploader < GitlabUploader
      include ObjectStorage::Concern
      extend ::Gitlab::Utils::Override

      STORE_PATH_PREFIX = 'sbom_scan_results'

      class << self
        # A default store allows to initialize the AR model with the right value, avoiding a column update.
        def default_store
          object_store_enabled? ? ObjectStorage::Store::REMOTE : ObjectStorage::Store::LOCAL
        end

        def hashed_path(project_id, model_identifier)
          Gitlab::HashedPath.new(
            model_identifier,
            root_hash: project_id
          ).to_s
        end
      end

      alias_method :upload, :model

      # This uploader is used with a model that doesn't automatically update its <mounted_as>_store DB columns
      # with callbacks. We need to let the uploader set this value when actually storing the file.
      override :sync_model_object_store?
      def sync_model_object_store?
        true
      end

      private

      def dynamic_segment
        raise ObjectNotReadyError, "SbomScanResult model not ready" unless model.id

        File.join(STORE_PATH_PREFIX, self.class.hashed_path(model.project_id, model.id))
      end
    end
  end
end
