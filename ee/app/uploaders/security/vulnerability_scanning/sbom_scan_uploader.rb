# frozen_string_literal: true

# This class mimics the AttachmentUploader and reuses the existing "uploads" bucket for storage
# but skips the RecordsUploads concern to prevent generating Upload records (now discouraged).

module Security
  module VulnerabilityScanning
    class SbomScanUploader < GitlabUploader
      extend Workhorse::UploadPath
      include ObjectStorage::Concern
      extend ::Gitlab::Utils::Override

      # Since we reuse the 'uploads' bucket, we add a prefix to group these files under the same nested directory.
      STORE_PATH_PREFIX = 'sbom_scans'
      SBOM_FILENAME = 'sbom.json'

      class << self
        # A default store allows to initialize the AR model with the right value, avoiding a column update.
        def default_store
          object_store_enabled? ? ObjectStorage::Store::REMOTE : ObjectStorage::Store::LOCAL
        end

        # Used for direct upload to save an unnecessary copy by storing the file in its final location.
        # Since there is no AR record existing when using direct upload, we use a UUID to ensure uniqueness.
        def generate_final_store_path(project_id, build_id)
          uuid = Digest::SHA2.hexdigest(SecureRandom.uuid)
          File.join(STORE_PATH_PREFIX, hashed_path(project_id, build_id, uuid), SBOM_FILENAME)
        end

        # Ensure we use a consistent upload path for all upload methods.
        def hashed_path(project_id, build_id, model_identifier, created_at: nil)
          timestamp = created_at || Time.current.utc
          Gitlab::HashedPath.new(
            timestamp.strftime('%Y_%m_%d'),
            build_id,
            model_identifier,
            root_hash: project_id
          ).to_s
        end
      end

      alias_method :upload, :model

      # This uploader is used with a model that doesn't automatically updates its <mounted_as>_store DB columns
      # with callbacks. We need to let the uploader set this value when actually storing the file.
      override :sync_model_object_store?
      def sync_model_object_store?
        true
      end

      private

      def dynamic_segment
        raise ObjectNotReadyError, "SbomScan model not ready" unless model.id

        File.join(
          STORE_PATH_PREFIX,
          self.class.hashed_path(model.project_id, model.build_id, model.id, created_at: model.created_at)
        )
      end
    end
  end
end
