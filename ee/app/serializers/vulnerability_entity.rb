# frozen_string_literal: true

class VulnerabilityEntity < Grape::Entity
  include RequestAwareEntity

  MAX_SBOM_OCCURRENCES = 500

  expose :id,
    :title,
    :state,
    :severity,
    :report_type,
    :resolved_on_default_branch,
    :project_default_branch,
    :resolved_at,
    :resolved_by_id,
    :dismissed_at,
    :dismissed_by_id,
    :confirmed_at,
    :confirmed_by_id
  expose :state_transitions, using: Vulnerabilities::StateTransitionEntity
  expose :issue_links, using: Vulnerabilities::IssueLinkEntity
  expose :merge_request_links, using: Vulnerabilities::MergeRequestLinkEntity
  expose :created_at, as: :detected_at
  expose :ai_resolution_enabled?, as: :ai_resolution_enabled

  expose :dependency_paths do |vulnerability|
    serialized_dependency_paths(vulnerability.dependency_paths_with_limit[:paths])
  end
  expose :dependency_paths_limit_exceeded do |vulnerability|
    vulnerability.dependency_paths_with_limit[:limit_exceeded]
  end
  expose :reachability
  expose :sbom_occurrences do |vulnerability|
    vulnerability.sbom_occurrence_ids_and_input_file_paths(limit: MAX_SBOM_OCCURRENCES).map do |id, input_file_path|
      {
        id: id,
        input_file_path: input_file_path
      }
    end
  end

  private

  def serialized_dependency_paths(paths)
    paths.map do |path|
      Sbom::DependencyPathEntity.represent(path)
    end
  end
end
