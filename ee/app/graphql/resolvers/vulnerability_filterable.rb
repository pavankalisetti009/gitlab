# frozen_string_literal: true

module Resolvers
  module VulnerabilityFilterable
    extend ActiveSupport::Concern
    include ::Security::GroupIdentifierSearch
    include Gitlab::Utils::StrongMemoize

    private

    ADVANCED_FILTERS = [:owasp_top_10_2021, :identifier_name, :reachability, :validity_check, :policy_violations].freeze

    def validate_filters(filters)
      # identifier_name is also supported on postgres
      validate_advanced_vuln_management! if (ADVANCED_FILTERS - [:identifier_name]).any? { |f| filters[f].present? }

      if filters[:identifier_name].present?
        validate_instance_security_dashboard_not_supported! if object.is_a?(::InstanceSecurityDashboard)

        # Identifier validation should run only when Advanced vulnerability management is not enabled.
        # And the validation returns false if Group has more than 20K vulnerabilities.
        search_by_identifier_allowed_on_db!(vulnerable: object) unless advanced_vuln_mgmt_available?
      end

      validate_owasp_top_ten(filters[:owasp_top_10], "owasp_top_ten") if filters[:owasp_top_10].present?
      validate_owasp_top_ten(filters[:owasp_top_10_2021], "owasp_top_ten_2021") if filters[:owasp_top_10_2021].present?

      validate_reachability!(vulnerable) if filters[:reachability].present?
      validate_validity_check!(vulnerable) if filters[:validity_check].present?
      validate_policy_violations!(vulnerable) if filters[:policy_violations].present?
    end

    def validate_owasp_top_ten(owasp_top_ten, argument_name)
      includes_filter_none = owasp_top_ten.include?(::Security::VulnerabilityReadsFinder::FILTER_NONE)

      return if owasp_top_ten.size <= 1

      return unless includes_filter_none

      raise ::Gitlab::Graphql::Errors::ArgumentError,
        "Incompatible argument: #{argument_name}. 'NONE' wildcard cannot be combined with other OWASP top 10 values."
    end

    def validate_instance_security_dashboard_not_supported!
      raise ::Gitlab::Graphql::Errors::ArgumentError,
        "Feature is not supported for InstanceSecurityDashboard"
    end

    def validate_advanced_vuln_management!
      validate_instance_security_dashboard_not_supported! if object.is_a?(::InstanceSecurityDashboard)

      validate_self_managed_first_backfill! if ::Search::Elastic::VulnerabilityIndexHelper.self_managed_with_es?

      return if advanced_vuln_mgmt_available?

      raise ::Gitlab::Graphql::Errors::ArgumentError,
        "Require advanced vulnerability management to be enabled!"
    end

    def advanced_vuln_mgmt_available?
      current_user.can?(:access_advanced_vulnerability_management, object)
    end
    strong_memoize_attr :advanced_vuln_mgmt_available?

    def use_elasticsearch?(filters)
      ADVANCED_FILTERS.any? { |filter| filters[filter].present? } &&
        advanced_vuln_mgmt_available?
    end

    def validate_self_managed_first_backfill!
      return if ::Search::Elastic::VulnerabilityIndexHelper
                      .self_managed_and_first_backfill_completed?

      raise ::Gitlab::Graphql::Errors::ArgumentError,
        "Require data backfill migration to be completed!"
    end
    strong_memoize_attr :validate_self_managed_first_backfill!

    def validate_reachability!(vulnerable)
      return if vulnerable.is_a?(Project) || vulnerable.is_a?(Group)

      validate_instance_security_dashboard_not_supported!
    end

    def validate_validity_check!(vulnerable)
      group =
        if vulnerable.is_a?(Project)
          vulnerable.group
        elsif vulnerable.is_a?(Group)
          vulnerable
        end

      return unless group

      return if Feature.enabled?(:validity_check_es_filter, group) &&
        ::Elastic::DataMigrationService.migration_has_finished?(
          :backfill_token_status_by_report_types_in_vulnerabilities
        )

      raise ::Gitlab::Graphql::Errors::ArgumentError,
        'The feature flag is not enabled or the required migrations are not completed.'
    end

    def validate_policy_violations!(vulnerable)
      group =
        if vulnerable.is_a?(Project)
          vulnerable.group
        elsif vulnerable.is_a?(Group)
          vulnerable
        end

      return unless group

      return if Feature.enabled?(:policy_violations_es_filter,
        group) && ::Elastic::DataMigrationService.migration_has_finished?(:add_policy_violations_field_to_vulnerability)

      raise ::Gitlab::Graphql::Errors::ArgumentError,
        'The feature flag is not enabled or the required migrations are not completed.'
    end
  end
end
