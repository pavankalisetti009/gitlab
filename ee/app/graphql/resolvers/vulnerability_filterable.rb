# frozen_string_literal: true

module Resolvers
  module VulnerabilityFilterable
    extend ActiveSupport::Concern

    private

    def validate_filters(filters)
      validate_owasp_top_ten(filters) if filters[:owasp_top_10].present?
    end

    def validate_owasp_top_ten(filters)
      owasp_top_ten = filters[:owasp_top_10]

      includes_filter_none = owasp_top_ten.include?(::Security::VulnerabilityReadsFinder::FILTER_NONE)

      if includes_filter_none && null_feature_disabled?
        raise_resource_not_available_error!('Filtering by NONE is not allowed as the feature flag is disabled.')
      end

      return if owasp_top_ten.size <= 1

      return unless includes_filter_none

      raise ::Gitlab::Graphql::Errors::ArgumentError,
        'Incompatible argument: owasp_top_ten. "NONE" wildcard cannot be combined with other OWASP top 10 values.'
    end

    def null_feature_disabled?
      if vulnerable.is_a?(::InstanceSecurityDashboard)
        Feature.disabled?(:owasp_top_10_null_filtering, current_user, type: :beta)
      else
        Feature.disabled?(:owasp_top_10_null_filtering, vulnerable, type: :beta)
      end
    end
  end
end
