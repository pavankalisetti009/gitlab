# frozen_string_literal: true

module Vulnerabilities
  module Backups
    class Vulnerability < Backup
      class BackupPartition < SecApplicationRecord
        include ::Namespaces::Traversal::Traversable

        self.abstract_class = true

        scope :ordered_by_existence, -> { order(:traversal_ids, :original_record_identifier) }
      end

      backup_of ::Vulnerability

      partitioned_by :date, strategy: :monthly, retain_for: 12.months

      scope :by_original_ids, ->(original_ids) { where(original_record_identifier: original_ids) }

      class << self
        def partition_models
          current_partitions.map do |current_partition|
            Class.new(BackupPartition) do
              self.table_name = "#{Gitlab::Database::DYNAMIC_PARTITIONS_SCHEMA}.#{current_partition.partition_name}"
              self.primary_key = %i[traversal_ids original_record_identifier]
            end
          end
        end

        def current_partitions
          Gitlab::Database::SharedModel.using_connection(connection) do
            partitioning_strategy.current_partitions
          end
        end
      end
    end
  end
end
