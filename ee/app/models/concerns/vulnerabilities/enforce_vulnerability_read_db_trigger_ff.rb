# frozen_string_literal: true

# This transaction code exists to help identify and prevent instances of code
# that may need to explicitly pass a feature flag setting to the vulnerability
# reads database trigger.
#
# Once transitioned away from the database trigger, we can remove it.

module Vulnerabilities
  module EnforceVulnerabilityReadDbTriggerFf
    UnflaggedVulnReadDatabaseTriggerTransaction = Class.new(StandardError)

    def self.extended(base)
      base.define_singleton_method(:transaction) do |*args, **kwargs, &block|
        if base.db_trigger_flag_not_set?
          if Rails.env.test?
            error = 'This transaction is not passing the needed feature flag to the vulnerability read db trigger.'
            raise UnflaggedVulnReadDatabaseTriggerTransaction, error
          else
            Gitlab::AppLogger.warn(
              "Sec transaction executed without setting vulnerability read db trigger feature flag!"
            )
          end
        end

        super(*args, **kwargs, &block)
      end
    end
  end
end
