# frozen_string_literal: true

module Security
  module VulnerabilityManagementPolicy
    POLICY_LIMIT = 5

    def self.included(base)
      base.extend(ClassMethods)
    end

    def active_vulnerability_management_policies
      vulnerability_management_policy.select { |config| config[:enabled] }.first(POLICY_LIMIT)
    end

    def vulnerability_management_policy
      policy_by_type(:vulnerability_management_policy)
    end

    module ClassMethods
      def auto_resolve_policies(limit: POLICY_LIMIT)
        type_vulnerability_management_policy
          .enabled
          .where("content -> 'actions' @> ?", [{ "type" => "auto_resolve" }].to_json)
          .limit(limit)
      end

      def auto_resolve_policies_with_rules(limit: POLICY_LIMIT)
        auto_resolve_policies(limit: limit)
          .includes(:vulnerability_management_policy_rules)
      end

      def no_longer_detected_rules(limit: POLICY_LIMIT)
        auto_resolve_policies_with_rules(limit: limit)
          .flat_map(&:rules)
          .filter { |r| r.type == "no_longer_detected" }
      end
    end
  end
end
