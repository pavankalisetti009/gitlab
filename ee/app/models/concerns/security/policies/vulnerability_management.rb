# frozen_string_literal: true

module Security
  module Policies
    module VulnerabilityManagement
      extend ActiveSupport::Concern

      included do
        scope :auto_resolve_policies, -> do
          type_vulnerability_management_policy
            .undeleted
            .enabled
            .where("content -> 'actions' @> ?", [{ "type" => "auto_resolve" }].to_json)
        end

        scope :auto_dismiss_policies, -> do
          type_vulnerability_management_policy
            .undeleted
            .enabled
            .where("content -> 'actions' @> ?", [{ "type" => "auto_dismiss" }].to_json)
        end

        scope :including_rules, -> { includes(:vulnerability_management_policy_rules) }
      end

      def dismissal_reason
        content.dig('actions', 0, 'dismissal_reason')
      end
    end
  end
end
