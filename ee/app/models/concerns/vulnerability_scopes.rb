# frozen_string_literal: true

module VulnerabilityScopes
  extend ActiveSupport::Concern

  included do
    scope :without_archived_projects, ->(project_ids = []) do
      return none if project_ids.nil?

      # no other actor available in this scope
      if Feature.disabled?(:vulnerability_scope_disable_cross_join, Feature.current_request)
        return joins(:project).merge(::Project.non_archived)
                              .where(project_id: project_ids)
                              .allow_cross_joins_across_databases(url: 'https://gitlab.com/gitlab-org/gitlab/-/issues/485658')
      end

      where(project_id: ::Project.non_archived.where(id: project_ids).pluck_primary_key)
    end

    scope :for_projects, ->(project_ids, include_archived = false) do
      if include_archived
        where(project_id: project_ids)
      else
        without_archived_projects(project_ids)
      end
    end
  end
end
