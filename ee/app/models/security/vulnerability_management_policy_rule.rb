# frozen_string_literal: true

module Security
  class VulnerabilityManagementPolicyRule < ApplicationRecord
    include PolicyRule

    self.table_name = 'vulnerability_management_policy_rules'

    enum :type, { no_longer_detected: 0, detected: 1 }, prefix: true

    belongs_to :security_policy, class_name: 'Security::Policy', inverse_of: :vulnerability_management_policy_rules

    validates :typed_content, json_schema: { filename: "vulnerability_management_policy_rule_content" }

    def match?(vulnerability)
      if type_no_longer_detected?
        scanners.include?(vulnerability.report_type) && severity_levels.include?(vulnerability.severity)
      else
        match_detected?(vulnerability)
      end
    end

    private

    def scanners
      return ::Enums::Vulnerability.report_types.keys if content['scanners'].blank?

      content['scanners']
    end

    def severity_levels
      return ::Enums::Vulnerability.severity_levels.keys if content['severity_levels'].blank?

      content['severity_levels']
    end

    def criteria
      content['criteria']
    end

    def match_detected?(vulnerability)
      return false unless criteria.present?

      criteria.all? do |criterion|
        match_vulnerability_criteria?(vulnerability, criterion)
      end
    end

    def match_vulnerability_criteria?(vulnerability, criterion)
      criterion_type = criterion['type']
      criterion_value = criterion['value']

      case criterion_type
      when 'file_path'
        match_file_path?(vulnerability, criterion_value)
      when 'directory'
        match_directory?(vulnerability, criterion_value)
      when 'identifier'
        match_identifier?(vulnerability, criterion_value)
      else
        false
      end
    end

    def match_file_path?(vulnerability, pattern)
      file_path = vulnerability.file
      return false unless file_path

      match_path?(pattern, file_path)
    end

    def match_directory?(vulnerability, pattern)
      file_path = vulnerability.file
      return false unless file_path

      directory = File.dirname(file_path)
      match_path?(pattern, directory) || match_path?("#{pattern}/**/*", file_path)
    end

    def match_path?(pattern, path)
      File.fnmatch?(pattern, path, File::FNM_PATHNAME | File::FNM_DOTMATCH)
    end

    def match_identifier?(vulnerability, pattern)
      identifiers = vulnerability.identifiers
      return false if identifiers.blank?

      identifiers.any? do |identifier|
        File.fnmatch?(pattern, identifier.name, File::FNM_CASEFOLD)
      end
    end
  end
end
