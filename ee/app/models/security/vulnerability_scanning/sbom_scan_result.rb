# frozen_string_literal: true

module Security
  module VulnerabilityScanning
    class SbomScanResult < ::SecApplicationRecord
      self.table_name = :sbom_vulnerability_scan_results

      belongs_to :project
      has_many :sbom_scans, class_name: 'Security::VulnerabilityScanning::SbomScan',
        foreign_key: 'sbom_vulnerability_scan_result_id', inverse_of: :result

      mount_uploader :result_file, Security::VulnerabilityScanning::SbomScanResultUploader

      # Avoid storing large files during DB transaction. We call these methods manually instead.
      skip_callback :save, :after, :store_result_file!

      # Setting default store dynamically based on the instance storage configuration
      attribute :result_file_store, default: -> { ::Security::VulnerabilityScanning::SbomScanUploader.default_store }

      scope :without_scans, ->(result_ids) { where(id: result_ids).where.missing(:sbom_scans) }

      def delete_files_from_storage
        result_file.remove!
        true
      rescue StandardError => e
        Gitlab::ErrorTracking.track_exception(e)
        false
      end
    end
  end
end
