<script>
import { GlAlert, GlLoadingIcon } from '@gitlab/ui';
import { uniq, map } from 'lodash';
import blobInfoQuery from 'shared_queries/repository/blob_info.query.graphql';
import CodeFlowFileViewer from 'ee/vulnerabilities/components/code_flow/code_flow_file_viewer.vue';
import CodeFlowStepsSection from 'ee/vulnerabilities/components/code_flow/code_flow_steps_section.vue';

export default {
  name: 'VulnerabilityCodeFlow',
  components: {
    GlAlert,
    GlLoadingIcon,
    CodeFlowFileViewer,
    CodeFlowStepsSection,
  },
  inject: ['projectFullPath'],
  props: {
    branchRef: {
      type: String,
      required: true,
    },
    details: {
      type: Object,
      required: true,
    },
    description: {
      type: String,
      required: false,
      default: null,
    },
    descriptionHtml: {
      type: String,
      required: false,
      default: null,
    },
  },
  data() {
    return {
      loadingError: false,
      blobInfo: [],
      project: null,
      rawTextBlobs: {},
    };
  },
  computed: {
    fileNames() {
      const fileNames = map(this.details?.items[0], 'fileLocation.fileName');
      return uniq(fileNames);
    },
  },
  apollo: {
    project: {
      query: blobInfoQuery,
      variables() {
        return {
          projectPath: this.projectFullPath,
          filePath: this.fileNames,
          ref: this.branchRef,
          refType: null,
          shouldFetchRawText: true,
        };
      },
      update({ project }) {
        const allBlobInfo = project?.repository?.blobs?.nodes || [];
        allBlobInfo.forEach((blobInfo) => {
          const { rawTextBlob, path } = blobInfo;

          this.rawTextBlobs = {
            ...this.rawTextBlobs,
            [path]: rawTextBlob,
          };

          this.blobInfo = {
            ...this.blobInfo,
            [path]: { data: blobInfo },
          };
        });
      },
      error() {
        this.loadingError = true;
      },
    },
  },
};
</script>

<template>
  <div class="gl-flex gl-gap-5 gl-pt-5">
    <gl-loading-icon
      v-if="$apollo.queries.project.loading"
      size="sm"
      class="gl-flex gl-items-center gl-justify-center flex-fill"
    />

    <gl-alert
      v-else-if="loadingError"
      :dismissible="false"
      variant="danger"
      data-testid="loading-error"
    >
      {{ s__('Vulnerability|Something went wrong while trying to get the source file.') }}
    </gl-alert>

    <template v-else>
      <code-flow-steps-section
        ref="codeFlowStepSection"
        :description="description"
        :description-html="descriptionHtml"
        :details="details"
        :raw-text-blobs="rawTextBlobs"
      />

      <div class="gl-flex gl-flex-col gl-gap-5 flex-fill gl-w-12/20">
        <code-flow-file-viewer />
      </div>
    </template>
  </div>
</template>
