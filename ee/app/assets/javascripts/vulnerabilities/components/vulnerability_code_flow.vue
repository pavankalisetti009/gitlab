<script>
import { GlAlert, GlLoadingIcon } from '@gitlab/ui';
import { uniq, map } from 'lodash';
import blobInfoQuery from 'shared_queries/repository/blob_info.query.graphql';

export default {
  name: 'VulnerabilityCodeFlow',
  components: {
    GlAlert,
    GlLoadingIcon,
  },
  inject: ['projectFullPath'],
  props: {
    branchRef: {
      type: String,
      required: true,
    },
    details: {
      type: Object,
      required: true,
    },
  },
  data() {
    return {
      loadingError: false,
      isLoading: true,
      blobInfo: [],
      project: null,
    };
  },
  computed: {
    fileNames() {
      const fileNames = map(this.details?.items[0], 'fileLocation.fileName');
      return uniq(fileNames);
    },
  },
  apollo: {
    project: {
      query: blobInfoQuery,
      variables() {
        return {
          projectPath: this.projectFullPath,
          filePath: this.fileNames,
          ref: this.branchRef,
          refType: null,
          shouldFetchRawText: true,
        };
      },
      update({ project }) {
        this.blobInfo = project?.repository?.blobs?.nodes || [];
        this.isLoading = false;
      },
      error() {
        this.isLoading = false;
        this.loadingError = true;
      },
    },
  },
};
</script>

<template>
  <div class="gl-flex gl-gap-5 gl-pt-5">
    <gl-loading-icon
      v-if="isLoading"
      size="sm"
      class="gl-flex gl-items-center gl-justify-center flex-fill"
    />

    <gl-alert
      v-else-if="loadingError"
      :dismissible="false"
      variant="danger"
      data-testid="loading-error"
    >
      {{ s__('Vulnerability|Something went wrong while trying to get the source file.') }}
    </gl-alert>
  </div>
</template>
