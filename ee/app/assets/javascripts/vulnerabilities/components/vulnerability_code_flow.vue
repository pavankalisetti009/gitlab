<script>
import { GlAlert, GlLoadingIcon } from '@gitlab/ui';
import { uniq, map } from 'lodash';
import blobInfoQuery from 'shared_queries/repository/blob_info.query.graphql';
import CodeFlowFileViewer from 'ee/vulnerabilities/components/code_flow/code_flow_file_viewer.vue';
import CodeFlowStepsSection from 'ee/vulnerabilities/components/code_flow/code_flow_steps_section.vue';
import {
  createHighlightSourcesInfo,
  normalizeCodeFlowsInfo,
} from 'ee/vulnerabilities/components/code_flow/utils/utils';

export default {
  name: 'VulnerabilityCodeFlow',
  components: {
    GlAlert,
    GlLoadingIcon,
    CodeFlowFileViewer,
    CodeFlowStepsSection,
  },
  inject: ['projectFullPath'],
  props: {
    branchRef: {
      type: String,
      required: true,
    },
    details: {
      type: Object,
      required: true,
    },
    description: {
      type: String,
      required: false,
      default: null,
    },
    descriptionHtml: {
      type: String,
      required: false,
      default: null,
    },
    calculatedHeaderHeight: {
      type: Number,
      required: false,
      default: 0,
    },
  },
  data() {
    return {
      loadingError: false,
      blobInfo: [],
      project: null,
      rawTextBlobs: {},
      highlightSourcesInfo: {},
      contentHeight: '0px',
    };
  },
  computed: {
    fileNames() {
      const fileNames = map(this.details?.items[0], 'fileLocation.fileName');
      return uniq(fileNames);
    },
    codeSourceFiles() {
      return Object.keys(this.highlightSourcesInfo);
    },
  },
  mounted() {
    this.adjustContentHeight();
    window.addEventListener('resize', this.adjustContentHeight);
  },
  beforeDestroy() {
    window.removeEventListener('resize', this.adjustContentHeight);
  },
  apollo: {
    project: {
      query: blobInfoQuery,
      variables() {
        return {
          projectPath: this.projectFullPath,
          filePath: this.fileNames,
          ref: this.branchRef,
          refType: null,
          shouldFetchRawText: true,
        };
      },
      update({ project }) {
        const allBlobInfo = project?.repository?.blobs?.nodes || [];
        allBlobInfo.forEach((blobInfo) => {
          const { rawTextBlob, path } = blobInfo;

          this.rawTextBlobs = {
            ...this.rawTextBlobs,
            [path]: rawTextBlob,
          };

          this.blobInfo = {
            ...this.blobInfo,
            [path]: { data: blobInfo },
          };
        });
        const normalizedCodeFlows = normalizeCodeFlowsInfo(this.details);
        this.highlightSourcesInfo = createHighlightSourcesInfo(
          normalizedCodeFlows,
          this.rawTextBlobs,
        );
      },
      error() {
        this.loadingError = true;
      },
    },
  },
  methods: {
    codeFlowFileLoaded() {
      this.$refs.codeFlowStepSection.markdownBlobData();
    },
    specificBlobInfo(fileName) {
      return this.blobInfo[fileName]?.data || {};
    },
    adjustContentHeight() {
      this.$nextTick(() => {
        const headerRef = this.calculatedHeaderHeight;
        const windowHeight = window.innerHeight;
        const contentHeight = windowHeight - headerRef;
        this.contentHeight = `${contentHeight}px`;
      });
    },
  },
};
</script>

<template>
  <div class="gl-flex gl-gap-5 gl-py-5">
    <gl-loading-icon
      v-if="$apollo.queries.project.loading"
      size="sm"
      class="flex-fill gl-flex gl-items-center gl-justify-center"
    />

    <gl-alert
      v-else-if="loadingError"
      :dismissible="false"
      variant="danger"
      data-testid="loading-error"
    >
      {{ s__('Vulnerability|Something went wrong while trying to get the source file.') }}
    </gl-alert>

    <template v-else>
      <code-flow-steps-section
        ref="codeFlowStepSection"
        :style="{ height: contentHeight }"
        :description="description"
        :description-html="descriptionHtml"
        :details="details"
        :raw-text-blobs="rawTextBlobs"
      />

      <div
        id="code-flows-container"
        :style="{ height: contentHeight }"
        class="flex-fill gl-flex gl-w-12/20 gl-flex-col gl-gap-5 gl-overflow-auto gl-pt-2"
      >
        <code-flow-file-viewer
          v-for="fileName in codeSourceFiles"
          :key="fileName"
          :file-path="fileName"
          :branch-ref="branchRef"
          :hl-info="highlightSourcesInfo[fileName]"
          :blob-info="specificBlobInfo(fileName)"
          @codeFlowFileLoaded="codeFlowFileLoaded"
        />
      </div>
    </template>
  </div>
</template>
