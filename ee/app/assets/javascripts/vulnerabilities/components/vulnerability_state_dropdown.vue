<script>
import { GlCollapsibleListbox } from '@gitlab/ui';
import { s__ } from '~/locale';
import { VULNERABILITY_STATE_OBJECTS, DISMISSAL_REASONS } from '../constants';

const { dismissed, ...VULNERABILITY_STATE_OBJECTS_WITHOUT_DISMISSED } = VULNERABILITY_STATE_OBJECTS;

const STATES = Object.keys(VULNERABILITY_STATE_OBJECTS_WITHOUT_DISMISSED).map((state) => ({
  value: state,
  text: VULNERABILITY_STATE_OBJECTS[state].dropdownText,
  dropdownDescription: VULNERABILITY_STATE_OBJECTS[state].dropdownDescription,
}));
const STATES_GROUP = { text: '', textSrOnly: true, options: STATES };

export default {
  components: { GlCollapsibleListbox },
  inject: ['dismissalDescriptions'],
  props: {
    state: { type: String, required: true },
    dismissalReason: { type: String, required: false, default: null },
    disabled: { type: Boolean, required: false, default: false },
  },
  computed: {
    stateItem() {
      return VULNERABILITY_STATE_OBJECTS[this.state];
    },
    toggleText() {
      return this.stateItem?.buttonText;
    },
    dismissalReasonGroup() {
      return {
        text: s__('VulnerabilityManagement|Dismiss as...'),
        options: Object.entries(DISMISSAL_REASONS).map(([value, text]) => ({
          value,
          text,
          dropdownDescription: this.dismissalDescriptions?.[value],
          isDismissalReason: true,
        })),
      };
    },
    items() {
      return [STATES_GROUP, this.dismissalReasonGroup];
    },
    selected() {
      if (this.state === 'dismissed') {
        return this.dismissalReason;
      }

      return this.state;
    },
  },
  methods: {
    select(value) {
      const payload = Object.keys(DISMISSAL_REASONS).includes(value)
        ? {
            action: VULNERABILITY_STATE_OBJECTS.dismissed.action,
            dismissalReason: value.toUpperCase(),
          }
        : { action: VULNERABILITY_STATE_OBJECTS[value].action };

      this.$emit('change', payload);
    },
  },
};
</script>

<template>
  <gl-collapsible-listbox
    :items="items"
    :selected="selected"
    :toggle-text="toggleText"
    :disabled="disabled"
    placement="bottom-end"
    class="gl-leading-20"
    data-testid="vulnerability-status-dropdown"
    @select="select"
  >
    <template #list-item="{ item }">
      <span class="gl-flex gl-flex-col">
        <span class="gl-whitespace-nowrap gl-font-bold">{{ item.text }}</span>
        <span class="gl-text-gray-400" :class="{ 'gl-text-sm': item.isDismissalReason }">
          {{ item.dropdownDescription }}</span
        >
      </span>
    </template>
  </gl-collapsible-listbox>
</template>
