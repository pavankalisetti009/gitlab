<script>
import SafeHtml from '~/vue_shared/directives/safe_html';
import CodeBlock from '~/vue_shared/components/code_block.vue';

export default {
  name: 'VulnerabilityFileContentViewer',
  components: { CodeBlock },
  directives: {
    SafeHtml,
  },
  props: {
    startLine: { type: Number, required: false, default: null },
    endLine: { type: Number, required: false, default: null },
    isHighlighted: { type: Boolean, required: false, default: false },
    content: { type: String, required: true },
    highlightInfo: { type: Array, required: false, default: () => [] },
  },
  data() {
    return {
      loadingError: false,
    };
  },
  computed: {
    lineNumbers() {
      const linesNumbers = this.highlightInfo.map((highlight) => {
        return {
          lineNumber: highlight.startLine,
          stepNumber: highlight.stepNumber,
        };
      });
      return Array.from({ length: this.endLine - this.startLine + 1 }, (_, i) => {
        const currentLineNumber = this.startLine + i;
        return {
          lineNumber: currentLineNumber,
          // Combines the step numbers into a comma-separated string
          stepNumbers: linesNumbers
            .filter((line) => line.lineNumber === currentLineNumber)
            .map((step) => step.stepNumber),
        };
      });
    },
    sourceCodeLines() {
      const lines = this.content.split('\n');
      // content is the entire file, the GraphQL query does not have the ability to get only certain lines of the
      // file. Because we only need certain lines, we'll split the lines into an array, slice out only those lines, then
      // rejoin it back into a string so that the code block component can render it properly.
      return lines
        .slice(Math.max(this.startLine - 1, 0), Math.min(this.endLine, lines.length))
        .map((line) => line || ' ') // to display empty lines as well!
        .join('\n');
    },
    userColorScheme() {
      return gon.user_color_scheme;
    },
  },
  watch: {
    lineNumbers() {
      // When the user clicks `handleToggleFile` in `code_flow_file_viewer.vue` parent,
      // The `expanded` value changed, and the `lineNumbers` are recalculated and updated in the DOM.
      // We need to ensure that the highlighting of the selected step in the code flow viewer
      // remains intact for the user.
      this.$nextTick(() => {
        this.$emit('codeFlowFileLoaded');
      });
    },
  },
};
</script>

<template>
  <div class="file-holder">
    <div
      :class="userColorScheme"
      class="code blob-viewer file-content gl-flex gl-items-center gl-overflow-auto gl-rounded-base"
    >
      <div
        class="line-numbers line-links diff-line-num gl-border-r gl-z-0 !gl-p-0 hover:!gl-bg-transparent"
        data-testid="line-numbers"
      >
        <a
          v-for="line in lineNumbers"
          :id="`NUM-MARKER${line.stepNumbers}-L${line.lineNumber}`"
          :key="line.lineNumber"
          class="file-line-num unselected-inline-number-mark hover:gl-no-underline"
        >
          {{ line.lineNumber }}
        </a>
      </div>

      <code-block
        class="highlight gl-grow !gl-overflow-visible !gl-border-none !gl-p-0 !gl-leading-20"
      >
        <code v-if="isHighlighted" v-safe-html="sourceCodeLines" class="d-block"></code>
        <span v-else v-safe-html="sourceCodeLines" class="plain-lines"></span>
      </code-block>
    </div>
  </div>
</template>
