<script>
import { GlLink, GlCard, GlButton, GlIcon } from '@gitlab/ui';
import SectionLayout from '~/vue_shared/security_configuration/components/section_layout.vue';
import { s__, __ } from '~/locale';
import vulnerabilityArchivesQuery from '../graphql/vulnerability_archives.query.graphql';

export default {
  i18n: {
    downloadAll: __('Download all'),
    vulnerabilityArchives: s__('SecurityConfiguration|Vulnerability archives'),
    vulnerabilityArchivesDescription: s__(
      'SecurityConfiguration|Vulnerabilities are retained in the database for one year after the last update. After one year of inactivity, vulnerabilities are archived on the first of each month. Archives are removed after five years.',
    ),
    vulnerabilityArchivesDoc: s__(
      'SecurityConfiguration|Learn more about our vulnerability data retention policies',
    ),
  },
  components: {
    GlIcon,
    GlLink,
    GlCard,
    GlButton,
    SectionLayout,
  },
  inject: ['projectFullPath'],
  data() {
    return {
      expandedYear: 0,
      archive: [],
      vulnerabilityArchivesDocsPath: '',
    };
  },
  apollo: {
    archive: {
      query: vulnerabilityArchivesQuery,
      variables() {
        return {
          fullPath: this.projectFullPath,
        };
      },
      // We receive an array of objects: { archivedRecordsCount: <number>, year: <number>, month: <number> }
      // We map into an array of objects like: { year: <number>, sum: <number>, months: [{ month: <number>, count: <number>} ] }
      update(data) {
        const groupedByYear = data.project.vulnerabilityArchives.reduce((years, archive) => {
          const yearEntry = years[archive.year] || {
            year: archive.year,
            sum: 0,
            months: [],
          };

          yearEntry.months.push({
            month: archive.month - 1,
            count: archive.archivedRecordsCount,
          });

          yearEntry.sum += archive.archivedRecordsCount;
          return { ...years, [archive.year]: yearEntry };
        }, {});

        return Object.values(groupedByYear).sort((a, b) => b.year - a.year);
      },
    },
  },
  methods: {
    toggleYear(year) {
      this.expandedYear = this.expandedYear === year ? 0 : year;
    },
  },
};
</script>
<template>
  <section-layout :heading="$options.i18n.vulnerabilityArchives">
    <template #description>
      <p>
        {{ $options.i18n.vulnerabilityArchivesDescription }}
      </p>
      <p>
        <gl-link :href="vulnerabilityArchivesDocsPath">{{
          $options.i18n.vulnerabilityArchivesDoc
        }}</gl-link>
      </p>
    </template>
    <template #features>
      <ul class="gl-m-0 gl-list-none gl-p-0">
        <li v-for="item in archive" :key="item.year" class="gl-mb-6">
          <gl-card body-class="gl-flex">
            <div class="gl-flex gl-flex-1 gl-items-center">
              <gl-button class="gl-mr-4" category="tertiary" @click="toggleYear(item.year)">
                <gl-icon
                  name="chevron-right"
                  class="gl-transition-all"
                  :class="{ 'gl-rotate-90': expandedYear == item.year }"
                />
                <strong>{{ item.year }}</strong>
              </gl-button>
              <span class="gl-text-secondary">
                {{
                  n__(
                    'SecurityConfiguration|1 vulnerability',
                    'SecurityConfiguration|%d vulnerabilities',
                    item.sum,
                  )
                }}
              </span>
            </div>
            <gl-button>{{ $options.i18n.downloadAll }}</gl-button>
          </gl-card>
        </li>
      </ul>
    </template>
  </section-layout>
</template>
