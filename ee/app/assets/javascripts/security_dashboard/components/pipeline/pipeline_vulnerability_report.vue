<script>
import { GlAlert, GlSprintf, GlLink } from '@gitlab/ui';
import { s__ } from '~/locale';
import { createAlert } from '~/alert';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import { visitUrl } from '~/lib/utils/url_utility';
import { helpPagePath } from '~/helpers/help_page_helper';
import enabledScansQuery from 'ee/vue_merge_request_widget/queries/enabled_scans.query.graphql';
import VulnerabilityReport from '../shared/vulnerability_report/vulnerability_report.vue';
import { FILTER_PRESETS, FIELD_PRESETS } from '../shared/vulnerability_report/constants';
import VulnerabilityFindingModal from './vulnerability_finding_modal.vue';

export default {
  components: {
    VulnerabilityReport,
    VulnerabilityFindingModal,
    GlAlert,
    GlSprintf,
    GlLink,
  },
  mixins: [glFeatureFlagsMixin()],
  inject: ['pipeline', 'projectFullPath'],
  data() {
    return {
      selectedFinding: undefined,
      enabledScans: {
        full: {},
        partial: {},
      },
    };
  },
  computed: {
    partialScansEnabled() {
      return Object.keys(this.enabledScans.partial || {}).some(
        (key) => this.enabledScans.partial[key],
      );
    },
  },
  apollo: {
    enabledScans: {
      query: enabledScansQuery,
      variables() {
        return {
          fullPath: this.projectFullPath,
          pipelineIid: this.pipeline.iid,
        };
      },
      update({ project }) {
        const scans = project?.pipeline || {};

        const { __typename: _, ready: __, ...full } = scans.enabledSecurityScans || {};
        const { __typename, ready, ...partial } = scans.enabledPartialSecurityScans || {};

        return { full, partial };
      },
      error() {
        createAlert({
          message: s__('ciReport|Error while fetching enabled scans. Please try again later.'),
        });
      },
      skip() {
        return !this.glFeatures.vulnerabilityPartialScans;
      },
    },
  },

  methods: {
    // Two issues here for the pipeline GraphQL endpoint:
    // 1. Severity and reportType filters, unlike for vulnerabilities, need to be lower case.
    // 2. Empty array returns an empty result, so we need to pass undefined in that case.
    normalizeForGraphQLQuery(filter) {
      return filter?.length ? filter.map((s) => s.toLowerCase()) : undefined;
    },
    transformFilters(filters) {
      return {
        ...filters,
        reportType: this.normalizeForGraphQLQuery(filters.reportType),
        severity: this.normalizeForGraphQLQuery(filters.severity),
      };
    },
    showModal(finding) {
      this.selectedFinding = finding;
    },
    hideModal() {
      this.selectedFinding = undefined;
    },
    handleResolveWithAiSuccess(resultUrl) {
      visitUrl(resultUrl);
    },
  },
  fieldsToShow: FIELD_PRESETS.PIPELINE,
  filtersToShow: FILTER_PRESETS.PIPELINE,

  diffBasedScansLearnMorePath: helpPagePath('user/application_security/sast/gitlab_advanced_sast', {
    anchor: 'use-diff-based-scanning-to-improve-performance',
  }),

  i18n: {
    diffBasedScans: s__(
      'ciReport|Diff-based SAST scanning is turned on for this project. Diff-based scans only check the changed parts of the codebase, resulting in quicker results. This may not be a complete report of all vulnerabilities if the report includes only diff-based scans. %{linkStart}Learn more%{linkEnd}.',
    ),
  },
};
</script>

<template>
  <div>
    <gl-alert v-if="partialScansEnabled" variant="info" class="gl-mb-5" :dismissible="false">
      <gl-sprintf :message="$options.i18n.diffBasedScans">
        <template #link="{ content }">
          <gl-link :href="$options.diffBasedScansLearnMorePath">{{ content }}</gl-link>
        </template>
      </gl-sprintf>
    </gl-alert>

    <vulnerability-report
      :fields="$options.fieldsToShow"
      :filter-dropdowns="$options.filtersToShow"
      :filter-fn="transformFilters"
      @vulnerability-clicked="showModal"
    />

    <vulnerability-finding-modal
      v-if="selectedFinding"
      :finding-uuid="selectedFinding.id"
      :pipeline-iid="pipeline.iid"
      :branch-ref="pipeline.sourceBranch"
      :project-full-path="projectFullPath"
      @hidden="hideModal"
      @resolveWithAiSuccess="handleResolveWithAiSuccess"
    />
  </div>
</template>
