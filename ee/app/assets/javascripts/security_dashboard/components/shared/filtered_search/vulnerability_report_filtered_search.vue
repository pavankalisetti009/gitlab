<script>
import { GlFilteredSearch } from '@gitlab/ui';
import { OPERATOR_OR, OPERATOR_IS } from '~/vue_shared/components/filtered_search_bar/constants';
import glFeatureFlagMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import glAbilitiesMixin from '~/vue_shared/mixins/gl_abilities_mixin';
import { FILTERS } from '../vulnerability_report/constants';
import {
  STATUS_TOKEN_DEFINITION,
  ACTIVITY_TOKEN_DEFINITION,
  SEVERITY_TOKEN_DEFINITION,
  TOOL_VENDOR_TOKEN_DEFINITION,
  REPORT_TYPE_VENDOR_TOKEN_DEFINITION,
  IMAGE_TOKEN_DEFINITION,
  CLUSTER_TOKEN_DEFINITION,
  PROJECT_TOKEN_DEFINITION,
  IDENTIFIER_TOKEN_DEFINITION,
  SCANNER_TOKEN_DEFINITION,
  REACHABILITY_TOKEN_DEFINITION,
  VALIDITY_CHECK_TOKEN_DEFINITION,
} from './tokens/constants';
import StatusToken from './tokens/status_token.vue';
import ActivityToken from './tokens/activity_token.vue';
import eventHub from './event_hub';

export default {
  components: {
    GlFilteredSearch,
  },
  mixins: [glFeatureFlagMixin(), glAbilitiesMixin()],
  inject: {
    toolFilterType: {
      default: 'scanner', // scanner or reportType
    },
    reportType: {
      default: '',
    },
    projectFullPath: {
      default: '',
    },
    groupFullPath: {
      default: '',
    },
  },
  props: {
    availableFilters: {
      type: Array,
      required: true,
    },
  },
  data() {
    const value = [
      {
        type: 'state',
        value: {
          data: StatusToken.DEFAULT_VALUES,
          operator: OPERATOR_OR,
        },
      },
      {
        type: 'activity',
        value: {
          data: ActivityToken.DEFAULT_VALUES,
          operator: OPERATOR_OR,
        },
      },
    ];

    const nonDefaultTypes = ['severity', 'scanner', 'reportType', 'image', 'cluster', 'projectId'];

    if (this.availableFilters.includes(FILTERS.IDENTIFIER)) {
      nonDefaultTypes.push('identifier');
    }

    if (
      this.availableFilters.includes(FILTERS.REACHABILITY) &&
      this.glAbilities?.accessAdvancedVulnerabilityManagement
    ) {
      nonDefaultTypes.push('reachability');
    }

    if (
      this.availableFilters.includes(FILTERS.VALIDITY_CHECK) &&
      this.glAbilities?.accessAdvancedVulnerabilityManagement &&
      this.glFeatures?.validityCheckEsFilter
    ) {
      nonDefaultTypes.push('validityCheck');
    }

    // Populate initial filter values from query parameters for enabled token types
    nonDefaultTypes.forEach((type) => {
      if (this.$route.query[type]) {
        value.push({
          type,
          value: {
            data: this.$route.query[type].split(','),
            operator: ['identifier', 'reachability', 'validityCheck'].includes(type)
              ? OPERATOR_IS
              : OPERATOR_OR,
          },
        });
      }
    });

    return {
      value,
      filters: {},
    };
  },
  computed: {
    tokens() {
      return this.availableFilters.map(this.getTokenDefinition).filter((token) => token);
    },
  },
  created() {
    eventHub.$on('filters-changed', (args) => {
      this.filters = { ...this.filters, ...args };
      this.$emit('filters-changed', this.filters);
    });
  },
  methods: {
    clear() {
      this.filters = {};
      this.$emit('filters-changed', this.filters);
    },
    getTokenDefinition(type) {
      switch (type) {
        case FILTERS.STATUS:
          return STATUS_TOKEN_DEFINITION;
        case FILTERS.ACTIVITY:
          return ACTIVITY_TOKEN_DEFINITION;
        case FILTERS.SEVERITY:
          return SEVERITY_TOKEN_DEFINITION;
        case FILTERS.SCANNER:
          return SCANNER_TOKEN_DEFINITION;
        case FILTERS.REPORT_TYPE_SIMPLE:
        case FILTERS.REPORT_TYPE_VENDOR:
          return REPORT_TYPE_VENDOR_TOKEN_DEFINITION;
        case FILTERS.TOOL_SIMPLE:
        case FILTERS.TOOL_VENDOR:
          return {
            ...TOOL_VENDOR_TOKEN_DEFINITION,
            type: this.toolFilterType,
          };
        case FILTERS.IMAGE:
          return IMAGE_TOKEN_DEFINITION;
        case FILTERS.CLUSTER:
          return CLUSTER_TOKEN_DEFINITION;
        case FILTERS.PROJECT:
          return PROJECT_TOKEN_DEFINITION;
        case FILTERS.IDENTIFIER:
          if (this.projectFullPath || this.groupFullPath) {
            return IDENTIFIER_TOKEN_DEFINITION;
          }

          return undefined;
        case FILTERS.REACHABILITY:
          if (!this.glAbilities?.accessAdvancedVulnerabilityManagement) {
            return undefined;
          }

          if (this.projectFullPath || this.groupFullPath) {
            return REACHABILITY_TOKEN_DEFINITION;
          }

          return undefined;
        case FILTERS.VALIDITY_CHECK:
          if (
            !this.glFeatures?.validityCheckEsFilter ||
            !this.glAbilities?.accessAdvancedVulnerabilityManagement
          ) {
            return undefined;
          }
          if (this.projectFullPath || this.groupFullPath) {
            return VALIDITY_CHECK_TOKEN_DEFINITION;
          }
          return undefined;
        default:
          return undefined;
      }
    },
  },
};
</script>
<template>
  <gl-filtered-search
    :placeholder="s__('Vulnerability|Search or filter vulnerabilities...')"
    :available-tokens="tokens"
    :value="value"
    @clear="clear"
  />
</template>
