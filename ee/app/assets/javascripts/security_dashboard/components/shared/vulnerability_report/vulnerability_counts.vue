<script>
import { GlDashboardPanel } from '@gitlab/ui';
import { GlSingleStat } from '@gitlab/ui/src/charts';
import { SEVERITY_CLASS_NAME_MAP } from 'ee/vue_shared/security_reports/components/constants';
import {
  SEVERITY_LEVELS,
  DASHBOARD_TYPE_PROJECT,
  DASHBOARD_TYPE_GROUP,
  DASHBOARD_TYPE_INSTANCE,
} from 'ee/security_dashboard/constants';
import { ERROR_POLICY_NONE } from '~/lib/graphql';
import { createAlert } from '~/alert';
import { s__, sprintf } from '~/locale';
import countsQuery from 'ee/security_dashboard/graphql/queries/vulnerability_severities_count.query.graphql';
import { SEVERITIES, SEVERITY_COUNT_LIMIT } from 'ee/vulnerabilities/constants';

export default {
  components: { GlDashboardPanel, GlSingleStat },
  inject: {
    fullPath: {
      default: '',
    },
    dashboardType: {
      default: '',
    },
    vulnerabilitiesCountsQuery: {
      default: countsQuery,
    },
  },
  props: {
    filters: {
      type: Object,
      required: false,
      default: null,
    },
  },
  data() {
    return {
      counts: {},
      fetchError: false,
    };
  },
  apollo: {
    counts: {
      query() {
        return this.vulnerabilitiesCountsQuery;
      },
      errorPolicy: ERROR_POLICY_NONE,
      variables() {
        return {
          fullPath: this.fullPath,
          isProject: this.dashboardType === DASHBOARD_TYPE_PROJECT,
          isGroup: this.dashboardType === DASHBOARD_TYPE_GROUP,
          isInstance: this.dashboardType === DASHBOARD_TYPE_INSTANCE,
          capped: true,
          ...this.filters,
        };
      },
      update(data) {
        return data[this.dashboardType].vulnerabilitySeveritiesCount;
      },
      error() {
        this.fetchError = true;
        createAlert({
          message: s__(
            'SecurityReports|Error fetching the vulnerability counts. Please check your network connection and try again.',
          ),
        });
      },
      skip() {
        return !this.filters;
      },
    },
  },
  computed: {
    isLoadingCounts() {
      return !this.filters || this.$apollo.queries.counts.loading;
    },
    severityCounts() {
      return SEVERITIES.map((severity) => ({
        severity,
        count: this.counts[severity] || 0,
        title: SEVERITY_LEVELS[severity],
        icon: this.fetchError ? 'error' : `severity-${severity}`,
        borderColorClass: this.fetchError ? 'gl-border-t-red-500' : '',
        iconClass: this.fetchError
          ? 'gl-text-red-500'
          : `gl-mr-3 ${SEVERITY_CLASS_NAME_MAP[severity]}`,
      }));
    },
  },
  watch: {
    severityCounts() {
      this.$emit('counts-changed', this.severityCounts);
    },
  },
  methods: {
    formattedCounts(counts) {
      return counts > SEVERITY_COUNT_LIMIT
        ? sprintf(s__('SecurityReports|%{count}+'), { count: SEVERITY_COUNT_LIMIT })
        : counts;
    },
  },
};
</script>

<template>
  <div class="vulnerability-counts gl-display-flex gl-flex-wrap gl-gap-5">
    <gl-dashboard-panel
      v-for="{ severity, count, title, icon, iconClass, borderColorClass } in severityCounts"
      :key="severity"
      :data-testid="severity"
      :title="title"
      :title-icon="icon"
      :title-icon-class="iconClass"
      :loading="isLoadingCounts"
      :show-alert-state="fetchError"
      :border-color-class="borderColorClass"
    >
      <template #body>
        <div v-if="!fetchError">
          <gl-single-stat title="" :value="formattedCounts(count)" />
        </div>
        <p v-else>{{ __('Something went wrong. Please try again.') }}</p>
      </template>
    </gl-dashboard-panel>
  </div>
</template>
