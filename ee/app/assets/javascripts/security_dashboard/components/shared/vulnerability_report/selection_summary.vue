<script>
import { GlCollapse, GlAlert, GlCollapsibleListbox, GlSprintf, GlLink } from '@gitlab/ui';
import glFeatureFlagMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import { s__ } from '~/locale';
import { getIdFromGraphQLId } from '~/graphql_shared/utils';
import BulkChangeStatus from './bulk_change_status.vue';

export default {
  components: {
    GlCollapse,
    GlAlert,
    GlCollapsibleListbox,
    GlSprintf,
    GlLink,
    BulkChangeStatus,
  },
  mixins: [glFeatureFlagMixin()],
  props: {
    selectedVulnerabilities: {
      type: Array,
      required: true,
    },
    visible: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  data() {
    return {
      rejectedVulnerabilities: [],
      selectedAction: null,
    };
  },
  computed: {
    hasError() {
      return this.rejectedVulnerabilities.length > 0;
    },
    showActionDropdown() {
      return this.glFeatures.enhancedVulnerabilityBulkUpdates;
    },
    toggleText() {
      const action = this.$options.actions.find((item) => item.value === this.selectedAction);
      return action?.text || s__('SecurityReports|Select action');
    },
  },
  methods: {
    cancel() {
      this.$emit('cancel-selection');
      this.selectedAction = null;
      this.rejectedVulnerabilities = [];
    },
    handleRejected(vulnerabilities) {
      this.rejectedVulnerabilities.push(...vulnerabilities);
    },
  },
  i18n: {
    selected: s__('SecurityReports|%{count} Selected'),
    vulnerabilitiesUpdateFailed: s__(
      'SecurityReports|Failed updating vulnerabilities with the following IDs: %{ids}',
    ),
  },
  getIdFromGraphQLId,
  actions: [
    {
      text: s__('SecurityReports|Change status'),
      value: 'status',
    },
  ],
};
</script>

<template>
  <gl-collapse :visible="visible">
    <div>
      <gl-alert v-if="hasError" variant="danger" :dismissible="false">
        <gl-sprintf :message="$options.i18n.vulnerabilitiesUpdateFailed">
          <template #ids>
            <span v-for="({ id, vulnerabilityPath }, index) in rejectedVulnerabilities" :key="id">
              <template v-if="index > 0">,</template>
              <gl-link :href="vulnerabilityPath">{{ $options.getIdFromGraphQLId(id) }}</gl-link>
            </span>
          </template>
        </gl-sprintf>
      </gl-alert>

      <div
        class="gl-mt-5 gl-flex gl-flex-wrap gl-items-start gl-gap-3 gl-border-b-1 gl-border-b-default gl-bg-gray-10 gl-p-5 gl-border-b-solid"
      >
        <div class="gl-border-r gl-mr-3 gl-mt-3 gl-pr-5" data-testid="selected-vulnerabilities">
          <gl-sprintf :message="$options.i18n.selected">
            <template #count>
              <span class="gl-font-bold">{{ selectedVulnerabilities.length }}</span>
            </template>
          </gl-sprintf>
        </div>

        <gl-collapsible-listbox
          v-if="showActionDropdown"
          v-model="selectedAction"
          :items="$options.actions"
          :toggle-text="toggleText"
          data-testid="select-action-listbox"
        />

        <bulk-change-status
          v-if="!showActionDropdown || selectedAction === 'status'"
          :selected-vulnerabilities="selectedVulnerabilities"
          :rejected-vulnerabilities="rejectedVulnerabilities"
          @cancel="cancel"
          @vulnerabilities-updated="$emit('vulnerabilities-updated', $event)"
          @update-rejected="handleRejected"
          @clear-rejected="rejectedVulnerabilities = []"
        />
      </div>
    </div>
  </gl-collapse>
</template>
