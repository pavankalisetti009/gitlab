<script>
import { GlFilteredSearch } from '@gitlab/ui';
import { isEqual } from 'lodash';
import { OPERATOR_OR } from '~/vue_shared/components/filtered_search_bar/constants';
import { FILTERS } from '../vulnerability_report/constants';
import {
  STATUS_TOKEN_DEFINITION,
  ACTIVITY_TOKEN_DEFINITION,
  SEVERITY_TOKEN_DEFINITION,
  TOOL_VENDOR_TOKEN_DEFINITION,
  IMAGE_TOKEN_DEFINITION,
  CLUSTER_TOKEN_DEFINITION,
  PROJECT_TOKEN_DEFINITION,
} from './tokens/constants';
import eventHub from './event_hub';

const DEFINITIONS = {
  severity: SEVERITY_TOKEN_DEFINITION,
};

export default {
  components: {
    GlFilteredSearch,
  },
  inject: {
    toolFilterType: {
      default: 'scanner', // scanner or reportType
    },
  },
  props: {
    availableFilters: {
      type: Array,
      required: true,
    },
  },
  data() {
    const value = this.availableFilters
      .map((filter) => {
        const { type, token } = this.getTokenDefinition(filter) || {};

        if (!type || !token) {
          return undefined;
        }

        const data = this.getValueForType(type, token.DEFAULT_VALUES);

        if (!data) {
          return undefined;
        }

        return {
          type,
          value: {
            data,
            operator: OPERATOR_OR,
          },
        };
      })
      .filter((x) => x);

    return {
      value,
      filters: {},
    };
  },
  computed: {
    tokens() {
      return this.availableFilters.map(this.getTokenDefinition).filter((token) => token);
    },
  },
  watch: {
    filters(newFilters) {
      this.$emit('filters-changed', newFilters);
    },
  },
  created() {
    eventHub.$on('filters-changed', (args) => {
      this.filters = { ...this.filters, ...args };
      this.$emit('filters-changed', this.filters);
    });
  },
  methods: {
    clear() {
      this.filters = {};
    },
    getValueForType(type, defaultValues) {
      return this.$route.query[type] ? this.$route.query[type].split(',') : defaultValues;
    },
    getTokenDefinition(type) {
      switch (type) {
        case FILTERS.STATUS:
          return STATUS_TOKEN_DEFINITION;
        case FILTERS.ACTIVITY:
          return ACTIVITY_TOKEN_DEFINITION;
        case FILTERS.SEVERITY:
          return SEVERITY_TOKEN_DEFINITION;
        case FILTERS.TOOL_SIMPLE:
        case FILTERS.TOOL_VENDOR:
          return {
            ...TOOL_VENDOR_TOKEN_DEFINITION,
            type: this.toolFilterType,
          };
        case FILTERS.IMAGE:
          return IMAGE_TOKEN_DEFINITION;
        case FILTERS.CLUSTER:
          return CLUSTER_TOKEN_DEFINITION;
        case FILTERS.PROJECT:
          return PROJECT_TOKEN_DEFINITION;
        default:
          return undefined;
      }
    },
    handleInput(inputValues) {
      const knownTypes = ['severity'];
      const filterTokens = inputValues.filter((iv) => knownTypes.includes(iv.type));
      const newQuery = { ...this.$route.query, severity: undefined };
      const newFilters = { ...this.filters, severity: [] };

      filterTokens.forEach(({ type, value }) => {
        newQuery[type] = value?.data?.join?.(',');
        newFilters[type] = value.data;

        const filtersFn = DEFINITIONS[type]?.prepareFilters;

        if (typeof filtersFn === 'function') {
          newFilters[type] = filtersFn(value.data, this.filters[type]);
        }
      });

      if (!isEqual(newQuery, this.$route.query)) {
        this.$router.push({ query: newQuery });
      }

      this.filters = newFilters;
    },
  },
};
</script>
<template>
  <gl-filtered-search
    :placeholder="s__('Vulnerability|Search or filter vulnerabilities...')"
    :available-tokens="tokens"
    :value="value"
    @input="handleInput"
    @clear="clear"
  />
</template>
