import { sprintf, __, n__, s__ } from '~/locale';
import { toNounSeriesText } from '~/lib/utils/grammar';
import {
  capitalizeFirstCharacter,
  convertToCamelCase,
  splitCamelCase,
} from '~/lib/utils/text_utility';
import {
  SEVERITY_LEVELS,
  SEVERITY_LEVELS_KEYS,
  REPORT_TYPES_DEFAULT,
  REPORT_TYPES_DEFAULT_KEYS,
} from 'ee/security_dashboard/constants';
import {
  NO_LONGER_DETECTED_RULE_TYPE,
  DISMISS_REASONS,
  NOT_APPLICABLE,
  ACCEPTABLE_RISK,
} from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';

const humanizeScanners = (scanners = []) => {
  if (!scanners.length || scanners.length === REPORT_TYPES_DEFAULT_KEYS.length) {
    return s__('SecurityOrchestration|All scanners');
  }

  return toNounSeriesText(scanners.map((key) => REPORT_TYPES_DEFAULT[key]));
};

const humanizeSeverities = (severityLevels = []) => {
  if (!severityLevels.length || severityLevels.length === SEVERITY_LEVELS_KEYS.length) {
    return __('all');
  }

  return toNounSeriesText(severityLevels.map((key) => SEVERITY_LEVELS[key]));
};

/**
 * humanize criteria in reading format
 * @param criteria
 * @returns {(*)[]|*[]}
 */
export const humanizeCriteria = (criteria = []) => {
  if (!Array.isArray(criteria)) {
    return [s__('SecurityOrchestration|Criteria were not saved in correct format.')];
  }

  return criteria.map(({ type, value }) => {
    if (!type || !value) {
      return s__('SecurityOrchestration|Invalid criteria format');
    }

    return sprintf(s__('SecurityOrchestration|%{type}: %{boldStart}%{value}%{boldEnd}'), {
      type: capitalizeFirstCharacter(splitCamelCase(convertToCamelCase(type))),
      value,
    });
  });
};

export const humanizeDismissalReason = (reason = '') => {
  if (!reason || reason === NOT_APPLICABLE) return '';

  return DISMISS_REASONS[reason] || ACCEPTABLE_RISK;
};

const humanizeNotDetectedRule = (rule) => {
  const scanners = humanizeScanners(rule.scanners);
  const severities = humanizeSeverities(rule.severity_levels);

  return sprintf(
    n__(
      'SecurityOrchestration|%{scanners} of %{severities} severity level',
      'SecurityOrchestration|%{scanners} of %{severities} severity levels',
      rule.severity_levels?.length || 0,
    ),
    { scanners, severities },
  );
};

const humanizeDetectedRule = (rule, index = 1) => {
  const criteria = rule?.criteria || [];

  return {
    header: sprintf(s__('SecurityOrchestration|Rule %{number}'), { number: index + 1 }),
    list: humanizeCriteria(criteria),
  };
};

export const humanizeRule = (rule, index = 1) => {
  const type = rule?.type || NO_LONGER_DETECTED_RULE_TYPE;

  return type === NO_LONGER_DETECTED_RULE_TYPE
    ? humanizeNotDetectedRule(rule)
    : humanizeDetectedRule(rule, index);
};

/**
 * Convert yaml rules to humanly readable text
 * @param rules
 * @returns {String[]}
 */
export const humanizeRules = (rules = []) => rules.map((rule, i) => humanizeRule(rule, i));
