<script>
import { GlSprintf } from '@gitlab/ui';
import { s__, sprintf } from '~/locale';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import {
  humanizeRules,
  humanizeDismissalReason,
} from 'ee/security_orchestration/components/policy_drawer/vulnerability_management/utils';
import { SUMMARY_TITLE } from 'ee/security_orchestration/components/policy_drawer/constants';
import { NO_LONGER_DETECTED_RULE_TYPE } from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';
import {
  POLICY_TYPE_COMPONENT_OPTIONS,
  VULNERABILITY_MANAGEMENT_POLICY_TYPE_HEADER,
} from 'ee/security_orchestration/components/constants';
import { fromYaml } from 'ee/security_orchestration/components/utils';
import DrawerLayout from '../drawer_layout.vue';
import InfoRow from '../info_row.vue';

export default {
  i18n: {
    vulnerabilityManagementType: VULNERABILITY_MANAGEMENT_POLICY_TYPE_HEADER,
    summary: SUMMARY_TITLE,
    vulnerabilityManagementActionHeader: s__(
      'SecurityOrchestration|Resolve the following vulnerabilities that are no longer detected on the default branch:',
    ),
    vulnerabilityManagementAutoDismissHeader: s__(
      'SecurityOrchestration|Automatically dismiss vulnerabilities when they match all of the following criteria:',
    ),
    vulnerabilityManagementAutoDismissWithReasonHeader: s__(
      'SecurityOrchestration|Automatically dismiss vulnerabilities with a risk level of %{risk} when they match all of the following criteria:',
    ),
  },
  components: {
    InfoRow,
    DrawerLayout,
    GlSprintf,
  },
  mixins: [glFeatureFlagsMixin()],
  props: {
    policy: {
      type: Object,
      required: true,
    },
  },
  computed: {
    dismissalReason() {
      return humanizeDismissalReason(
        this.parsedYaml?.actions[0]?.dismissal_reason || '',
      ).toLowerCase();
    },
    hasAutoDismissVulnerabilityPolicies() {
      return this.glFeatures.autoDismissVulnerabilityPolicies;
    },
    policyScope() {
      return this.policy?.policyScope;
    },
    parsedYaml() {
      return fromYaml({
        manifest: this.policy.yaml,
        type: POLICY_TYPE_COMPONENT_OPTIONS.vulnerabilityManagement.urlParameter,
      });
    },
    description() {
      return this.parsedYaml?.description || '';
    },
    hasDetectedRules() {
      return this.groupedRules.detected.length > 0 && this.hasAutoDismissVulnerabilityPolicies;
    },
    header() {
      if (this.hasDetectedRules) {
        return this.dismissalReason
          ? sprintf(this.$options.i18n.vulnerabilityManagementAutoDismissWithReasonHeader, {
              risk: this.dismissalReason,
            })
          : this.$options.i18n.vulnerabilityManagementAutoDismissHeader;
      }

      return this.$options.i18n.vulnerabilityManagementActionHeader;
    },
    humanizedNoLongerDetectedRules() {
      return humanizeRules(this.groupedRules.notDetected);
    },
    humanizedDetectedRules() {
      return humanizeRules(this.groupedRules.detected);
    },
    groupedRules() {
      return (this.parsedYaml?.rules || []).reduce(
        (acc, rule) => {
          if (rule.type === NO_LONGER_DETECTED_RULE_TYPE) {
            acc.notDetected.push(rule);
          } else {
            acc.detected.push(rule);
          }

          return acc;
        },
        { notDetected: [], detected: [] },
      );
    },
  },
};
</script>

<template>
  <drawer-layout
    key="vulnerability_management_policy"
    :description="description"
    :policy="policy"
    :policy-scope="policyScope"
    :type="$options.i18n.vulnerabilityManagementType"
  >
    <template v-if="parsedYaml" #summary>
      <info-row data-testid="policy-summary" :label="$options.i18n.summary">
        <div data-testid="summary-header">
          {{ header }}
        </div>
        <div v-if="hasDetectedRules">
          <div
            v-for="(rule, i) in humanizedDetectedRules"
            :key="i"
            class="gl-mt-3"
            data-testid="summary-field"
          >
            <p class="gl-font-bold">{{ rule.header }}</p>
            <ul>
              <li v-for="(criteria, index) in rule.list" :key="index" data-testid="criteria-field">
                <gl-sprintf :message="criteria">
                  <template #bold="{ content }">
                    <code>{{ content }}</code>
                  </template>
                </gl-sprintf>
              </li>
            </ul>
          </div>
        </div>

        <ul v-else>
          <li
            v-for="rule in humanizedNoLongerDetectedRules"
            :key="rule"
            class="gl-mt-3"
            data-testid="summary-field"
          >
            {{ rule }}
          </li>
        </ul>
      </info-row>
    </template>
  </drawer-layout>
</template>
