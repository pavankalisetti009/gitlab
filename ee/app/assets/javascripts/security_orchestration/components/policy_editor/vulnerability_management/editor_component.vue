<script>
import { GlButton } from '@gitlab/ui';
import {
  RULES_LABEL,
  ADD_RULE_LABEL,
  ACTIONS_LABEL,
  EDITOR_MODE_RULE,
  EDITOR_MODE_YAML,
  PARSING_ERROR_MESSAGE,
  SECURITY_POLICY_ACTIONS,
} from '../constants';
import EditorLayout from '../editor_layout.vue';
import DimDisableContainer from '../dim_disable_container.vue';
import { DEFAULT_VULNERABILITY_MANAGEMENT_POLICY } from './constants';
import { createPolicyObject, policyToYaml, buildDefaultNoLongerDetectedRule } from './utils';
import RuleSection from './rule/rule_section.vue';
import ActionSection from './action/action_section.vue';

export default {
  SECURITY_POLICY_ACTIONS,
  EDITOR_MODE_RULE,
  EDITOR_MODE_YAML,
  i18n: {
    RULES_LABEL,
    ADD_RULE_LABEL,
    ACTIONS_LABEL,
  },
  components: {
    GlButton,
    EditorLayout,
    RuleSection,
    ActionSection,
    DimDisableContainer,
  },
  inject: ['namespacePath'],
  props: {
    assignedPolicyProject: {
      type: Object,
      required: true,
    },
    existingPolicy: {
      type: Object,
      required: false,
      default: null,
    },
    isCreating: {
      type: Boolean,
      required: true,
    },
    isDeleting: {
      type: Boolean,
      required: true,
    },
    isEditing: {
      type: Boolean,
      required: true,
    },
  },
  data() {
    let yamlEditorValue;

    if (this.existingPolicy) {
      yamlEditorValue = policyToYaml(this.existingPolicy);
    } else {
      yamlEditorValue = DEFAULT_VULNERABILITY_MANAGEMENT_POLICY;
    }

    const { policy, hasParsingError } = createPolicyObject(yamlEditorValue);
    const parsingError = hasParsingError ? PARSING_ERROR_MESSAGE : '';

    return {
      mode: EDITOR_MODE_RULE,
      policy,
      yamlEditorValue,
      hasParsingError,
      parsingError,
    };
  },
  computed: {
    policyActionName() {
      return this.isEditing
        ? this.$options.SECURITY_POLICY_ACTIONS.REPLACE
        : this.$options.SECURITY_POLICY_ACTIONS.APPEND;
    },
  },
  methods: {
    changeEditorMode(mode) {
      this.mode = mode;
    },
    async handleModifyPolicy(act) {
      // Assumes feature flag securityPoliciesProjectBackgroundWorker is enabled
      this.$emit('save', {
        action: act || this.policyActionName,
        policy: this.yamlEditorValue,
      });
    },
    handleUpdateProperty(property, value) {
      this.policy[property] = value;
      this.updateYamlEditorValue(this.policy);
    },
    handleUpdateYaml(manifest) {
      const { policy, hasParsingError } = createPolicyObject(manifest);

      this.yamlEditorValue = manifest;
      this.hasParsingError = hasParsingError;
      this.parsingError = hasParsingError ? PARSING_ERROR_MESSAGE : '';
      this.policy = policy;
    },
    updateYamlEditorValue(policy) {
      this.yamlEditorValue = policyToYaml(policy);
    },
    addRule() {
      this.policy.rules.push(buildDefaultNoLongerDetectedRule());
      this.updateYamlEditorValue(this.policy);
    },
    updateRule(index, values) {
      this.policy.rules.splice(index, 1, values);
      this.updateYamlEditorValue(this.policy);
    },
    removeRule(index) {
      this.policy.rules.splice(index, 1);
      this.updateYamlEditorValue(this.policy);
    },
  },
};
</script>
<template>
  <editor-layout
    :policy="policy"
    :yaml-editor-value="yamlEditorValue"
    :is-editing="isEditing"
    :is-removing-policy="isDeleting"
    :is-updating-policy="isCreating"
    :has-parsing-error="hasParsingError"
    :parsing-error="parsingError"
    @remove-policy="handleModifyPolicy($options.SECURITY_POLICY_ACTIONS.REMOVE)"
    @save-policy="handleModifyPolicy()"
    @update-editor-mode="changeEditorMode"
    @update-property="handleUpdateProperty"
    @update-yaml="handleUpdateYaml"
  >
    <template #rules>
      <dim-disable-container :disabled="hasParsingError">
        <template #title>
          <h4>
            {{ $options.i18n.RULES_LABEL }}
          </h4>
        </template>

        <template #disabled>
          <div class="gl-rounded-base gl-bg-gray-10 gl-p-6"></div>
        </template>

        <rule-section
          v-for="(rule, index) in policy.rules"
          :key="rule.id"
          :rule="rule"
          :index="index"
          @changed="updateRule(index, $event)"
          @remove="removeRule(index)"
        />

        <div class="security-policies-bg-gray-10 gl-mb-5 gl-rounded-base gl-p-5">
          <gl-button variant="link" data-testid="add-rule" @click="addRule">
            {{ $options.i18n.ADD_RULE_LABEL }}
          </gl-button>
        </div>
      </dim-disable-container>
    </template>
    <template #actions>
      <dim-disable-container :disabled="hasParsingError">
        <template #title>
          <h4>{{ $options.i18n.ACTIONS_LABEL }}</h4>
        </template>

        <template #disabled>
          <div class="gl-rounded-base gl-bg-gray-10 gl-p-6"></div>
        </template>

        <action-section :actions="policy.actions" />
      </dim-disable-container>
    </template>
  </editor-layout>
</template>
