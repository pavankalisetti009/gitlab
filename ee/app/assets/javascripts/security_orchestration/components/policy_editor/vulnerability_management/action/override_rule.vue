<script>
import { GlCollapsibleListbox, GlSprintf } from '@gitlab/ui';
import { capitalize } from 'lodash';
import { s__ } from '~/locale';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';
import { SEVERITIES } from 'ee/vulnerabilities/constants';
import { OVERRIDE_RULE_TYPE_OPTIONS_FORMAT, SET_TO } from '../constants';

const SEVERITY_LEVELS_OPTIONS = SEVERITIES.map((severity) => ({
  value: severity,
  text: capitalize(severity),
}));

export default {
  OVERRIDE_RULE_TYPE_OPTIONS_FORMAT,
  SEVERITY_LEVELS_OPTIONS,
  i18n: {
    customizePlaceholder: s__('SecurityOrchestration|Select customize type'),
    severityPlaceholder: s__('SecurityOrchestration|Select severity level'),
    overrideSeverityText: s__(
      'SecurityOrchestration|Then automatically %{boldStart}override severity%{boldEnd} these vulnerabilities to:',
    ),
  },
  name: 'OverrideRule',
  components: {
    GlCollapsibleListbox,
    GlSprintf,
    SectionLayout,
  },
  props: {
    action: {
      type: Object,
      required: true,
    },
  },
  emits: ['select'],
  computed: {
    customize() {
      return this.action?.customize || '';
    },
    severity() {
      return this.action?.severity || '';
    },
    showSeverityDropdown() {
      return this.customize === SET_TO;
    },
    customizeText() {
      const selected = this.$options.OVERRIDE_RULE_TYPE_OPTIONS_FORMAT.find(
        (option) => option.value === this.customize,
      );
      return selected?.text || this.$options.i18n.customizePlaceholder;
    },
    severityText() {
      const selected = this.$options.SEVERITY_LEVELS_OPTIONS.find(
        (option) => option.value === this.severity,
      );
      return selected?.text || this.$options.i18n.severityPlaceholder;
    },
  },
  methods: {
    updateCustomize(type) {
      const updatedAction = { ...this.action, customize: type };
      if (type !== 'set_to') {
        delete updatedAction.severity;
      }
      this.$emit('select', updatedAction);
    },
    updateSeverity(severity) {
      this.$emit('select', { ...this.action, severity });
    },
  },
};
</script>

<template>
  <section-layout :show-remove-button="false" content-classes="!gl-block">
    <template #content>
      <div class="gl-flex gl-flex-wrap gl-items-center gl-gap-3">
        <gl-sprintf :message="$options.i18n.overrideSeverityText">
          <template #bold="{ content }">
            <strong>{{ content }}</strong>
          </template>
        </gl-sprintf>
        <gl-collapsible-listbox
          data-testid="override-type"
          :selected="customize"
          :toggle-text="customizeText"
          :items="$options.OVERRIDE_RULE_TYPE_OPTIONS_FORMAT"
          @select="updateCustomize"
        />
        <gl-collapsible-listbox
          v-if="showSeverityDropdown"
          data-testid="severity-type"
          :selected="severity"
          :toggle-text="severityText"
          :items="$options.SEVERITY_LEVELS_OPTIONS"
          @select="updateSeverity"
        />
      </div>
    </template>
  </section-layout>
</template>
