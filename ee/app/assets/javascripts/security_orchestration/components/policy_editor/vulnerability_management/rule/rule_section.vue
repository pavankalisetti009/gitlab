<script>
import glFeatureFlagMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import { VULNERABILITY_DETECTED_TYPE } from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';
import { RULE_OR_LABEL } from '../../constants';
import NoLongerDetectedRule from './no_longer_detected_rule.vue';
import VulnerabilityFoundRule from './vulnerability_found_rule.vue';

export default {
  RULE_OR_LABEL,
  components: {
    NoLongerDetectedRule,
    VulnerabilityFoundRule,
  },
  mixins: [glFeatureFlagMixin()],
  props: {
    rule: {
      type: Object,
      required: true,
    },
    index: {
      type: Number,
      required: true,
    },
  },
  computed: {
    hasAutoDismissVulnerabilityPolicies() {
      return this.glFeatures.autoDismissVulnerabilityPolicies;
    },
    isFirstRule() {
      return this.index === 0;
    },
    isVulnerabilityFoundRule() {
      return (
        this.rule?.type === VULNERABILITY_DETECTED_TYPE && this.hasAutoDismissVulnerabilityPolicies
      );
    },
  },
  methods: {
    updateRule(rule) {
      this.$emit('changed', rule);
    },
  },
};
</script>

<template>
  <div>
    <div v-if="!isFirstRule" class="gl-mb-4 gl-ml-5 gl-text-subtle" data-testid="rule-separator">
      {{ $options.RULE_OR_LABEL }}
    </div>
    <vulnerability-found-rule
      v-if="isVulnerabilityFoundRule"
      :is-first-rule="isFirstRule"
      :rule="rule"
      @changed="updateRule"
    />
    <no-longer-detected-rule
      v-else
      :is-first-rule="isFirstRule"
      :rule="rule"
      @changed="updateRule"
    />
  </div>
</template>
