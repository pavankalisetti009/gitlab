<script>
import { debounce } from 'lodash';
import { GlCollapsibleListbox, GlFormInput } from '@gitlab/ui';
import { s__ } from '~/locale';
import { CRITERIA_TYPES } from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';
import { DEFAULT_DEBOUNCE_AND_THROTTLE_MS } from '~/lib/utils/constants';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';

export default {
  i18n: {
    placeholder: s__('SecurityOrchestration|Select criteria'),
  },
  name: 'VulnerabilityFoundCriteria',
  components: {
    GlCollapsibleListbox,
    GlFormInput,
    SectionLayout,
  },
  props: {
    criteria: {
      type: Object,
      required: false,
      default: () => ({}),
    },
    showRemoveButton: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  computed: {
    items() {
      return Object.entries(CRITERIA_TYPES).map(([value, text]) => ({
        value,
        text,
      }));
    },
    type() {
      return this.criteria?.type || '';
    },
    value() {
      return this.criteria?.value || '';
    },
    toggleText() {
      return CRITERIA_TYPES[this.type] || this.$options.i18n.placeholder;
    },
  },
  created() {
    this.debouncedUpdateValue = debounce(this.updateValue, DEFAULT_DEBOUNCE_AND_THROTTLE_MS);
  },
  destroyed() {
    this.debouncedUpdateValue.cancel();
  },
  methods: {
    selectType(type) {
      this.$emit('select-type', { ...this.criteria, type });
    },
    updateValue(value) {
      this.$emit('update-value', { ...this.criteria, value });
    },
  },
};
</script>

<template>
  <section-layout
    class="gl-py-2 gl-pl-0"
    :show-remove-button="showRemoveButton"
    @remove="$emit('remove')"
  >
    <template #content>
      <div class="gl-flex gl-w-full gl-gap-3">
        <gl-collapsible-listbox
          block
          class="gl-min-w-20"
          :items="items"
          :selected="type"
          :toggle-text="toggleText"
          @select="selectType"
        />

        <gl-form-input
          class="gl-flex-1"
          :class="{ '!gl-mr-8': !showRemoveButton }"
          :value="value"
          @input="debouncedUpdateValue"
        />
      </div>
    </template>
  </section-layout>
</template>
