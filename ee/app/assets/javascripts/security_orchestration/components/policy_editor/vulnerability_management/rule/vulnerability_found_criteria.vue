<script>
import { debounce } from 'lodash';
import { GlBadge, GlCollapsibleListbox, GlFormInput, GlTooltipDirective } from '@gitlab/ui';
import { s__, __ } from '~/locale';
import { CRITERIA_TYPES } from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';
import { DEFAULT_DEBOUNCE_AND_THROTTLE_MS } from '~/lib/utils/constants';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';

export default {
  i18n: {
    disabledLabel: __('disabled'),
    disabledTitle: s__('SecurityOrchestration|You can select this option only once.'),
    placeholder: s__('SecurityOrchestration|Select criteria'),
  },
  name: 'VulnerabilityFoundCriteria',
  directives: {
    GlTooltip: GlTooltipDirective,
  },
  components: {
    GlBadge,
    GlCollapsibleListbox,
    GlFormInput,
    SectionLayout,
  },
  props: {
    criteria: {
      type: Object,
      required: false,
      default: () => ({}),
    },
    showRemoveButton: {
      type: Boolean,
      required: false,
      default: false,
    },
    disabled: {
      type: Boolean,
      required: false,
      default: false,
    },
    disabledTypes: {
      type: Array,
      required: false,
      default: () => [],
    },
  },
  computed: {
    items() {
      return Object.entries(CRITERIA_TYPES).map(([value, text]) => ({
        value,
        text,
        disabled: this.isTypeDisabled(value),
      }));
    },
    type() {
      return this.criteria?.type || '';
    },
    value() {
      return this.criteria?.value || '';
    },
    toggleText() {
      return CRITERIA_TYPES[this.type] || this.$options.i18n.placeholder;
    },
  },
  created() {
    this.debouncedUpdateValue = debounce(this.updateValue, DEFAULT_DEBOUNCE_AND_THROTTLE_MS);
  },
  destroyed() {
    this.debouncedUpdateValue.cancel();
  },
  methods: {
    isTypeDisabled(type) {
      return this.disabledTypes.includes(type);
    },
    selectType(type) {
      if (this.isTypeDisabled(type)) {
        return;
      }

      this.$emit('select-type', { ...this.criteria, type });
    },
    updateValue(value) {
      this.$emit('update-value', { ...this.criteria, value });
    },
  },
};
</script>

<template>
  <section-layout
    class="gl-py-2 gl-pl-0"
    :show-remove-button="showRemoveButton"
    @remove="$emit('remove')"
  >
    <template #content>
      <div class="gl-flex gl-w-full gl-gap-3">
        <gl-collapsible-listbox
          block
          class="gl-min-w-20"
          :disabled="disabled"
          :items="items"
          :selected="type"
          :toggle-text="toggleText"
          @select="selectType"
        >
          <template #list-item="{ item }">
            <span
              class="gl-flex"
              data-testid="list-item-content"
              :class="{ '!gl-cursor-default': item.disabled }"
            >
              <span
                :id="item.value"
                data-testid="list-item-text"
                class="gl-pr-3"
                :class="{ 'gl-text-subtle': item.disabled }"
              >
                {{ item.text }}
              </span>
              <gl-badge
                v-if="item.disabled"
                v-gl-tooltip.right.viewport
                :title="$options.i18n.disabledTitle"
                class="gl-ml-auto"
                variant="neutral"
              >
                {{ $options.i18n.disabledLabel }}
              </gl-badge>
            </span>
          </template>
        </gl-collapsible-listbox>

        <gl-form-input
          class="gl-flex-1"
          :class="{ '!gl-mr-8': !showRemoveButton }"
          :value="value"
          @input="debouncedUpdateValue"
        />
      </div>
    </template>
  </section-layout>
</template>
