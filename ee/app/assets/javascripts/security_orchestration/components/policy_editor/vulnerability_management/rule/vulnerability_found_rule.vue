<script>
import { GlButton, GlSprintf, GlTooltipDirective } from '@gitlab/ui';
import { s__ } from '~/locale';
import { RULE_HUMANIZED_TEMPLATE_VULNERABILITY_FOUND } from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';
import { buildDefaultVulnerabilityFoundCriteria } from '../utils';
import VulnerabilityFoundCriteria from './vulnerability_found_criteria.vue';

export default {
  MAX_CRITERIA_COUNT: 3,
  RULE_HUMANIZED_TEMPLATE_VULNERABILITY_FOUND,
  i18n: {
    addCriteriaButtonText: s__('SecurityOrchestration|Add new criteria'),
    placeholder: s__('SecurityOrchestration|Select criteria'),
    exceedingCriteriaMessage: s__('SecurityOrchestration|You can add a maximum of 3 criteria.'),
  },
  name: 'VulnerabilityFoundRule',
  directives: { GlTooltip: GlTooltipDirective },
  components: {
    GlButton,
    GlSprintf,
    SectionLayout,
    VulnerabilityFoundCriteria,
  },
  props: {
    rule: {
      type: Object,
      required: true,
    },
    isFirstRule: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  computed: {
    criteria() {
      const payload = this.rule.criteria || [buildDefaultVulnerabilityFoundCriteria()];
      return payload.slice(0, this.$options.MAX_CRITERIA_COUNT);
    },
    canAddCriteria() {
      return this.criteria.length < this.$options.MAX_CRITERIA_COUNT;
    },
  },
  methods: {
    showCriteriaRemoveButton(index) {
      return index > 0;
    },
    addCriteria() {
      this.emitChange({ criteria: [...this.criteria, buildDefaultVulnerabilityFoundCriteria()] });
    },

    updateCriteria(criteria, index) {
      this.criteria.splice(index, 1, criteria);
      this.emitChange({ criteria: this.criteria });
    },
    removeCriteria(index) {
      this.criteria.splice(index, 1);
      this.emitChange({ criteria: this.criteria });
    },
    emitChange(criteria) {
      this.$emit('changed', { ...this.rule, ...criteria });
    },
  },
};
</script>

<template>
  <div class="security-policies-bg-subtle gl-mb-4 gl-rounded-base">
    <section-layout :show-remove-button="!isFirstRule" @remove="$emit('remove')">
      <template #content>
        <div class="gl-flex gl-w-full gl-flex-col">
          <div class="gl-mb-3">
            <gl-sprintf :message="$options.RULE_HUMANIZED_TEMPLATE_VULNERABILITY_FOUND" />
          </div>

          <vulnerability-found-criteria
            v-for="(item, i) in criteria"
            :key="i"
            :criteria="item"
            :show-remove-button="showCriteriaRemoveButton(i)"
            @remove="removeCriteria(i)"
            @select-type="updateCriteria($event, i)"
            @update-value="updateCriteria($event, i)"
          />
        </div>

        <div
          v-gl-tooltip="{
            disabled: canAddCriteria,
            title: $options.i18n.exceedingCriteriaMessage,
          }"
          data-testid="add-criteria-wrapper"
        >
          <gl-button
            variant="link"
            data-testid="add-criteria"
            :disabled="!canAddCriteria"
            @click="addCriteria"
          >
            {{ $options.i18n.addCriteriaButtonText }}
          </gl-button>
        </div>
      </template>
    </section-layout>
  </div>
</template>
