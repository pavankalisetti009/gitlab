# frozen_string_literal: true

module VulnerabilityMergeRequestLinks
  class CreateService < ::BaseProjectService
    def execute
      raise Gitlab::Access::AccessDeniedError unless can?(@current_user, :admin_vulnerability_merge_request_link,
        merge_request_link)

      return max_vulnerabilities_error if merge_request_links_limit_exceeded?

      if merge_request_link.save
        Vulnerabilities::Reads::UpsertService.new(vulnerability, { has_merge_request: true },
          projects: @project).execute
        success_response
      else
        error_response
      end
    end

    private

    def vulnerability
      @vulnerability ||= params[:vulnerability]
    end

    def merge_request_link
      @merge_request_link ||= Vulnerabilities::MergeRequestLink.new(
        vulnerability: vulnerability,
        merge_request: params[:merge_request]
      )
    end

    def merge_request_links_limit_exceeded?
      Vulnerabilities::MergeRequestLink.limit_exceeded_for_vulnerability?(params[:vulnerability])
    end

    def max_vulnerabilities_error
      message = format(
        _('Cannot link more than %{limit} merge requests to a vulnerability'),
        limit: Vulnerabilities::MergeRequestLink::MAX_MERGE_REQUEST_LINKS_PER_VULNERABILITY
      )

      ServiceResponse.error(message: message, payload: { errors: [message] })
    end

    def success_response
      ServiceResponse.success(payload: { merge_request_link: @merge_request_link })
    end

    def error_response
      full_messages = merge_request_link.errors.full_messages
      ServiceResponse.error(message: full_messages.to_sentence, payload: { errors: full_messages })
    end
  end
end
