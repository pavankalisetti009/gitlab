# frozen_string_literal: true

module VulnerabilityMergeRequestLinks
  class DestroyService < ::BaseProjectService
    def execute
      raise Gitlab::Access::AccessDeniedError unless can?(@current_user, :admin_vulnerability_merge_request_link,
        merge_request_link)

      vulnerability = merge_request_link.vulnerability

      ::Vulnerability.transaction do
        if merge_request_link.destroy
          Vulnerabilities::Reads::UpsertService.new(vulnerability,
            { has_merge_request: vulnerability.merge_request_links.exists? },
            projects: @project
          ).execute
          success_response
        else
          error_response
        end
      end
    end

    private

    def merge_request_link
      @merge_request_link ||= params[:merge_request_link]
    end

    def success_response
      ServiceResponse.success
    end

    def error_response
      full_messages = merge_request_link.errors.full_messages
      ServiceResponse.error(message: full_messages.to_sentence, payload: { errors: full_messages })
    end
  end
end
