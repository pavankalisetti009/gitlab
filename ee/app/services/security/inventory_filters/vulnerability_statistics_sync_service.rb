# frozen_string_literal: true

module Security
  module InventoryFilters
    class VulnerabilityStatisticsSyncService
      TooManyProjectsError = Class.new(StandardError)

      UPDATE_SQL = <<~SQL
        UPDATE security_inventory_filters
        SET
          total = COALESCE(vs.total, 0),
          critical = COALESCE(vs.critical, 0),
          high = COALESCE(vs.high, 0),
          medium = COALESCE(vs.medium, 0),
          low = COALESCE(vs.low, 0),
          unknown = COALESCE(vs.unknown, 0),
          info = COALESCE(vs.info, 0)
        FROM (
          SELECT
            project_ids.project_id,
            vs.total,
            vs.critical,
            vs.high,
            vs.medium,
            vs.low,
            vs.unknown,
            vs.info
          FROM unnest(ARRAY[%{project_ids}]) AS project_ids(project_id)
          LEFT JOIN vulnerability_statistics vs ON vs.project_id = project_ids.project_id
        ) vs
        WHERE security_inventory_filters.project_id = vs.project_id
      SQL

      MAX_PROJECTS = 1_000

      def self.execute(project_ids)
        new(project_ids || []).execute
      end

      def initialize(project_ids)
        if project_ids.size > MAX_PROJECTS
          raise TooManyProjectsError, "Cannot sync statistics for more than #{MAX_PROJECTS} projects"
        end

        @project_ids = project_ids
      end

      def execute
        return if project_ids.blank?

        connection.execute(update_sql)
      end

      private

      attr_reader :project_ids

      delegate :connection, to: InventoryFilter, private: true

      def update_sql
        format(
          UPDATE_SQL,
          project_ids: project_ids.join(', ')
        )
      end
    end
  end
end
