# frozen_string_literal: true

module Security
  module InventoryFilters
    class VulnerabilityStatisticsUpdateService
      UPSERT_SQL = <<~SQL
        INSERT INTO security_inventory_filters
          AS target (project_id, project_name, archived, traversal_ids, %{insert_attributes})
          %{values_sql}
        ON CONFLICT (project_id)
          DO UPDATE SET
            project_name = EXCLUDED.project_name,
            traversal_ids = EXCLUDED.traversal_ids,
            archived = EXCLUDED.archived,
            %{update_values}
      SQL

      # project_to_severity_counts_diffs is in this format:
      # {
      #   project1: {
      #     critical: <number>,
      #     high: <number>
      #     ...
      #   },
      #   project2: {
      #     critical: <number>,
      #     high: <number>
      #     ...
      #   },
      #   ...
      # }
      def self.execute(project_to_severity_counts)
        new(project_to_severity_counts).execute
      end

      def initialize(project_to_severity_counts)
        @project_to_severity_counts = project_to_severity_counts
      end

      def execute
        return unless project_to_severity_counts.present?

        connection.execute(upsert_sql)
      end

      private

      attr_reader :project_to_severity_counts

      delegate :connection, to: InventoryFilter, private: true
      delegate :quote_column_name, to: :connection, private: true

      def upsert_sql
        format(
          UPSERT_SQL,
          insert_attributes: insert_attributes,
          values_sql: values_sql,
          update_values: update_values
        )
      end

      def values_sql
        Arel::Nodes::ValuesList.new(insert_values).to_sql
      end

      def insert_attributes
        severity_levels.map { |key| quote_column_name(key) }.join(', ')
      end

      def insert_values
        project_to_severity_counts.map do |project, counts|
          safe_counts = fill_in_zeros(counts)

          [
            project.id,
            project.name,
            project.archived,
            "{#{project.namespace.traversal_ids_as_sql}}"
          ].concat(severity_levels.map { |sev| safe_counts[sev] })
        end
      end

      def update_values
        severity_levels.map do |severity|
          safe_severity = quote_column_name(severity)
          "#{safe_severity} = GREATEST(TARGET.#{safe_severity} + EXCLUDED.#{safe_severity}, 0)"
        end.join(', ')
      end

      def severity_levels
        @severity_levels ||= ::Enums::Vulnerability.severity_levels.keys.map(&:to_s).prepend("total")
      end

      def fill_in_zeros(counts)
        severity_levels.each do |key|
          counts[key] ||= 0
        end

        counts["total"] = counts.except("total").values.sum
        counts
      end
    end
  end
end
