# frozen_string_literal: true

module Security
  module Ingestion
    class CreateVulnerabilityRepresentationInformation < BaseService
      include Gitlab::Ingestion::BulkInsertableTask

      self.model = Vulnerabilities::RepresentationInformation
      self.unique_by = :vulnerability_id

      def self.execute(...)
        new(...).execute
      end

      def initialize(pipeline, resolved_vulnerabilities)
        @pipeline = pipeline
        @resolved_vulnerabilities = resolved_vulnerabilities
      end

      private

      attr_reader :pipeline, :resolved_vulnerabilities

      def attributes
        resolved_vulnerabilities.map do |vulnerability|
          {
            vulnerability_id: vulnerability.id,
            vulnerability_occurrence_id: vulnerability.finding_id,
            project_id: pipeline.project_id,
            resolved_in_commit_sha: pipeline.sha
          }
        end
      end
    end
  end
end
