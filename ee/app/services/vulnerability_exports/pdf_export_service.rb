# frozen_string_literal: true

require "gitlab/pdf"

# rubocop:disable Gitlab/BoundedContexts -- matching existing structure
module VulnerabilityExports
  # rubocop:enable Gitlab/BoundedContexts
  class PdfExportService
    def self.export(vulnerability_export)
      new(vulnerability_export).export
    end

    def initialize(vulnerability_export)
      self.vulnerability_export = vulnerability_export
    end

    def export
      vulnerability_export.start!
      generate_export_file
      vulnerability_export.finish!
    rescue StandardError
      vulnerability_export.failed!
      raise
    ensure
      vulnerability_export.schedule_export_deletion
    end

    private

    attr_accessor :vulnerability_export

    delegate :exportable, to: :vulnerability_export, private: true

    def generate_export_file
      vulnerability_export.file = prawn_doc.then { File.new(filename) }
    end

    def prawn_doc
      Prawn::Document.generate(filename) do |pdf|
        # Set up global document settings such as font color and
        # margins
        pdf.stroke_color 'ff0000'

        # force a blank new page to test header replication/page numbers
        pdf.start_new_page

        # draw header (doing this last for page numbering)
        pdf.repeat(:all, dynamic: true) do
          Gitlab::PDF::Header.render(pdf, page: pdf.page_number, height: 50)
        end
      end
    end

    def report_timestamp
      @report_timestamp ||= Time.current.utc.strftime('%FT%H%M')
    end

    def exportable_path
      @exportable_path ||= exportable.full_path.parameterize
    end

    def filename
      @filename ||= [exportable_path, '_vulnerabilities_', report_timestamp, '.pdf'].join
    end
  end
end
