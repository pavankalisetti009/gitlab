# frozen_string_literal: true

module Search
  module Elastic
    module Delete
      # Deletes vulnerability documents for a project with traversal_ids other than the specified one.
      # Used when removing documents with old routing_id during project transfers.
      class VulnerabilityService
        include Gitlab::Loggable

        INDEX_NAME = ::Search::Elastic::Types::Vulnerability.index_name
        QUERY_TIMEOUT = '10m'

        def self.execute(options)
          new(options).execute
        end

        def initialize(options)
          options = options.with_indifferent_access
          @project_id = options[:project_id]
          @traversal_id = options[:traversal_id]
        end

        def execute
          return unless project_id && traversal_id

          delete_vulnerability_documents
        end

        private

        attr_reader :project_id, :traversal_id

        def logger
          @logger ||= ::Gitlab::Elasticsearch::Logger.build
        end

        def client
          @client ||= ::Gitlab::Search::Client.new
        end

        def delete_vulnerability_documents
          query = build_query
          response = execute_delete_query(query)
          log_response(response)
        end

        def build_query
          {
            bool: {
              filter: [
                { term: { project_id: project_id } },
                { bool: { must_not: { prefix: { traversal_ids: { value: traversal_id } } } } }
              ]
            }
          }
        end

        def execute_delete_query(query)
          client.delete_by_query(
            index: INDEX_NAME,
            conflicts: 'proceed',
            timeout: QUERY_TIMEOUT,
            body: { query: query }
          )
        end

        def log_response(response)
          log_payload = build_structured_payload(
            project_id: project_id,
            traversal_id: traversal_id,
            index: INDEX_NAME
          )

          if response['failure'].present?
            log_payload[:failure] = response['failure']
            log_payload[:message] = "Failed to delete data for project transfer"
            logger.error(log_payload)
          else
            log_payload[:deleted] = response['deleted']
            log_payload[:message] = "Successfully deleted duplicate data for project transfer"
            logger.info(log_payload)
          end
        end
      end
    end
  end
end
