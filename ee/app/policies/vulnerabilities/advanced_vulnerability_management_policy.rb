# frozen_string_literal: true

module Vulnerabilities
  module AdvancedVulnerabilityManagementPolicy
    extend ActiveSupport::Concern

    included do
      condition(:can_access_vulnerability_es_features) do
        security_access_granted? &&
          advanced_vulnerability_management_allowed? &&
          advanced_vulnerability_management_enabled?
      end

      rule { can_access_vulnerability_es_features }.enable :access_advanced_vulnerability_management

      private

      def security_access_granted?
        can?(:read_security_resource)
      end

      def advanced_vulnerability_management_allowed?
        ::Search::Elastic::VulnerabilityIndexHelper
          .advanced_vulnerability_management_allowed?
      end

      def advanced_vulnerability_management_enabled?
        ::Feature.enabled?(:advanced_vulnerability_management, @subject) ||
          ::Feature.enabled?(:advanced_vulnerability_management, @user)
      end
    end
  end
end
