# frozen_string_literal: true

class VulnerabilityPolicy < BasePolicy
  delegate(:project) { @subject.project }

  # Only users who can read vulnerability can comment.
  # It would not be safe to prevent :create_note in project policy,
  # since note permissions are shared, and this can have ripple effect on other parts.
  rule { ~can?(:read_security_resource) }.prevent :create_note
  rule { can?(:read_security_resource) }.enable :read_vulnerability

  # Authorize access to Explain Vulnerability
  condition(:explain_vulnerability_with_ai_authorized) do
    next false unless @user

    ::Gitlab::Llm::Chain::Utils::ChatAuthorizer.resource(
      resource: subject,
      user: @user
    ).allowed?
  end

  # Authorize access to the Explain Vulnerability Cloud Connector Service
  condition(:explain_vulnerability_cloud_connector_authorized) do
    if ::Feature.enabled?(:dap_external_trigger_usage_billing, @user)
      ::Gitlab::Llm::FeatureAuthorizer.can_access_duo_external_trigger?(
        user: @user,
        container: @subject.project
      )
    else
      @user.allowed_to_use?(:explain_vulnerability)
    end
  end

  condition(:explain_vulnerability_allowed_for_user) do
    next false unless @user

    if ::Feature.enabled?(:dap_external_trigger_usage_billing, @user)
      ::Gitlab::Llm::FeatureAuthorizer.can_access_duo_external_trigger?(
        user: @user,
        container: @subject.project
      )
    else
      can?(:read_security_resource) &&
        ::Gitlab::Llm::Chain::Utils::ChatAuthorizer.resource(
          resource: subject,
          user: @user
        ).allowed? &&
        @user.allowed_to_use?(:explain_vulnerability)
    end
  end

  rule do
    explain_vulnerability_allowed_for_user &
      explain_vulnerability_cloud_connector_authorized
  end.enable(:explain_vulnerability_with_ai)

  rule { can?(:admin_vulnerability) }.enable :create_external_issue_link
  rule { project.security_dashboard_enabled & can?(:developer_access) }.enable :create_external_issue_link

  rule { can?(:read_vulnerability) }.policy do
    enable :read_vulnerability_representation_information
  end
end
