# frozen_string_literal: true

# Security::VulnerabilityElasticRiskScoresFinder
#
# Used to calculate total risk score of all active vulnerabilities
# in a project or a group.
#
# Arguments:
#   see in ee/app/finders/security/vulnerability_elastic_base_finder.rb

module Security
  class VulnerabilityElasticRiskScoresFinder < VulnerabilityElasticBaseFinder
    def initialize(vulnerable, params = {})
      super(vulnerable, params.merge({ state: Vulnerability.active_states }))
    end

    def execute
      options = search_params.merge({
        risk_score_sum: true,
        created_at_sum: true
      })

      query = ::Search::Elastic::VulnerabilityQueryBuilder.build(query: nil, options: options)
      Gitlab::Search::Client.execute_search(query: query, options: es_search_options) do |es_response|
        response = ::Search::Elastic::ResponseMapper.new(es_response)
        calculate_risk_score(response)
      end
    end

    private

    def calculate_risk_score(response)
      risk_scores_sum = response.aggregations.dig("risk_scores_sum", "value") || 0
      created_at_sum = response.aggregations.dig("created_at_sum", "value") || 0
      active_vulnerabilities_count = response.total_count || 0

      Vulnerabilities::AggregateRiskScore.score(
        risk_scores_sum: risk_scores_sum,
        created_at_sum: created_at_sum,
        active_vulnerabilities_count: active_vulnerabilities_count
      )
    end
  end
end
