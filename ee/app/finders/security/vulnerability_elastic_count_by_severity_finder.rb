# frozen_string_literal: true

# Security::VulnerabilityElasticCountBySeverityFinder
#
# Used to filter Vulnerability records for Vulnerabilities API from vulnerabilities elasticsearch index
#
# Arguments:
#   see in ee/app/finders/security/vulnerability_elastic_base_finder.rb

module Security
  class VulnerabilityElasticCountBySeverityFinder < VulnerabilityElasticBaseFinder
    def execute
      options = search_params.merge({ count_by_severity: true, calculate_age_stats: true })

      query = ::Search::Elastic::VulnerabilityQueryBuilder.build(query: nil, options: options)
      Gitlab::Search::Client.execute_search(query: query, options: es_search_options) do |es_response|
        aggregations = ::Search::Elastic::ResponseMapper.new(es_response).aggregations
        parsed_aggregations = Gitlab::Search::AggregationParser.call(aggregations).first

        severity_counts(parsed_aggregations, aggregations)
      end
    end

    private

    def severity_counts(parsed_aggregations, raw_aggregations)
      severities = {}
      severity_hash = ::Vulnerabilities::Read.severities.invert
      raw_buckets = raw_aggregations.dig('severity_counts', 'buckets') || []

      parsed_aggregations.buckets.each do |bucket|
        key = severity_hash[bucket[:key]]
        raw_bucket = raw_buckets.find { |b| b['key'] == bucket[:key] } || {}

        severities[key] = {
          'count' => bucket[:count],
          'avg_detected_at' => raw_bucket['avg_detected_at'],
          'median_detected_at' => raw_bucket['median_detected_at']
        }
      end

      severities
    end
  end
end
