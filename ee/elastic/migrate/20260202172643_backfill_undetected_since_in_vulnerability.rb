# frozen_string_literal: true

class BackfillUndetectedSinceInVulnerability < Elastic::Migration
  include ::Search::Elastic::MigrationDatabaseBackfillHelper

  skip_if -> { !backfill_vulnerability_detection_transition_completed? }

  batch_size 10_000
  batched!
  throttle_delay 15.seconds
  retry_on_failure

  DOCUMENT_TYPE = ::Vulnerabilities::Read

  def self.backfill_vulnerability_detection_transition_completed?
    migration = Gitlab::Database::SharedModel.using_connection(SecApplicationRecord.connection) do
      Gitlab::Database::BackgroundMigration::BatchedMigration
        .find_for_configuration(
          :gitlab_sec,
          'BackfillVulnerabilityDetectionTransitions',
          :vulnerability_occurrences,
          :id,
          []
        )
    end

    migration&.finished? || migration&.finalized?
  end

  # Vulnerabilities do not honour this setting.
  def respect_limited_indexing?
    false
  end

  def item_to_preload
    { project: :namespace }
  end
end
