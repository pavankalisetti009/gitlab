# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Security::InventoryFilters::VulnerabilityStatisticsSyncService, feature_category: :security_asset_inventories do
  describe '.execute' do
    let(:project_ids) { [1, 2, 3] }
    let(:mock_service_object) { instance_double(described_class, execute: true) }

    subject(:execute_sync) { described_class.execute(project_ids) }

    before do
      allow(described_class).to receive(:new).with(project_ids).and_return(mock_service_object)
    end

    it 'instantiates the service object with project_ids and calls execute' do
      execute_sync

      expect(mock_service_object).to have_received(:execute)
    end
  end

  describe '#execute' do
    let_it_be(:project1) { create(:project, name: "Project 1") }
    let_it_be(:project2) { create(:project, name: "Project 2") }
    let_it_be(:project3) { create(:project, name: "Project 3") }

    let(:project_ids) { [project1.id, project2.id] }

    subject(:sync_statistics) { described_class.execute(project_ids) }

    context 'when project_ids is empty' do
      let(:project_ids) { [] }

      it 'returns early without executing any queries' do
        expect(Security::InventoryFilter.connection).not_to receive(:execute)

        sync_statistics
      end
    end

    context 'when project_ids is nil' do
      let(:project_ids) { nil }

      it 'returns early without executing any queries' do
        expect(Security::InventoryFilter.connection).not_to receive(:execute)

        sync_statistics
      end
    end

    context 'when more than 1000 projects is provided' do
      let(:project_ids) { (1..1001).to_a }

      it 'raises error' do
        expect { sync_statistics }.to raise_error do |error|
          expect(error.class).to eql(described_class::TooManyProjectsError)
          expect(error.message).to eql('Cannot sync statistics for more than 1000 projects')
        end
      end
    end

    context 'when syncing statistics' do
      let!(:inventory_filter_1) { create(:security_inventory_filters, project_id: project1.id, total: 10, critical: 5) }
      let!(:inventory_filter_2) { create(:security_inventory_filters, project_id: project2.id, total: 20, high: 10) }
      let!(:inventory_filter_3) { create(:security_inventory_filters, project_id: project3.id, total: 30, medium: 15) }

      context 'when vulnerability statistics exist' do
        let!(:vuln_stat1) do
          create(:vulnerability_statistic, project: project1, total: 3, critical: 1, high: 1, medium: 1)
        end

        let!(:vuln_stat2) do
          create(:vulnerability_statistic, project: project2, total: 5, high: 2, medium: 2, low: 1)
        end

        it 'updates the security_inventory_filters with vulnerability statistics values' do
          sync_statistics

          expect(inventory_filter_1.reload).to have_attributes(
            project_name: 'Project 1',
            total: 3,
            critical: 1,
            high: 1,
            medium: 1,
            low: 0,
            unknown: 0,
            info: 0
          )

          expect(inventory_filter_2.reload).to have_attributes(
            project_name: 'Project 2', # unchanged
            total: 5,
            critical: 0,
            high: 2,
            medium: 2,
            low: 1,
            unknown: 0,
            info: 0
          )

          # id not in project_ids, should remain unchanged
          expect(inventory_filter_3.reload).to have_attributes(
            project_name: 'Project 3',
            total: 30,
            critical: 0,
            high: 0,
            medium: 15,
            low: 0,
            unknown: 0,
            info: 0
          )
        end
      end

      context 'when vulnerability statistics do not exist' do
        it 'sets all severity values to 0' do
          sync_statistics

          expect([inventory_filter_1.reload, inventory_filter_2.reload]).to all(have_attributes(
            total: 0,
            critical: 0,
            high: 0,
            medium: 0,
            low: 0,
            unknown: 0,
            info: 0
          ))
        end
      end

      context 'when security_inventory_filters record does not exist for a project' do
        let(:project_ids) { [project1.id, non_existing_record_id] }

        it 'only updates existing security_inventory_filters records' do
          expect { sync_statistics }.not_to change { Security::InventoryFilter.count }
          expect(inventory_filter_1.reload.total).to eq(0) # No vulnerability statistics exist
        end
      end
    end
  end
end
