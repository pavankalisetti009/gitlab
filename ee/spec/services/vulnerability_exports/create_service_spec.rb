# frozen_string_literal: true

require 'spec_helper'

RSpec.describe VulnerabilityExports::CreateService, feature_category: :vulnerability_management do
  include AccessMatchersGeneric

  before do
    stub_licensed_features(security_dashboard: true)
    create(:organization, :default)
  end

  let_it_be(:user) { create(:user, :auditor) }

  let(:group) { create(:group) }
  let(:project) { create(:project, :public, group: group) }
  let(:export_format) { 'csv' }
  let(:params) { { export_format: } }

  subject(:result) { described_class.new(project, user, **params).execute }

  describe '#execute' do
    context 'when security dashboard feature is disabled' do
      before do
        stub_licensed_features(security_dashboard: false)
      end

      it 'raises an "access denied" error' do
        expect { result }.to raise_error(Gitlab::Access::AccessDeniedError)
      end
    end

    context 'when security dashboard feature is enabled' do
      let(:recent_vulnerability_export) { Vulnerabilities::Export.last }
      let(:params) { { export_format:, send_email: } }
      let(:send_email) { false }

      before do
        allow(::VulnerabilityExports::ExportWorker).to receive(:perform_async)
      end

      it 'does not raise an "access denied" error' do
        expect { result }.not_to raise_error
      end

      it 'creates a new Vulnerabilities::Export' do
        expect { result }.to change { Vulnerabilities::Export.count }.from(0).to(1)
      end

      it 'schedules ::VulnerabilityExports::ExportWorker background job' do
        result
        expect(::VulnerabilityExports::ExportWorker).to have_received(:perform_async).with(recent_vulnerability_export.id)
      end

      it 'returns a new Vulnerabilities::Export with correct attributes' do
        expect(result).to have_attributes(
          project_id: project.id,
          format: export_format,
          send_email: send_email,
          status: 'created'
        )
      end

      context 'when send_email is true' do
        let(:send_email) { true }

        it "sets the export send_email to true" do
          result

          expect(recent_vulnerability_export.send_email).to eq(send_email)
        end
      end
    end
  end
end
