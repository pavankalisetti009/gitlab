# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Security::VulnerabilityScanning::SbomScanResultUploader, feature_category: :software_composition_analysis do
  let(:sbom_scan_result) { create(:sbom_scan_result) }
  let(:uploader) { described_class.new(sbom_scan_result, :sbom_scan_result_file) }

  subject { uploader }

  context 'when object store is REMOTE' do
    before do
      stub_uploads_object_storage
    end

    include_context 'with storage', described_class::Store::REMOTE

    describe '.default_store' do
      it 'returns remote store' do
        expect(described_class.default_store).to eq(ObjectStorage::Store::REMOTE)
      end
    end

    it_behaves_like "builds correct paths",
      store_dir: %r{\Asbom_scan_results/\h{2}/\h{2}/\h{64}/\d+\z},
      cache_dir: %r{uploads/-/system/tmp/cache\z},
      work_dir: %r{uploads/-/system/tmp/work\z}
  end

  context 'when file is stored in valid local_path' do
    include_context 'with storage', described_class::Store::LOCAL

    describe '.default_store' do
      it 'returns local store' do
        expect(described_class.default_store).to eq(ObjectStorage::Store::LOCAL)
      end
    end

    it_behaves_like "builds correct paths",
      store_dir: %r{\Auploads/-/system/sbom_scan_results/\h{2}/\h{2}/\h{64}/\d+\z},
      cache_dir: %r{uploads/-/system/tmp/cache\z},
      work_dir: %r{uploads/-/system/tmp/work\z}
  end

  describe '.hashed_path' do
    it 'generates the path deterministically' do
      expect(described_class.hashed_path(123, # rubocop:disable RSpec/IdenticalEqualityAssertion -- This tests idempotency of this class method
        456)).to eq(described_class.hashed_path(123, 456))
      expect(described_class.hashed_path(124,
        456)).not_to eq(described_class.hashed_path(123, 456))
      expect(described_class.hashed_path(123,
        789)).not_to eq(described_class.hashed_path(123, 456))
    end
  end
end
