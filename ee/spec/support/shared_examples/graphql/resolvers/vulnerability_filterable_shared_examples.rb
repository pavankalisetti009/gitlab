# frozen_string_literal: true

RSpec.shared_examples 'invalid argument error' do |error_message|
  it 'raises an ArgumentError' do
    result = defined?(resolved_value) ? resolved_value : subject

    expect(result).to be_a(Gitlab::Graphql::Errors::ArgumentError)
    expect(result.message).to eq(s_(error_message))
  end
end

RSpec.shared_examples 'advanced vulnerability management not available' do
  context 'when advanced vulnerability management is not available' do
    let(:target_object) { defined?(operate_on) ? operate_on : vulnerable }

    before do
      allow(current_user).to receive(:can?).and_call_original

      allow(current_user).to receive(:can?)
        .with(:access_advanced_vulnerability_management, target_object).and_return(false)
    end

    it_behaves_like 'invalid argument error', "Require advanced vulnerability management to be enabled!"
  end
end

RSpec.shared_examples 'validates self-managed first backfill' do
  context 'when data backfill migration is not completed on self-managed' do
    let(:target_object) { defined?(operate_on) ? operate_on : vulnerable }

    before do
      allow(current_user).to receive(:can?).and_call_original
      allow(current_user).to receive(:can?)
        .with(:access_advanced_vulnerability_management, target_object).and_return(true)
      allow(Search::Elastic::VulnerabilityIndexHelper).to receive(:self_managed_and_first_backfill_completed?)
        .and_return(false)
    end

    it_behaves_like 'invalid argument error', "Require data backfill migration to be completed!"
  end
end

RSpec.shared_examples 'validates advanced vulnerability management' do
  it_behaves_like 'advanced vulnerability management not available'
  it_behaves_like 'validates self-managed first backfill'
end

RSpec.shared_examples 'validates filters from vulnerability filterable' do |filter_key|
  include ElasticsearchHelpers

  describe '#validate_filters' do
    shared_examples_for 'requires backfill migration on self-managed' do
      context 'when self-managed backfill is not run' do
        before do
          set_elasticsearch_migration_to(:backfill_vulnerabilities_for_self_managed, including: false)
        end

        it_behaves_like 'invalid argument error', "Require data backfill migration to be completed!"
      end
    end

    shared_examples_for 'validates instance security dashboard' do
      context 'when vulnerable is InstanceSecurityDashboard' do
        let(:vulnerable) { InstanceSecurityDashboard.new(current_user) }

        it_behaves_like 'invalid argument error', "Feature is not supported for InstanceSecurityDashboard"
      end
    end

    context 'with owasp_top_10 filter' do
      context 'when owasp_top_ten includes "none" and other values' do
        let(filter_key) { { owasp_top_ten: %w[none A1_2017] } }

        it_behaves_like 'invalid argument error',
          "Incompatible argument: owasp_top_ten. " \
            "'NONE' wildcard cannot be combined with other OWASP top 10 values."
      end

      context 'when vulnerable is InstanceSecurityDashboard' do
        let(filter_key) { { owasp_top_ten: %w[A1_2017] } }
        let(:vulnerable) { InstanceSecurityDashboard.new(current_user) }

        it 'does not raise an error' do
          result = defined?(resolved_value) ? resolved_value : subject

          expect(result).not_to be_a(Gitlab::Graphql::Errors::ArgumentError)
        end
      end
    end

    context 'with valid owasp_top_10_2021 filter' do
      let(filter_key) { { owasp_top_ten_2021: ['A1:2021-Broken Access Control'] } }

      it_behaves_like 'advanced vulnerability management not available'

      context 'when advanced vulnerability management is enabled' do
        before do
          stub_ee_application_setting(elasticsearch_search: true, elasticsearch_indexing: true)
          set_elasticsearch_migration_to(:backfill_vulnerabilities_for_self_managed)
          vulnerable.add_developer(current_user) unless vulnerable.is_a?(InstanceSecurityDashboard)
        end

        context 'when owasp_top_ten_2021 includes "none" and other values' do
          let(filter_key) { { owasp_top_ten_2021: %w[none A1:2021-Broken Access Control] } }

          it_behaves_like 'invalid argument error',
            "Incompatible argument: owasp_top_ten_2021. " \
              "'NONE' wildcard cannot be combined with other OWASP top 10 values."
        end

        it_behaves_like 'validates instance security dashboard'
        it_behaves_like 'requires backfill migration on self-managed'
      end
    end

    context 'with reachability filter' do
      let(filter_key) { { reachability: :in_use } }

      it_behaves_like 'advanced vulnerability management not available'

      context 'when advanced vulnerability management is enabled' do
        before do
          stub_ee_application_setting(elasticsearch_search: true, elasticsearch_indexing: true)
          set_elasticsearch_migration_to(:backfill_vulnerabilities_for_self_managed)
          vulnerable.add_developer(current_user) unless vulnerable.is_a?(InstanceSecurityDashboard)
        end

        it_behaves_like 'validates instance security dashboard'
        it_behaves_like 'requires backfill migration on self-managed'
      end
    end

    context 'with validity_check' do
      let(filter_key) { { validity_check: [Security::FindingTokenStatus.statuses.each_key.first.upcase] } }

      it_behaves_like 'advanced vulnerability management not available'

      context 'when advanced vulnerability management is enabled' do
        before do
          stub_ee_application_setting(elasticsearch_search: true, elasticsearch_indexing: true)
          set_elasticsearch_migration_to(:backfill_vulnerabilities_for_self_managed, including: true)
          vulnerable.add_developer(current_user) unless vulnerable.is_a?(InstanceSecurityDashboard)
        end

        it_behaves_like 'validates instance security dashboard'
        it_behaves_like 'requires backfill migration on self-managed'

        context 'when `validity_check_es_filter` feature flag is disabled' do
          before do
            stub_feature_flags(validity_check_es_filter: false)
          end

          it_behaves_like 'invalid argument error',
            "The feature flag is not enabled or the required migrations are not completed."
        end

        context 'when the `backfill_token_status_in_vulnerabilities` migration is not finished' do
          before do
            set_elasticsearch_migration_to(:backfill_token_status_in_vulnerabilities, including: false)

            allow(::Elastic::DataMigrationService).to receive(:migration_has_finished?)
              .with(:backfill_vulnerabilities_for_self_managed).and_return(true)
          end

          it_behaves_like 'invalid argument error',
            "The feature flag is not enabled or the required migrations are not completed."
        end
      end
    end

    context 'with policy_violations' do
      let(filter_key) { { policy_violations: [Security::FindingTokenStatus.statuses.each_key.first.upcase] } }

      it_behaves_like 'advanced vulnerability management not available'

      context 'when advanced vulnerability management is enabled' do
        before do
          stub_ee_application_setting(elasticsearch_search: true, elasticsearch_indexing: true)
          set_elasticsearch_migration_to(:backfill_vulnerabilities_for_self_managed)
          vulnerable.add_developer(current_user) unless vulnerable.is_a?(InstanceSecurityDashboard)
        end

        it_behaves_like 'validates instance security dashboard'
        it_behaves_like 'requires backfill migration on self-managed'

        context 'when `policy_violations_es_filter` feature flag is disabled' do
          before do
            stub_feature_flags(policy_violations_es_filter: false)
          end

          it_behaves_like 'invalid argument error',
            "The feature flag is not enabled or the required migrations are not completed."
        end

        context 'when the `add_policy_violations_field_to_vulnerability` migration is not finished' do
          before do
            set_elasticsearch_migration_to(:add_policy_violations_field_to_vulnerability, including: false)

            allow(::Elastic::DataMigrationService).to receive(:migration_has_finished?)
               .with(:backfill_vulnerabilities_for_self_managed).and_return(true)
          end

          it_behaves_like 'invalid argument error',
            "The feature flag is not enabled or the required migrations are not completed."
        end
      end
    end

    context 'with identifier_name filter' do
      let(filter_key) { { identifier_name: 'CVE-2021-1234' } }

      context 'when advanced vulnerability management is not available' do
        before do
          allow(current_user).to receive(:can?).and_call_original
          allow(current_user).to receive(:can?)
            .with(:access_advanced_vulnerability_management, vulnerable).and_return(false)
        end

        it 'performs identifier search on DB' do
          expect_next_instance_of(described_class) do |instance|
            expect(instance).to receive(:search_by_identifier_allowed_on_db!)
              .with(vulnerable: vulnerable)
          end
          subject
        end

        it 'skips validate_advanced_vuln_management!' do
          expect_next_instance_of(described_class) do |instance|
            expect(instance).not_to receive(:validate_advanced_vuln_management!)
          end
          subject
        end

        it_behaves_like 'validates instance security dashboard'
      end

      context 'when advanced vulnerability management is available' do
        before do
          stub_ee_application_setting(elasticsearch_search: true, elasticsearch_indexing: true)
          set_elasticsearch_migration_to(:backfill_vulnerabilities_for_self_managed)
          vulnerable.add_developer(current_user) unless vulnerable.is_a?(InstanceSecurityDashboard)
        end

        it_behaves_like 'validates instance security dashboard'

        # Other advanced vulnerability management validations not required as it fallbacks to DB if unavailable.
      end
    end
  end
end
