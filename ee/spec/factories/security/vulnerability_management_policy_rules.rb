# frozen_string_literal: true

FactoryBot.define do
  factory :vulnerability_management_policy_rule, class: 'Security::VulnerabilityManagementPolicyRule' do
    security_policy
    sequence(:rule_index)
    security_policy_management_project_id do
      security_policy.security_orchestration_policy_configuration.security_policy_management_project_id
    end
    no_longer_detected

    trait :no_longer_detected do
      type { Security::VulnerabilityManagementPolicyRule.types[:no_longer_detected] }
      content do
        {
          type: 'no_longer_detected',
          severity_levels: %w[low],
          scanners: %w[sast]
        }
      end
    end

    trait :detected do
      type { Security::VulnerabilityManagementPolicyRule.types[:detected] }
      content do
        {
          type: 'detected',
          criteria: [
            {
              type: 'file_path',
              value: '**/*'
            }
          ]
        }
      end
    end

    trait :detected_file_path do
      detected

      transient do
        file_path { 'test/**/*' }
      end

      after(:build) do |rule, evaluator|
        rule.content[:criteria] = [{ type: 'file_path', value: evaluator.file_path }]
      end
    end

    trait :detected_directory do
      detected

      transient do
        directory { 'test' }
      end

      after(:build) do |rule, evaluator|
        rule.content[:criteria] = [{ type: 'directory', value: evaluator.directory }]
      end
    end

    trait :detected_identifier do
      detected

      transient do
        identifier { 'CVE-2025-12345' }
      end

      after(:build) do |rule, evaluator|
        rule.content[:criteria] = [{ type: 'identifier', value: evaluator.identifier }]
      end
    end
  end
end
