import {
  DASHBOARD_TYPE_GROUP,
  DASHBOARD_TYPE_PROJECT,
  DASHBOARD_TYPE_INSTANCE,
} from 'ee/security_dashboard/constants';
import initVulnerabilityReport from 'ee/security_dashboard/vulnerability_report_init';
import setWindowLocation from 'helpers/set_window_location_helper';
import { TEST_HOST } from 'helpers/test_constants';
import projectVulnerabilitiesQuery from 'ee/security_dashboard/graphql/queries/project_vulnerabilities.query.graphql';
import projectVulnerabilitiesWithPolicyViolationsQuery from 'ee/security_dashboard/graphql/queries/project_vulnerabilities_with_policy_violations.query.graphql';
import groupVulnerabilitiesQuery from 'ee/security_dashboard/graphql/queries/group_vulnerabilities.query.graphql';
import groupVulnerabilitiesWithPolicyViolationsQuery from 'ee/security_dashboard/graphql/queries/group_vulnerabilities_with_policy_violations.query.graphql';
import instanceVulnerabilitiesQuery from 'ee/security_dashboard/graphql/queries/instance_vulnerabilities.query.graphql';
import countsQuery from 'ee/security_dashboard/graphql/queries/vulnerability_severities_count.query.graphql';
import countsWithPolicyViolationsQuery from 'ee/security_dashboard/graphql/queries/vulnerability_severities_count_with_policy_violations.query.graphql';

jest.mock('vue', () => {
  const mockVueInstance = {
    $mount: jest.fn(),
  };

  const MockVue = jest.fn(() => mockVueInstance);
  MockVue.use = jest.fn();
  MockVue.observable = jest.fn();
  MockVue.mockInstance = mockVueInstance;

  return {
    __esModule: true,
    default: MockVue,
  };
});

jest.mock('vue-apollo', () => {
  const MockVueApollo = jest.fn(() => ({ mockVueApolloInstance: true }));
  return {
    __esModule: true,
    default: MockVueApollo,
  };
});

jest.mock('~/lib/graphql', () => ({
  __esModule: true,
  default: jest.fn(() => ({})),
}));

jest.mock('ee/security_dashboard/components/shared/empty_states/unavailable_state.vue', () => ({
  __esModule: true,
  default: 'MockUnavailableState',
}));

jest.mock('ee/security_dashboard/components/project/project_vulnerability_report.vue', () => ({
  __esModule: true,
  default: 'MockProjectVulnerabilityReport',
}));

jest.mock('ee/security_dashboard/components/group/group_vulnerability_report.vue', () => ({
  __esModule: true,
  default: 'MockGroupVulnerabilityReport',
}));

jest.mock('ee/security_dashboard/components/instance/instance_vulnerability_report.vue', () => ({
  __esModule: true,
  default: 'MockInstanceVulnerabilityReport',
}));

const EMPTY_DIV = document.createElement('div');

const TEST_DATASET = {
  emptyStateSvgPath: '/test/empty_state.svg',
  hasVulnerabilities: true,
  link: '/test/link',
  noVulnerabilitiesSvgPath: '/test/no_vulnerability_state.svg',
  svgPath: '/test/no_changes_state.svg',
  securityDashboardEmptySvgPath: 'surveyRequest.svg',
  vulnerabilitiesExportEndpoint: '/test/export-vulnerabilities',
};

describe('Vulnerability Report', () => {
  let Vue;
  let root;
  let initFn = initVulnerabilityReport;
  const originalGon = window.gon;

  beforeEach(() => {
    root = document.createElement('div');
    document.body.appendChild(root);

    setWindowLocation(`${TEST_HOST}/-/security/vulnerabilities`);
  });

  afterEach(() => {
    root.remove();
    window.gon = originalGon;
  });

  const createComponent = ({ data, type }) => {
    const el = document.createElement('div');
    Object.assign(el.dataset, { ...TEST_DATASET, ...data });
    root.appendChild(el);
    initFn(el, type);
  };

  const createEmptyComponent = () => {
    initFn(null, null);
  };

  describe('default states', () => {
    beforeAll(() => {
      jest.resetModules();
    });

    beforeEach(() => {
      window.gon = {
        abilities: { accessAdvancedVulnerabilityManagement: true },
        features: { securityPolicyApprovalWarnMode: true, policyViolationsEsFilter: true },
      };
      // eslint-disable-next-line global-require
      Vue = require('vue').default;
      // eslint-disable-next-line global-require
      const module = require('ee/security_dashboard/vulnerability_report_init');
      initFn = module.default;
    });

    it('renders project-level', () => {
      createComponent({
        data: {
          pipelineSecurityBuildsFailedCount: 1,
          pipelineSecurityBuildsFailedPath: '/test/failed_pipeline_02',
          projectFullPath: '/test/project',
          securityConfigurationPath: '/test/configuration',
        },
        type: DASHBOARD_TYPE_PROJECT,
      });

      // Verify the component is rendered
      expect(root).not.toStrictEqual(EMPTY_DIV);

      expect(Vue).toHaveBeenCalledWith(
        expect.objectContaining({
          provide: expect.objectContaining({
            dashboardType: DASHBOARD_TYPE_PROJECT,
            vulnerabilitiesQuery: projectVulnerabilitiesWithPolicyViolationsQuery,
            vulnerabilitiesCountsQuery: countsWithPolicyViolationsQuery,
          }),
        }),
      );
    });

    it('renders group-level', () => {
      createComponent({ data: { groupFullPath: '/test/' }, type: DASHBOARD_TYPE_GROUP });

      // Verify the component is rendered
      expect(root).not.toStrictEqual(EMPTY_DIV);

      expect(Vue).toHaveBeenCalledWith(
        expect.objectContaining({
          provide: expect.objectContaining({
            dashboardType: DASHBOARD_TYPE_GROUP,
            vulnerabilitiesQuery: groupVulnerabilitiesWithPolicyViolationsQuery,
            vulnerabilitiesCountsQuery: countsWithPolicyViolationsQuery,
          }),
        }),
      );
    });

    it('renders instance-level with policy violations count query', () => {
      createComponent({
        data: { instanceDashboardSettingsPath: '/instance/settings_page' },
        type: DASHBOARD_TYPE_INSTANCE,
      });

      // Verify the component is rendered
      expect(root).not.toStrictEqual(EMPTY_DIV);

      expect(Vue).toHaveBeenCalledWith(
        expect.objectContaining({
          provide: expect.objectContaining({
            dashboardType: DASHBOARD_TYPE_INSTANCE,
            vulnerabilitiesQuery: instanceVulnerabilitiesQuery,
            vulnerabilitiesCountsQuery: countsWithPolicyViolationsQuery,
          }),
        }),
      );
    });
  });

  describe('without "accessAdvancedVulnerabilityManagement" ability, "securityPolicyApprovalWarnMode" feature flag, or "policyViolationsEsFilter" feature flag', () => {
    beforeAll(() => {
      jest.resetModules();
    });

    beforeEach(() => {
      // eslint-disable-next-line global-require
      Vue = require('vue').default;
      // eslint-disable-next-line global-require
      const module = require('ee/security_dashboard/vulnerability_report_init');
      initFn = module.default;
    });

    it('renders project-level without policy violations', () => {
      createComponent({
        data: {
          pipelineSecurityBuildsFailedCount: 1,
          pipelineSecurityBuildsFailedPath: '/test/failed_pipeline_02',
          projectFullPath: '/test/project',
          securityConfigurationPath: '/test/configuration',
        },
        type: DASHBOARD_TYPE_PROJECT,
      });

      // Verify the component is rendered
      expect(root).not.toStrictEqual(EMPTY_DIV);

      expect(Vue).toHaveBeenCalledWith(
        expect.objectContaining({
          provide: expect.objectContaining({
            dashboardType: DASHBOARD_TYPE_PROJECT,
            vulnerabilitiesQuery: projectVulnerabilitiesQuery,
            vulnerabilitiesCountsQuery: countsQuery,
          }),
        }),
      );
    });

    it('renders group-level without policy violations', () => {
      createComponent({ data: { groupFullPath: '/test/' }, type: DASHBOARD_TYPE_GROUP });

      expect(root).not.toStrictEqual(EMPTY_DIV);

      expect(Vue).toHaveBeenCalledWith(
        expect.objectContaining({
          provide: expect.objectContaining({
            dashboardType: DASHBOARD_TYPE_GROUP,
            vulnerabilitiesQuery: groupVulnerabilitiesQuery,
            vulnerabilitiesCountsQuery: countsQuery,
          }),
        }),
      );
    });

    it('renders instance-level without policy violations', () => {
      createComponent({
        data: { instanceDashboardSettingsPath: '/instance/settings_page' },
        type: DASHBOARD_TYPE_INSTANCE,
      });

      expect(Vue).toHaveBeenCalledWith(
        expect.objectContaining({
          provide: expect.objectContaining({
            dashboardType: DASHBOARD_TYPE_INSTANCE,
            vulnerabilitiesQuery: instanceVulnerabilitiesQuery,
            vulnerabilitiesCountsQuery: countsQuery,
          }),
        }),
      );
    });
  });

  describe('error states', () => {
    it('does not have an element', () => {
      createEmptyComponent();

      expect(root).toStrictEqual(EMPTY_DIV);
    });

    it('has unavailable pages', () => {
      createComponent({ data: { isUnavailable: true } });

      expect(root).toMatchSnapshot();
    });
  });
});
