import { GlSprintf } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import { SEVERITY_LEVELS_KEYS, REPORT_TYPES_DEFAULT_KEYS } from 'ee/security_dashboard/constants';
import NoLongerDetectedRule from 'ee/security_orchestration/components/policy_editor/vulnerability_management/rule/no_longer_detected_rule.vue';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';
import { mockVulnerabilityManagementObject } from 'ee_jest/security_orchestration/mocks/mock_vulnerability_management_policy_data';

describe('NoLongerDetectedRule', () => {
  let wrapper;

  const defaultRule = mockVulnerabilityManagementObject.rules[0];
  const modifiedRule = { ...defaultRule, scanners: ['api_fuzzing'], severity_levels: ['high'] };

  const factory = ({ propsData } = {}) => {
    wrapper = shallowMountExtended(NoLongerDetectedRule, {
      propsData: {
        isFirstRule: true,
        rule: defaultRule,
        ...propsData,
      },
      stubs: {
        GlSprintf,
      },
    });
  };

  const findSectionLayout = () => wrapper.findComponent(SectionLayout);
  const findScannersSelect = () => wrapper.findByTestId('scanners-select');
  const findSeveritySelect = () => wrapper.findByTestId('severities-select');

  describe('remove button', () => {
    it('does not show remove button if first rule', () => {
      factory();
      expect(findSectionLayout().props('showRemoveButton')).toBe(false);
    });

    it('shows remove button if not first rule', () => {
      factory({ propsData: { isFirstRule: false } });
      expect(findSectionLayout().props('showRemoveButton')).toBe(true);
    });

    it('propagates the "remove" event', () => {
      factory();
      findSectionLayout().vm.$emit('remove');
      expect(wrapper.emitted('remove')).toHaveLength(1);
    });
  });

  describe('message', () => {
    it('renders message', () => {
      factory();
      expect(findSectionLayout().text()).toEqual(
        'If  of the default branch finds  vulnerabilities are no longer detected.',
      );
    });
  });

  describe('scanners select', () => {
    beforeEach(() => {
      factory();
    });

    it('passes default scanners when rule contains no scanners', () => {
      const ruleWithAllScanners = { ...defaultRule, scanners: [] };
      factory({ propsData: { rule: ruleWithAllScanners } });
      expect(findScannersSelect().props('value')).toEqual(REPORT_TYPES_DEFAULT_KEYS);
    });

    it('passes scanners of rule when rule contains scanners', () => {
      factory({ propsData: { rule: modifiedRule } });
      expect(findScannersSelect().props('value')).toEqual(modifiedRule.scanners);
    });

    it('emits empty array when all scanners are selected', () => {
      factory({ propsData: { rule: modifiedRule } });
      findScannersSelect().vm.$emit('input', REPORT_TYPES_DEFAULT_KEYS);
      expect(wrapper.emitted('changed')).toMatchObject([[{ ...modifiedRule, scanners: [] }]]);
    });

    it('emits selected scanners if not all scanners are selected', () => {
      findScannersSelect().vm.$emit('input', ['api_fuzzing']);
      expect(wrapper.emitted('changed')).toMatchObject([
        [{ ...defaultRule, scanners: ['api_fuzzing'] }],
      ]);
    });
  });

  describe('severity levels select', () => {
    beforeEach(() => {
      factory();
    });

    it('passes default severity levels when rule contains no severity levels', () => {
      const ruleWithAllSeverityLevels = { ...defaultRule, severity_levels: [] };
      factory({ propsData: { rule: ruleWithAllSeverityLevels } });
      expect(findSeveritySelect().props('value')).toEqual(SEVERITY_LEVELS_KEYS);
    });

    it('passes severity levels of rule when rule contains severity levels', () => {
      factory({ propsData: { rule: modifiedRule } });
      expect(findSeveritySelect().props('value')).toEqual(modifiedRule.severity_levels);
    });

    it('emits empty array when all severity levels are selected', () => {
      factory({ propsData: { rule: modifiedRule } });
      findSeveritySelect().vm.$emit('input', SEVERITY_LEVELS_KEYS);
      expect(wrapper.emitted('changed')).toEqual([[{ ...modifiedRule, severity_levels: [] }]]);
    });

    it('emits selected severity levels if not all severity levels are selected', () => {
      findSeveritySelect().vm.$emit('input', ['high']);
      expect(wrapper.emitted('changed')).toEqual([[{ ...defaultRule, severity_levels: ['high'] }]]);
    });
  });
});
