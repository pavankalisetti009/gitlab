import { shallowMount } from '@vue/test-utils';
import { GlBadge, GlCollapsibleListbox, GlFormInput } from '@gitlab/ui';
import VulnerabilityFoundCriteria from 'ee/security_orchestration/components/policy_editor/vulnerability_management/rule/vulnerability_found_criteria.vue';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';
import { CRITERIA_TYPES } from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';

describe('VulnerabilityFoundCriteria', () => {
  let wrapper;

  const defaultProps = {
    criteria: {
      type: 'file_path',
      value: 'CVE-2021-1234',
    },
  };

  const createWrapper = (props = {}) => {
    wrapper = shallowMount(VulnerabilityFoundCriteria, {
      propsData: {
        ...defaultProps,
        ...props,
      },
      stubs: {
        GlCollapsibleListbox,
      },
    });
  };

  const findBadge = () => wrapper.findComponent(GlBadge);
  const findSectionLayout = () => wrapper.findComponent(SectionLayout);
  const findListbox = () => wrapper.findComponent(GlCollapsibleListbox);
  const findFormInput = () => wrapper.findComponent(GlFormInput);

  describe('default rendering', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('renders section layout', () => {
      expect(findSectionLayout().exists()).toBe(true);
    });

    it('renders collapsible listbox', () => {
      expect(findListbox().exists()).toBe(true);
    });

    it('renders form input', () => {
      expect(findFormInput().exists()).toBe(true);
    });
  });

  describe('listbox configuration', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('passes correct items to listbox', () => {
      const expectedItems = Object.entries(CRITERIA_TYPES).map(([value, text]) => ({
        value,
        text,
        disabled: false,
      }));

      expect(findListbox().props('items')).toEqual(expectedItems);
    });

    it('passes selected type to listbox', () => {
      expect(findListbox().props('selected')).toBe('file_path');
    });

    it('sets block prop on listbox', () => {
      expect(findListbox().props('block')).toBe(true);
    });
  });

  describe('form input configuration', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('passes value to form input', () => {
      expect(findFormInput().props('value')).toBe('CVE-2021-1234');
    });

    it('applies correct CSS classes when showRemoveButton is false', () => {
      createWrapper({ showRemoveButton: false });

      expect(findFormInput().classes()).toContain('!gl-mr-8');
    });

    it('does not apply margin class when showRemoveButton is true', () => {
      createWrapper({ showRemoveButton: true });

      expect(findFormInput().classes()).not.toContain('!gl-mr-8');
    });
  });

  describe('type selection', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('emits select-type event when type is selected', async () => {
      await findListbox().vm.$emit('select', 'package');

      expect(wrapper.emitted('select-type')).toHaveLength(1);
      expect(wrapper.emitted('select-type')[0]).toEqual([
        {
          type: 'package',
          value: 'CVE-2021-1234',
        },
      ]);
    });

    it('preserves existing value when changing type', async () => {
      await findListbox().vm.$emit('select', 'severity');

      expect(wrapper.emitted('select-type')[0][0]).toMatchObject({
        type: 'severity',
        value: 'CVE-2021-1234',
      });
    });
  });

  describe('value updates', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('emits update-value event when input value changes', async () => {
      await findFormInput().vm.$emit('input', 'CVE-2021-5678');

      expect(wrapper.emitted('update-value')).toHaveLength(1);
      expect(wrapper.emitted('update-value')[0]).toEqual([
        {
          type: 'file_path',
          value: 'CVE-2021-5678',
        },
      ]);
    });

    it('preserves existing type when changing value', async () => {
      await findFormInput().vm.$emit('input', 'new-value');

      expect(wrapper.emitted('update-value')[0][0]).toMatchObject({
        type: 'file_path',
        value: 'new-value',
      });
    });
  });

  describe('with empty criteria', () => {
    beforeEach(() => {
      createWrapper({ criteria: {} });
    });

    it('displays placeholder text when no type is selected', () => {
      expect(findListbox().props('toggleText')).toBe('Select criteria');
    });

    it('displays empty value in input', () => {
      expect(findFormInput().props('value')).toBe('');
    });

    it('has empty selected type', () => {
      expect(findListbox().props('selected')).toBe('');
    });
  });

  describe('with undefined criteria', () => {
    beforeEach(() => {
      createWrapper({ criteria: undefined });
    });

    it('handles undefined criteria gracefully', () => {
      expect(findListbox().props('selected')).toBe('');
      expect(findFormInput().props('value')).toBe('');
      expect(findListbox().props('toggleText')).toBe('Select criteria');
    });
  });

  describe('remove functionality', () => {
    beforeEach(() => {
      createWrapper({ showRemoveButton: true });
    });

    it('shows remove button when showRemoveButton is true', () => {
      expect(findSectionLayout().props('showRemoveButton')).toBe(true);
    });

    it('emits remove event when section layout emits remove', async () => {
      await findSectionLayout().vm.$emit('remove');

      expect(wrapper.emitted('remove')).toHaveLength(1);
    });
  });

  describe('without remove button', () => {
    beforeEach(() => {
      createWrapper({ showRemoveButton: false });
    });

    it('hides remove button when showRemoveButton is false', () => {
      expect(findSectionLayout().props('showRemoveButton')).toBe(false);
    });
  });

  describe('different criteria types', () => {
    it.each(Object.keys(CRITERIA_TYPES))('displays correct text for %s type', (criteriaType) => {
      createWrapper({
        criteria: {
          type: criteriaType,
          value: 'test-value',
        },
      });

      expect(findListbox().props('toggleText')).toBe(CRITERIA_TYPES[criteriaType]);
      expect(findListbox().props('selected')).toBe(criteriaType);
    });
  });

  describe('edge cases', () => {
    it('handles null criteria', () => {
      createWrapper({ criteria: null });

      expect(wrapper.exists()).toBe(true);
      expect(findListbox().props('selected')).toBe('');
      expect(findFormInput().props('value')).toBe('');
    });

    it('handles criteria with only type', () => {
      createWrapper({ criteria: { type: 'file_path' } });

      expect(findListbox().props('selected')).toBe('file_path');
      expect(findFormInput().props('value')).toBe('');
    });

    it('handles criteria with only value', () => {
      createWrapper({ criteria: { value: 'some-value' } });

      expect(findListbox().props('selected')).toBe('');
      expect(findFormInput().props('value')).toBe('some-value');
    });

    it('handles empty string values', () => {
      createWrapper({ criteria: { type: 'cve', value: '' } });

      expect(findFormInput().props('value')).toBe('');
    });
  });

  describe('CSS classes', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('applies correct classes to section layout', () => {
      expect(findSectionLayout().classes()).toContain('gl-py-2');
      expect(findSectionLayout().classes()).toContain('gl-pl-0');
    });

    it('applies correct classes to listbox', () => {
      expect(findListbox().classes()).toContain('gl-min-w-20');
    });

    it('applies correct classes to form input', () => {
      expect(findFormInput().classes()).toContain('gl-flex-1');
    });
  });

  describe('selected types', () => {
    it('disables already selected type', () => {
      createWrapper({
        criteria: {
          type: 'file_path',
          value: 'test-value',
        },
        disabledTypes: ['file_path'],
      });

      expect(findBadge().exists()).toBe(true);

      findListbox().vm.$emit('selected', 'file_path');

      expect(wrapper.emitted('changed')).toBeUndefined();
    });

    it('disables listbox if all types were selected', () => {
      createWrapper({
        criteria: {
          type: 'file_path',
          value: 'test-value',
        },
        disabled: true,
      });

      expect(findListbox().props('disabled')).toBe(true);
    });
  });
});
