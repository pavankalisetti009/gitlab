import { GlSprintf } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import VulnerabilityFoundRule from 'ee/security_orchestration/components/policy_editor/vulnerability_management/rule/vulnerability_found_rule.vue';
import VulnerabilityFoundCriteria from 'ee/security_orchestration/components/policy_editor/vulnerability_management/rule/vulnerability_found_criteria.vue';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';

describe('VulnerabilityFoundRule', () => {
  let wrapper;

  const defaultRule = {
    type: 'vulnerability_found',
    criteria: [{ type: 'file_path', value: 'CVE-2021-1234' }],
  };

  const createWrapper = (props = {}) => {
    wrapper = shallowMountExtended(VulnerabilityFoundRule, {
      propsData: {
        rule: defaultRule,
        isFirstRule: true,
        ...props,
      },
      stubs: {
        GlSprintf,
      },
    });
  };

  const findSectionLayout = () => wrapper.findComponent(SectionLayout);
  const findAddButton = () => wrapper.findByTestId('add-criteria');
  const findAllCriteria = () => wrapper.findAllComponents(VulnerabilityFoundCriteria);
  const findCriteriaAt = (index) => findAllCriteria().at(index);

  describe('default rendering', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('renders section layout', () => {
      expect(findSectionLayout().exists()).toBe(true);
    });

    it('renders GlSprintf with correct message', () => {
      expect(wrapper.text()).toContain(
        'If vulnerabilities are automatically dismissed when found under following criteria:',
      );
    });

    it('renders add criteria button', () => {
      expect(findAddButton().exists()).toBe(true);
      expect(findAddButton().text()).toBe('Add new criteria');
    });

    it('renders vulnerability found criteria', () => {
      expect(findAllCriteria()).toHaveLength(1);
    });
  });

  describe('first rule', () => {
    beforeEach(() => {
      createWrapper({ index: 0 });
    });

    it('does not show remove button for first rule', () => {
      expect(findSectionLayout().props('showRemoveButton')).toBe(false);
    });
  });

  describe('subsequent rules', () => {
    beforeEach(() => {
      createWrapper({ isFirstRule: false });
    });

    it('shows remove button for non-first rules', () => {
      expect(findSectionLayout().props('showRemoveButton')).toBe(true);
    });

    it('emits remove event when section layout emits remove', async () => {
      await findSectionLayout().vm.$emit('remove');

      expect(wrapper.emitted('remove')).toHaveLength(1);
    });
  });

  describe('criteria rendering', () => {
    beforeEach(() => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-2021-1234' },
            { type: 'package', value: 'lodash' },
          ],
        },
      });
    });

    it('renders all criteria', () => {
      expect(findAllCriteria()).toHaveLength(2);
    });

    it('passes correct props to first criteria', () => {
      expect(findCriteriaAt(0).props('criteria')).toEqual({
        type: 'cve',
        value: 'CVE-2021-1234',
      });
      expect(findCriteriaAt(0).props('showRemoveButton')).toBe(false);
    });

    it('passes correct props to second criteria', () => {
      expect(findCriteriaAt(1).props('criteria')).toEqual({
        type: 'package',
        value: 'lodash',
      });
      expect(findCriteriaAt(1).props('showRemoveButton')).toBe(true);
    });
  });

  describe('with no criteria', () => {
    beforeEach(() => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
        },
      });
    });

    it('renders default criteria when rule has no criteria', () => {
      expect(findAllCriteria()).toHaveLength(1);
      expect(findAllCriteria().at(0).props('criteria')).toEqual({ type: '', value: '' });
    });
  });

  describe('adding criteria', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('emits changed event when add button is clicked', async () => {
      await findAddButton().vm.$emit('click');

      expect(wrapper.emitted('changed')).toHaveLength(1);
      expect(wrapper.emitted('changed')).toEqual([
        [
          {
            type: 'vulnerability_found',
            criteria: [
              { type: 'file_path', value: 'CVE-2021-1234' },
              { type: '', value: '' },
            ],
          },
        ],
      ]);
    });
  });

  describe('maximum criteria limit', () => {
    beforeEach(() => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-2021-1234' },
            { type: 'package', value: 'lodash' },
            { type: 'severity', value: 'critical' },
          ],
        },
      });
    });

    it('disables add button when maximum criteria reached', () => {
      expect(findAddButton().attributes().disabled).toBe('true');
    });

    it('renders maximum of 3 criteria', () => {
      expect(findAllCriteria()).toHaveLength(3);
    });
  });

  describe('with more than 3 criteria', () => {
    beforeEach(() => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-1' },
            { type: 'cve', value: 'CVE-2' },
            { type: 'cve', value: 'CVE-3' },
            { type: 'cve', value: 'CVE-4' },
            { type: 'cve', value: 'CVE-5' },
          ],
        },
      });
    });

    it('only renders first 3 criteria', () => {
      expect(findAllCriteria()).toHaveLength(3);
    });
  });

  describe('updating criteria', () => {
    beforeEach(() => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-2021-1234' },
            { type: 'package', value: 'lodash' },
          ],
        },
      });
    });

    it('emits changed event when criteria type is selected', async () => {
      await findCriteriaAt(0).vm.$emit('select-type', { type: 'severity', value: 'CVE-2021-1234' });

      expect(wrapper.emitted('changed')).toHaveLength(1);
      expect(wrapper.emitted('changed')[0][0].criteria[0]).toEqual({
        type: 'severity',
        value: 'CVE-2021-1234',
      });
    });

    it('emits changed event when criteria value is updated', async () => {
      await findCriteriaAt(0).vm.$emit('update-value', { type: 'cve', value: 'CVE-2021-5678' });

      expect(wrapper.emitted('changed')).toHaveLength(1);
      expect(wrapper.emitted('changed')[0][0].criteria[0]).toEqual({
        type: 'cve',
        value: 'CVE-2021-5678',
      });
    });

    it('updates correct criteria when multiple exist', async () => {
      await findCriteriaAt(1).vm.$emit('select-type', { type: 'severity', value: 'lodash' });

      expect(wrapper.emitted('changed')[0][0].criteria[1]).toEqual({
        type: 'severity',
        value: 'lodash',
      });
      expect(wrapper.emitted('changed')[0][0].criteria[0]).toEqual({
        type: 'cve',
        value: 'CVE-2021-1234',
      });
    });
  });

  describe('removing criteria', () => {
    beforeEach(() => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-2021-1234' },
            { type: 'package', value: 'lodash' },
            { type: 'severity', value: 'critical' },
          ],
        },
      });
    });

    it('emits changed event when criteria is removed', async () => {
      await findCriteriaAt(1).vm.$emit('remove');

      expect(wrapper.emitted('changed')).toHaveLength(1);
      expect(wrapper.emitted('changed')[0][0].criteria).toHaveLength(2);
      expect(wrapper.emitted('changed')[0][0].criteria).toEqual([
        { type: 'cve', value: 'CVE-2021-1234' },
        { type: 'severity', value: 'critical' },
      ]);
    });

    it('removes correct criteria', async () => {
      await findCriteriaAt(0).vm.$emit('remove');

      expect(wrapper.emitted('changed')[0][0].criteria).toEqual([
        { type: 'package', value: 'lodash' },
        { type: 'severity', value: 'critical' },
      ]);
    });
  });

  describe('criteria remove button visibility', () => {
    beforeEach(() => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-1' },
            { type: 'cve', value: 'CVE-2' },
            { type: 'cve', value: 'CVE-3' },
          ],
        },
      });
    });

    it('does not show remove button for first criteria', () => {
      expect(findCriteriaAt(0).props('showRemoveButton')).toBe(false);
    });

    it('shows remove button for second criteria', () => {
      expect(findCriteriaAt(1).props('showRemoveButton')).toBe(true);
    });

    it('shows remove button for third criteria', () => {
      expect(findCriteriaAt(2).props('showRemoveButton')).toBe(true);
    });
  });

  describe('add button state', () => {
    it('enables add button when less than 3 criteria', () => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [{ type: 'cve', value: 'CVE-1' }],
        },
      });

      expect(findAddButton().attributes().disabled).toBeUndefined();
    });

    it('enables add button with 2 criteria', () => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-1' },
            { type: 'cve', value: 'CVE-2' },
          ],
        },
      });

      expect(findAddButton().attributes().disabled).toBeUndefined();
    });

    it('disables add button with 3 criteria', () => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'cve', value: 'CVE-1' },
            { type: 'cve', value: 'CVE-2' },
            { type: 'cve', value: 'CVE-3' },
          ],
        },
      });

      expect(findAddButton().attributes().disabled).toBe('true');
    });
  });

  describe('selected types', () => {
    it('passes selected criteria types to criteria component', () => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'file_path', value: 'CVE-1' },
            { type: 'identifier', value: 'CVE-2' },
          ],
        },
      });

      const expectedTypes = ['file_path', 'identifier'];

      expect(findCriteriaAt(0).props('disabledTypes')).toEqual(expectedTypes);
      expect(findCriteriaAt(0).props('disabled')).toBe(false);
      expect(findCriteriaAt(1).props('disabledTypes')).toEqual(expectedTypes);
      expect(findCriteriaAt(0).props('disabled')).toBe(false);
    });

    it('pass disabled property to criteria component when all types selected', () => {
      createWrapper({
        rule: {
          type: 'vulnerability_found',
          criteria: [
            { type: 'file_path', value: 'CVE-1' },
            { type: 'identifier', value: 'CVE-2' },
            { type: 'directory', value: 'CVE-2' },
          ],
        },
      });

      expect(findCriteriaAt(0).props('disabled')).toBe(true);
      expect(findCriteriaAt(1).props('disabled')).toBe(true);
    });
  });
});
