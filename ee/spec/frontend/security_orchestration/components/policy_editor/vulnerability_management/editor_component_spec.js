import { nextTick } from 'vue';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import { DEFAULT_ASSIGNED_POLICY_PROJECT } from 'ee/security_orchestration/constants';
import EditorComponent from 'ee/security_orchestration/components/policy_editor/vulnerability_management/editor_component.vue';
import EditorLayout from 'ee/security_orchestration/components/policy_editor/editor_layout.vue';
import RuleSection from 'ee/security_orchestration/components/policy_editor/vulnerability_management/rule/rule_section.vue';
import ActionSection from 'ee/security_orchestration/components/policy_editor/vulnerability_management/action/action_section.vue';
import { DEFAULT_VULNERABILITY_MANAGEMENT_POLICY } from 'ee/security_orchestration/components/policy_editor/vulnerability_management/constants';
import {
  mockVulnerabilityManagementManifest,
  mockVulnerabilityManagementObject,
} from 'ee_jest/security_orchestration/mocks/mock_vulnerability_management_policy_data';

describe('EditorComponent', () => {
  let wrapper;
  const defaultProjectPath = 'path/to/project';

  const factory = ({ propsData = {}, provide = {} } = {}) => {
    wrapper = shallowMountExtended(EditorComponent, {
      propsData: {
        assignedPolicyProject: DEFAULT_ASSIGNED_POLICY_PROJECT,
        isEditing: false,
        ...propsData,
      },
      provide: {
        namespacePath: defaultProjectPath,
        ...provide,
      },
    });
  };

  const findPolicyEditorLayout = () => wrapper.findComponent(EditorLayout);
  const findRuleSection = () => wrapper.findComponent(RuleSection);
  const findAllRuleSections = () => wrapper.findAllComponents(RuleSection);
  const findAddRuleButton = () => wrapper.findByTestId('add-rule');
  const findActionSection = () => wrapper.findComponent(ActionSection);

  beforeEach(() => {
    factory();
  });

  describe('rule mode', () => {
    it('renders the editor', () => {
      expect(findPolicyEditorLayout().exists()).toBe(true);
      expect(findActionSection().exists()).toBe(true);
    });

    it('renders the default policy editor layout', () => {
      expect(findPolicyEditorLayout().props()).toMatchObject({
        yamlEditorValue: DEFAULT_VULNERABILITY_MANAGEMENT_POLICY,
        isEditing: false,
        isRemovingPolicy: false,
        isUpdatingPolicy: false,
      });
    });

    it('updates the general policy properties', async () => {
      const name = 'New name';
      const editorLayout = findPolicyEditorLayout();
      expect(editorLayout.props('policy').name).toBe('');
      expect(editorLayout.props('yamlEditorValue')).toContain("name: ''");
      await editorLayout.vm.$emit('update-property', 'name', name);
      expect(editorLayout.props('policy').name).toBe(name);
      expect(editorLayout.props('yamlEditorValue')).toContain(`name: ${name}`);
    });

    describe('rule section', () => {
      const defaultRule = {
        type: 'no_longer_detected',
        scanners: [],
        severity_levels: [],
      };

      it('passes the correct props', () => {
        const ruleSection = findRuleSection();
        expect(ruleSection.props('index')).toBe(0);
        expect(ruleSection.props('rule')).toEqual(defaultRule);
      });

      it('adds a rule when clicking button', async () => {
        findAddRuleButton().vm.$emit('click');
        await nextTick();
        expect(findAllRuleSections()).toHaveLength(2);
      });

      it('shows correct label for add rule button', () => {
        expect(findAddRuleButton().text()).toBe('Add new rule');
      });

      it('removes rule when "remove" event is emitted', async () => {
        findAddRuleButton().vm.$emit('click');
        findRuleSection().vm.$emit('remove');
        await nextTick();
        expect(findAllRuleSections()).toHaveLength(1);
      });

      it('updates policy rule when "changed" event is emitted', async () => {
        const ruleSection = findRuleSection();
        const adaptedRule = { ...defaultRule, severity_levels: ['high'] };

        ruleSection.vm.$emit('changed', adaptedRule);
        await nextTick();

        expect(ruleSection.props('rule')).toEqual(adaptedRule);
        expect(findPolicyEditorLayout().props('yamlEditorValue')).toContain(
          'severity_levels:\n      - high',
        );
      });
    });

    describe('action section', () => {
      it('passes correct props', () => {
        expect(findActionSection().props('actions')).toEqual([{ type: 'auto_resolve' }]);
      });
    });
  });

  describe('yaml mode', () => {
    it('updates the policy', async () => {
      await findPolicyEditorLayout().vm.$emit('update-yaml', mockVulnerabilityManagementManifest);
      expect(findPolicyEditorLayout().props('policy')).toEqual(mockVulnerabilityManagementObject);
      expect(findPolicyEditorLayout().props('yamlEditorValue')).toBe(
        mockVulnerabilityManagementManifest,
      );
    });
  });
});
