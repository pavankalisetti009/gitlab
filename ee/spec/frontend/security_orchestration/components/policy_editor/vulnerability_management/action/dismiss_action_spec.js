import { GlCollapsibleListbox, GlSprintf } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import DismissAction from 'ee/security_orchestration/components/policy_editor/vulnerability_management/action/dismiss_action.vue';
import { mockVulnerabilityManagementObject } from 'ee_jest/security_orchestration/mocks/mock_vulnerability_management_policy_data';

describe('DismissAction', () => {
  let wrapper;

  const defaultAction = { ...mockVulnerabilityManagementObject.actions[0], type: 'auto_dismiss' };

  const createWrapper = ({ propsData } = {}) => {
    wrapper = shallowMountExtended(DismissAction, {
      propsData: {
        action: defaultAction,
        ...propsData,
      },
      stubs: {
        GlCollapsibleListbox,
        GlSprintf,
      },
    });
  };

  const findListBox = () => wrapper.findComponent(GlCollapsibleListbox);

  describe('default state', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('renders default state', () => {
      expect(findListBox().exists()).toBe(true);
      expect(findListBox().props('selected')).toBe('acceptable_risk');
      expect(findListBox().props('toggleText')).toBe('Acceptable Risk');
      expect(wrapper.text()).toContain('Then automatically dismiss these vulnerabilities with the');
    });

    it('selects reason', () => {
      findListBox().vm.$emit('select', 'false_positive');

      expect(wrapper.emitted('select')).toEqual([
        [{ ...defaultAction, dismissal_reason: 'false_positive' }],
      ]);
    });
  });

  describe('selected state', () => {
    it('renders selected state', () => {
      createWrapper({
        propsData: { action: { ...defaultAction, dismissal_reason: 'false_positive' } },
      });

      expect(findListBox().props('selected')).toBe('false_positive');
      expect(findListBox().props('toggleText')).toBe('False positive');
    });
  });
});
