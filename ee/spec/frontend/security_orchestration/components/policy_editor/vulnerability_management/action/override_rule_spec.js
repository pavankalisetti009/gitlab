import { GlCollapsibleListbox, GlSprintf } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import OverrideRule from 'ee/security_orchestration/components/policy_editor/vulnerability_management/action/override_rule.vue';

describe('OverrideRule', () => {
  let wrapper;

  const defaultAction = { type: 'override', customize: '' };

  const createWrapper = ({ propsData } = {}) => {
    wrapper = shallowMountExtended(OverrideRule, {
      propsData: {
        action: defaultAction,
        ...propsData,
      },
      stubs: {
        GlCollapsibleListbox,
        GlSprintf,
      },
    });
  };

  const findCustomizeListbox = () => wrapper.findByTestId('override-type');
  const findSeverityListbox = () => wrapper.findByTestId('severity-type');

  describe('default state', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('renders customize dropdown', () => {
      expect(findCustomizeListbox().exists()).toBe(true);
      expect(findCustomizeListbox().props('selected')).toBe('');
      expect(findCustomizeListbox().props('toggleText')).toBe('Select customize type');
    });

    it('does not render severity dropdown when customize is not set_to', () => {
      expect(findCustomizeListbox().exists()).toBe(true);
      expect(findSeverityListbox().exists()).toBe(false);
    });

    it('emits select event when customize is selected', () => {
      findCustomizeListbox().vm.$emit('select', 'increase_by_one');

      expect(wrapper.emitted('select')).toEqual([
        [{ ...defaultAction, customize: 'increase_by_one' }],
      ]);
    });
  });

  describe('with set_to selected', () => {
    const actionWithSetTo = { type: 'override', customize: 'set_to' };

    beforeEach(() => {
      createWrapper({ propsData: { action: actionWithSetTo } });
    });

    it('renders severity dropdown when customize is set_to', () => {
      expect(findSeverityListbox().exists()).toBe(true);
      expect(findSeverityListbox().props('selected')).toBe('');
      expect(findSeverityListbox().props('toggleText')).toBe('Select severity level');
    });

    it('emits select event with severity when severity is selected', () => {
      findSeverityListbox().vm.$emit('select', 'high');

      expect(wrapper.emitted('select')).toEqual([[{ ...actionWithSetTo, severity: 'high' }]]);
    });

    it('removes severity when switching from set_to to another customize type', () => {
      const actionWithSeverity = { ...actionWithSetTo, severity: 'high' };
      createWrapper({ propsData: { action: actionWithSeverity } });

      findCustomizeListbox().vm.$emit('select', 'increase_by_one');

      expect(wrapper.emitted('select')).toEqual([
        [{ type: 'override', customize: 'increase_by_one' }],
      ]);
    });
  });

  describe('with severity selected', () => {
    const actionWithSeverity = { type: 'override', customize: 'set_to', severity: 'critical' };

    beforeEach(() => {
      createWrapper({ propsData: { action: actionWithSeverity } });
    });

    it('renders severity dropdown with selected value', () => {
      expect(findSeverityListbox().props('selected')).toBe('critical');
      expect(findSeverityListbox().props('toggleText')).toBe('Critical');
    });
  });

  describe('customize options', () => {
    it.each`
      customize            | expectedText
      ${'set_to'}          | ${'Set to'}
      ${'increase_by_one'} | ${'Increase by one level'}
      ${'decrease_by_one'} | ${'Decrease by one level'}
    `('displays $expectedText for $customize', ({ customize, expectedText }) => {
      createWrapper({ propsData: { action: { ...defaultAction, customize } } });

      expect(findCustomizeListbox().props('toggleText')).toBe(expectedText);
    });
  });
});
