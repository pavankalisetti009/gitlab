import { GlSprintf } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import ActionSection from 'ee/security_orchestration/components/policy_editor/vulnerability_management/action/action_section.vue';
import DismissAction from 'ee/security_orchestration/components/policy_editor/vulnerability_management/action/dismiss_action.vue';
import ResolvedAction from 'ee/security_orchestration/components/policy_editor/vulnerability_management/action/resolved_action.vue';
import OverrideRule from 'ee/security_orchestration/components/policy_editor/vulnerability_management/action/override_rule.vue';
import { mockVulnerabilityManagementObject } from 'ee_jest/security_orchestration/mocks/mock_vulnerability_management_policy_data';

describe('ActionSection', () => {
  let wrapper;

  const defaultActions = mockVulnerabilityManagementObject.actions;

  const factory = (actions = defaultActions, provide = {}) => {
    wrapper = shallowMountExtended(ActionSection, {
      propsData: {
        actions,
      },
      stubs: {
        GlSprintf,
      },
      provide,
    });
  };

  const findResolveAction = () => wrapper.findComponent(ResolvedAction);
  const findDismissAction = () => wrapper.findComponent(DismissAction);
  const findOverrideAction = () => wrapper.findComponent(OverrideRule);

  describe('resolve action', () => {
    beforeEach(() => {
      factory();
    });

    it('renders resolve action by default', () => {
      expect(findResolveAction().exists()).toBe(true);
      expect(findDismissAction().exists()).toBe(false);
      expect(findOverrideAction().exists()).toBe(false);
    });
  });

  describe('dismiss action', () => {
    beforeEach(() => {
      factory([{ ...defaultActions[0], type: 'auto_dismiss' }]);
    });

    it('does not renders resolve action with feature flag is off', () => {
      expect(findDismissAction().exists()).toBe(false);
      expect(findResolveAction().exists()).toBe(true);
    });

    it('renders resolve action with feature flag is on', () => {
      factory([{ ...defaultActions[0], type: 'auto_dismiss' }], {
        glFeatures: { autoDismissVulnerabilityPolicies: true },
      });
      expect(findDismissAction().exists()).toBe(true);
      expect(findResolveAction().exists()).toBe(false);
    });
  });

  describe('override action', () => {
    const overrideAction = { type: 'override', customize: '' };

    it('does not render override action when feature flag is off', () => {
      factory([overrideAction]);

      expect(findOverrideAction().exists()).toBe(false);
      expect(findResolveAction().exists()).toBe(true);
    });

    it('renders override action when feature flag is on', () => {
      factory([overrideAction], {
        glFeatures: { securityPoliciesSeverityCustomize: true },
      });

      expect(findOverrideAction().exists()).toBe(true);
      expect(findResolveAction().exists()).toBe(false);
      expect(findDismissAction().exists()).toBe(false);
    });

    it('passes correct props to override action', () => {
      factory([overrideAction], {
        glFeatures: { securityPoliciesSeverityCustomize: true },
      });

      expect(findOverrideAction().props('action')).toEqual(overrideAction);
    });

    it('emits select event when override action emits select', () => {
      factory([overrideAction], {
        glFeatures: { securityPoliciesSeverityCustomize: true },
      });

      const updatedAction = { ...overrideAction, customize: 'set_to' };
      findOverrideAction().vm.$emit('select', updatedAction);

      expect(wrapper.emitted('select')).toEqual([[updatedAction]]);
    });
  });
});
