import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import ExploitSettingsSection from 'ee/security_orchestration/components/policy_editor/scan_result/rule/scanners/exploit_settings_section.vue';
import SectionLayout from 'ee/security_orchestration/components/policy_editor/section_layout.vue';
import KevFilter from 'ee/security_orchestration/components/policy_editor/scan_result/rule/scan_filters/kev_filter.vue';
import EpssFilter from 'ee/security_orchestration/components/policy_editor/scan_result/rule/scan_filters/epss_filter.vue';

describe('ExploitSettingsSection', () => {
  let wrapper;

  const createComponent = (props = {}) => {
    wrapper = shallowMountExtended(ExploitSettingsSection, {
      propsData: {
        ...props,
      },
    });
  };

  const findSectionLayout = () => wrapper.findComponent(SectionLayout);
  const findKevFilter = () => wrapper.findComponent(KevFilter);
  const findEpssFilter = () => wrapper.findComponent(EpssFilter);
  const findTitle = () => wrapper.find('h5');

  describe('rendering', () => {
    it('renders all components correctly', () => {
      createComponent();

      expect(findSectionLayout().exists()).toBe(true);
      expect(findKevFilter().exists()).toBe(true);
      expect(findEpssFilter().exists()).toBe(true);
    });

    it('renders the exploit settings title', () => {
      createComponent();

      expect(findTitle().text()).toBe('Exploit settings');
    });
  });

  describe('props', () => {
    it('passes kevFilterValue to KevFilter', () => {
      createComponent({ kevFilterValue: true });

      expect(findKevFilter().props('selected')).toBe(true);
    });

    it('passes epssOperator to EpssFilter', () => {
      createComponent({ epssOperator: 'greater_than' });

      expect(findEpssFilter().props('selectedOperator')).toBe('greater_than');
    });

    it('passes epssValue to EpssFilter', () => {
      createComponent({ epssValue: 0.5 });

      expect(findEpssFilter().props('selectedValue')).toBe(0.5);
    });

    it('defaults epssValue to 0', () => {
      createComponent();

      expect(findEpssFilter().props('selectedValue')).toBe(0);
    });
  });

  describe('events', () => {
    beforeEach(() => {
      createComponent();
    });

    it('emits kev-change event when KevFilter emits select', () => {
      findKevFilter().vm.$emit('select', true);

      expect(wrapper.emitted('kev-change')).toHaveLength(1);
      expect(wrapper.emitted('kev-change')[0][0]).toBe(true);
    });

    it('emits epss-change event when EpssFilter emits select', () => {
      const epssValue = { operator: 'greater_than', value: 0.5 };

      findEpssFilter().vm.$emit('select', epssValue);

      expect(wrapper.emitted('epss-change')).toHaveLength(1);
      expect(wrapper.emitted('epss-change')[0][0]).toEqual(epssValue);
    });
  });
});
