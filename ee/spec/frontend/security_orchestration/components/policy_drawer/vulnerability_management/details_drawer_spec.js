import VulnerabilityManagementDrawer from 'ee/security_orchestration/components/policy_drawer/vulnerability_management/details_drawer.vue';
import PolicyDrawerLayout from 'ee/security_orchestration/components/policy_drawer/drawer_layout.vue';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import { NAMESPACE_TYPES } from 'ee/security_orchestration/constants';
import { mockProjectVulnerabilityManagementPolicy } from 'ee_jest/security_orchestration/mocks/mock_vulnerability_management_policy_data';

describe('VulnerabilityManagementDrawer', () => {
  let wrapper;

  const findPolicyDrawerLayout = () => wrapper.findComponent(PolicyDrawerLayout);

  const createComponent = ({ propsData } = {}) => {
    wrapper = shallowMountExtended(VulnerabilityManagementDrawer, {
      propsData,
      provide: { namespaceType: NAMESPACE_TYPES.PROJECT },
      stubs: {
        PolicyDrawerLayout,
      },
    });
  };

  describe('policy drawer layout props', () => {
    it('passes the policy to the PolicyDrawerLayout component', () => {
      createComponent({ propsData: { policy: mockProjectVulnerabilityManagementPolicy } });
      expect(findPolicyDrawerLayout().props('policy')).toEqual(
        mockProjectVulnerabilityManagementPolicy,
      );
    });

    it('passes the description to the PolicyDrawerLayout component', () => {
      createComponent({ propsData: { policy: mockProjectVulnerabilityManagementPolicy } });
      expect(findPolicyDrawerLayout().props('description')).toBe(
        'Auto-resolves no longer found low severity vulnerabilities',
      );
    });

    it('passes fallback empty description when parsing yaml fails', () => {
      const invalidYamlPolicy = {
        ...mockProjectVulnerabilityManagementPolicy,
        yaml: 'enabled: true\nenabled:true',
      };
      createComponent({ propsData: { policy: invalidYamlPolicy } });
      expect(findPolicyDrawerLayout().props('description')).toBe('');
    });
  });
});
