import { GlButton, GlIcon } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import ProjectVulnerabilityCounts from 'ee/security_inventory/components/project_vulnerability_counts.vue';

describe('ProjectVulnerabilityCounts', () => {
  let wrapper;

  const severityItems = [
    { icon: 'severity-critical', label: 'Critical', value: 10, iconColor: 'gl-text-red-500' },
    { icon: 'severity-high', label: 'High', value: 20, iconColor: 'gl-text-orange-500' },
  ];
  const webUrl = 'project/web/url';

  const createWrapper = (propsData) => {
    wrapper = shallowMountExtended(ProjectVulnerabilityCounts, {
      propsData: {
        severityItems,
        webUrl,
        ...propsData,
      },
    });
  };

  const findIcon = () => wrapper.findComponent(GlIcon);
  const findButton = () => wrapper.findComponent(GlButton);
  const findAllById = (id) => wrapper.findAllByTestId(id);
  const findSeverityProps = (item) => {
    const icon = item.find('[data-testid="severity-icon"]');
    const label = item.find('[data-testid="severity-label"]');
    const value = item.find('[data-testid="severity-value"]');
    return { icon, label, value };
  };

  describe('default behavior', () => {
    beforeEach(() => {
      createWrapper();
    });

    it('renders components', () => {
      expect(findButton().exists()).toBe(true);
      expect(findIcon().exists()).toBe(true);
    });

    it('renders the correct number of severity items', () => {
      expect(findAllById('severity-item')).toHaveLength(severityItems.length);
    });

    it('renders each severity item with the correct icon, label, and value', () => {
      severityItems.forEach((item, index) => {
        const currentItem = findAllById('severity-item').at(index);
        const { icon, label, value } = findSeverityProps(currentItem);
        expect(icon.props('name')).toBe(item.icon);
        expect(label.text()).toContain(item.label);
        expect(value.text()).toBe(String(item.value));
      });
    });

    it('renders the "View vulnerability report" button with correct text', () => {
      expect(findButton().exists()).toBe(true);
      expect(findButton().text()).toBe('View vulnerability report');
    });
  });

  describe('when value is undefined or null', () => {
    const edgeCases = [
      {
        icon: 'severity-medium',
        label: 'Medium',
        value: undefined,
        iconColor: 'gl-text-yellow-500',
      },
      { icon: 'severity-low', label: 'Low', value: null, iconColor: 'gl-text-blue-500' },
    ];

    beforeEach(() => {
      createWrapper({ severityItems: edgeCases });
    });

    it('renders items with value undefined or null', () => {
      edgeCases.forEach((itemData, index) => {
        const currentItem = findAllById('severity-item').at(index);
        const { icon, label, value } = findSeverityProps(currentItem);

        expect(icon.props('name')).toBe(itemData.icon);
        expect(label.text()).toContain(itemData.label);
        expect(value.text()).toBe('');
      });
    });
  });

  describe('when no severity items exist', () => {
    beforeEach(() => {
      createWrapper({ severityItems: [] });
    });

    it('renders no severity items', () => {
      const items = findAllById('severity-item');
      expect(items.length).toBe(0);
    });

    it('still renders the "View vulnerability report" button', () => {
      expect(findButton().exists()).toBe(true);
      expect(findButton().text()).toBe('View vulnerability report');
    });
  });
});
