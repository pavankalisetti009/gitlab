import { GlLink, GlAlert, GlSprintf } from '@gitlab/ui';
import Vue, { nextTick } from 'vue';
import VueApollo from 'vue-apollo';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import SelectionSummary from 'ee/security_dashboard/components/shared/vulnerability_report/selection_summary.vue';
import BulkChangeStatus from 'ee/security_dashboard/components/shared/vulnerability_report/bulk_change_status.vue';

Vue.use(VueApollo);

describe('Selection Summary component', () => {
  let wrapper;

  const findGlAlert = () => wrapper.findComponent(GlAlert);
  const findSelectedVulnerabilities = () => wrapper.findByTestId('selected-vulnerabilities');
  const findBulkChangeStatus = () => wrapper.findComponent(BulkChangeStatus);

  const createComponent = ({ selectedVulnerabilities = [] } = {}) => {
    wrapper = shallowMountExtended(SelectionSummary, {
      stubs: {
        GlAlert,
        GlSprintf,
        GlLink,
      },
      propsData: {
        selectedVulnerabilities,
      },
    });
  };

  describe('with 1 vulnerability selected', () => {
    const selectedVulnerabilities = [{ id: 'id_0' }];

    beforeEach(() => {
      createComponent({ selectedVulnerabilities });
    });

    it('renders correctly', () => {
      expect(findSelectedVulnerabilities().text()).toBe('1 Selected');
      expect(findBulkChangeStatus().exists()).toBe(true);
      expect(findBulkChangeStatus().props()).toEqual({
        selectedVulnerabilities,
        rejectedVulnerabilities: [],
      });
    });
  });

  describe('with multiple vulnerabilities selected', () => {
    beforeEach(() => {
      createComponent({ selectedVulnerabilities: [{ id: 'id_0' }, { id: 'id_1' }] });
    });

    it('renders correctly', () => {
      expect(findSelectedVulnerabilities().text()).toBe('2 Selected');
    });
  });

  it(`bubbles 'vulnerabilities-updated' event`, () => {
    createComponent({});
    findBulkChangeStatus().vm.$emit('vulnerabilities-updated', [1]);
    expect(wrapper.emitted('vulnerabilities-updated')).toEqual([[[1]]]);
  });

  describe('rejected vulnerabilities', () => {
    const selectedVulnerabilities = [
      { id: 'gid://gitlab/Vulnerability/54' },
      { id: 'gid://gitlab/Vulnerability/56' },
      { id: 'gid://gitlab/Vulnerability/58' },
    ];

    beforeEach(() => {
      createComponent({ selectedVulnerabilities });
    });

    it('shows rejected vulnerabilities in alert', async () => {
      findBulkChangeStatus().vm.$emit('update-rejected', [
        { id: 'gid://gitlab/Vulnerability/54' },
        { id: 'gid://gitlab/Vulnerability/56' },
      ]);
      await nextTick();

      expect(findGlAlert().text()).toMatchInterpolatedText(
        'Failed updating vulnerabilities with the following IDs: 54, 56',
      );
    });

    it(`clears alert message when 'cancel' event is emitted`, async () => {
      findBulkChangeStatus().vm.$emit('update-rejected', [
        { id: 'gid://gitlab/Vulnerability/54' },
        { id: 'gid://gitlab/Vulnerability/56' },
      ]);
      findBulkChangeStatus().vm.$emit('cancel');
      await nextTick();

      expect(findGlAlert().exists()).toBe(false);
      expect(wrapper.emitted('cancel-selection')).toHaveLength(1);
    });
  });
});
