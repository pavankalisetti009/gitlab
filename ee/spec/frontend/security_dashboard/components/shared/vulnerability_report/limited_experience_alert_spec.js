import { GlAlert, GlLink, GlSprintf } from '@gitlab/ui';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import LimitedExperienceAlert from 'ee/security_dashboard/components/shared/vulnerability_report/limited_experience_alert.vue';
import { helpPagePath } from '~/helpers/help_page_helper';
import { makeMockUserCalloutDismisser } from 'helpers/mock_user_callout_dismisser';

describe('LimitedExperienceAlert component', () => {
  let wrapper;
  let userCalloutDismissSpy;

  const findAlert = () => wrapper.findComponent(GlAlert);
  const findLink = () => wrapper.findComponent(GlLink);

  const createWrapper = ({ shouldShowCallout = false } = {}) => {
    userCalloutDismissSpy = jest.fn();

    wrapper = shallowMountExtended(LimitedExperienceAlert, {
      stubs: {
        GlSprintf,
        UserCalloutDismisser: makeMockUserCalloutDismisser({
          dismiss: userCalloutDismissSpy,
          shouldShowCallout,
        }),
      },
    });
  };

  describe('when shouldShowCallout is true', () => {
    beforeEach(() => {
      createWrapper({ shouldShowCallout: true });
    });

    it('displays the alert', () => {
      expect(findAlert().exists()).toBe(true);
    });

    it('displays the correct title', () => {
      expect(wrapper.text()).toContain('Limited experience available');
    });

    it('displays the correct message', () => {
      expect(wrapper.text()).toContain(
        'Your environment does not have advanced vulnerability management enabled which limits some functionality.',
      );
    });

    it('displays a link to the vulnerability report page at advanced vulnerability management', () => {
      expect(findLink().exists()).toBe(true);
      expect(findLink().attributes('href')).toBe(
        helpPagePath('user/application_security/vulnerability_report/_index.md', {
          anchor: 'advanced-vulnerability-management',
        }),
      );
      expect(findLink().text()).toBe('How do I enable advanced vulnerability management?');
    });

    it('calls dismiss when the alert is dismissed', () => {
      findAlert().vm.$emit('dismiss');

      expect(userCalloutDismissSpy).toHaveBeenCalled();
    });
  });

  describe('when shouldShowCallout is false', () => {
    beforeEach(() => {
      createWrapper({ shouldShowCallout: false });
    });

    it('does not display the alert', () => {
      expect(findAlert().exists()).toBe(false);
    });
  });
});
