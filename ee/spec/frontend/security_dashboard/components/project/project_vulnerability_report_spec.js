import Vue from 'vue';
import VueRouter from 'vue-router';
import { GlAlert } from '@gitlab/ui';
import ProjectVulnerabilityReport from 'ee/security_dashboard/components/project/project_vulnerability_report.vue';
import VulnerabilityReportTabs from 'ee/security_dashboard/components/shared/vulnerability_report/vulnerability_report_tabs.vue';
import VulnerabilityReportTab from 'ee/security_dashboard/components/shared/vulnerability_report/vulnerability_report_tab.vue';
import ProjectPipelineStatus from 'ee/security_dashboard/components/shared/project_pipeline_status.vue';
import VulnerabilityRetentionAlert from 'ee/security_dashboard/components/shared/vulnerability_retention_alert.vue';
import { DASHBOARD_TYPE_PROJECT } from 'ee/security_dashboard/constants';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';

Vue.use(VueRouter);
const router = new VueRouter();

const examplePipeline = { id: 1, createdAt: 'now', path: 'path' };

describe('Project vulnerability report app component', () => {
  let wrapper;

  const createWrapper = ({
    pipeline = examplePipeline,
    sbomPipeline = examplePipeline,
    vulnerabilityQuota,
  } = {}) => {
    wrapper = shallowMountExtended(ProjectVulnerabilityReport, {
      router,
      provide: {
        pipeline,
        sbomPipeline,
        dashboardType: DASHBOARD_TYPE_PROJECT,
        vulnerabilityQuota,
      },
      stubs: {
        VulnerabilityReportTabs,
        VulnerabilityReportTab,
      },
    });
  };

  const findVulnerabilityReportTabs = () => wrapper.findComponent(VulnerabilityReportTabs);
  const findProjectPipelineStatus = () => wrapper.findComponent(ProjectPipelineStatus);
  const findVulnerabilityRetentionAlert = () => wrapper.findComponent(VulnerabilityRetentionAlert);

  describe('report not configured component', () => {
    it('shows the report if there is no pipeline and no vulnerabilities', () => {
      createWrapper({ pipeline: {}, hasVulnerabilities: false });

      expect(findVulnerabilityReportTabs().exists()).toBe(true);
    });

    it.each`
      pipeline           | hasVulnerabilities
      ${examplePipeline} | ${false}
      ${{}}              | ${true}
      ${examplePipeline} | ${true}
    `(
      'shows the report if pipeline is $pipeline and hasVulnerabilities is $hasVulnerabilities',
      ({ pipeline, hasVulnerabilities }) => {
        createWrapper({ pipeline, hasVulnerabilities });

        expect(findVulnerabilityReportTabs().exists()).toBe(true);
      },
    );
  });

  describe('quota warning', () => {
    const findQuotaWarning = () => wrapper.findComponent(GlAlert);

    it.each`
      quotaStatus   | expectedMessage
      ${'full'}     | ${'This project has reached the maximum number of vulnerabilities it can contain. New vulnerabilities will not be created.'}
      ${'critical'} | ${'This project is reaching the maximum number of vulnerabilities it can contain.'}
      ${'exceeded'} | ${"This project has reached the maximum number of vulnerabilities it can contain and some of the vulnerabilities couldn't be ingested."}
    `(
      'displays a warning message when quota status is $quotaStatus',
      ({ quotaStatus, expectedMessage }) => {
        createWrapper({ vulnerabilityQuota: quotaStatus });
        expect(findQuotaWarning().exists()).toBe(true);
        expect(wrapper.findByText(expectedMessage).exists()).toBe(true);
      },
    );

    it('displays no warning message when the vulnerability quota status is not provided', () => {
      createWrapper({ vulnerabilityQuota: '' });
      expect(findQuotaWarning().exists()).toBe(false);
    });
  });

  describe('project pipeline status component', () => {
    it('shows the component if there is a pipeline', () => {
      createWrapper();

      expect(findProjectPipelineStatus().props('pipeline')).toBe(examplePipeline);
    });

    it('does not show the component if there is no pipeline', () => {
      createWrapper({ pipeline: {} });

      expect(findProjectPipelineStatus().exists()).toBe(false);
    });
  });

  it('mounts the retention alert', () => {
    createWrapper();
    expect(findVulnerabilityRetentionAlert().exists()).toBe(true);
  });
});
