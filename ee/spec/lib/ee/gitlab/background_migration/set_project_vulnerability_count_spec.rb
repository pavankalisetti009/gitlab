# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Gitlab::BackgroundMigration::SetProjectVulnerabilityCount, feature_category: :vulnerability_management do
  let!(:user) { table(:users).create!(email: 'author@example.com', username: 'author', projects_limit: 10) }
  let(:scanners) { table(:vulnerability_scanners) }
  let(:namespaces) { table(:namespaces) }
  let(:projects) { table(:projects) }
  let(:project_settings) { table(:project_settings) }
  let(:project_statistics) { table(:project_statistics) }
  let(:vulnerabilities) { table(:vulnerabilities) }
  let(:vulnerability_reads) { table(:vulnerability_reads) }
  let(:vulnerability_occurrences) { table(:vulnerability_occurrences) }
  let(:vulnerability_identifiers) { table(:vulnerability_identifiers) }

  let!(:namespace) { namespaces.create!(name: 'Test Namespace', path: 'namespace-path') }
  let!(:project_namespace_1) { namespaces.create!(name: 'Project Namespace 1', path: 'project_1') }
  let!(:project_namespace_2) { namespaces.create!(name: 'Project Namespace 2', path: 'project_2') }
  let!(:project_namespace_3) { namespaces.create!(name: 'Project Namespace 3', path: 'project_3') }

  let!(:project_1) do
    projects.create!(
      name: "proj1",
      path: "proj1",
      namespace_id: namespace.id,
      project_namespace_id: project_namespace_1.id
    )
  end

  let!(:project_2) do
    projects.create!(
      name: "proj2",
      path: "proj2",
      namespace_id: namespace.id,
      project_namespace_id: project_namespace_2.id
    )
  end

  let!(:project_3) do
    projects.create!(
      name: "proj3",
      path: "proj3",
      namespace_id: namespace.id,
      project_namespace_id: project_namespace_3.id
    )
  end

  let!(:project_statistics_1) do
    project_statistics.create!(project_id: project_1.id, namespace_id: namespace.id, vulnerability_count: 0)
  end

  let!(:project_statistics_2) do
    project_statistics.create!(project_id: project_2.id, namespace_id: namespace.id, vulnerability_count: 0)
  end

  let!(:project_statistics_3) do
    project_statistics.create!(project_id: project_3.id, namespace_id: namespace.id, vulnerability_count: 0)
  end

  let!(:project_settings_1) { project_settings.create!(project_id: project_1.id, has_vulnerabilities: true) }
  let!(:project_settings_2) { project_settings.create!(project_id: project_2.id, has_vulnerabilities: true) }
  let!(:project_settings_3) { project_settings.create!(project_id: project_3.id, has_vulnerabilities: false) }

  let(:migration_instance) do
    described_class.new(
      start_id: project_settings.minimum(:project_id),
      end_id: project_settings.maximum(:project_id),
      batch_table: :project_settings,
      batch_column: :project_id,
      sub_batch_size: 100,
      pause_ms: 0,
      connection: project_settings.connection
    )
  end

  subject(:perform_migration) { migration_instance.perform }

  before do
    scanner_project_1 = scanners.create!(
      project_id: project_1.id,
      external_id: "external-id-1",
      name: "Scanner 1"
    )
    scanner_project_2 = scanners.create!(
      project_id: project_2.id,
      external_id: "external-id-2",
      name: "Scanner 2"
    )
    create_vulnerability_read(project_1.id, scanner_project_1.id)
    create_vulnerability_read(project_1.id, scanner_project_1.id)
    create_vulnerability_read(project_1.id, scanner_project_1.id)
    create_vulnerability_read(project_2.id, scanner_project_2.id)
    create_vulnerability_read(project_2.id, scanner_project_2.id)
  end

  it 'sets the vulnerability_count column' do
    expect do
      perform_migration
      project_statistics_1.reload
      project_statistics_2.reload
      project_statistics_3.reload
    end.to change { project_statistics_1.vulnerability_count }.from(0).to(3)
       .and change { project_statistics_2.vulnerability_count }.from(0).to(2)
       .and not_change { project_statistics_3.vulnerability_count }.from(0)
  end

  def create_vulnerability_read(project_id, scanner_id)
    identifier = vulnerability_identifiers.create!(
      project_id: project_id,
      fingerprint: SecureRandom.bytes(20),
      external_type: "",
      external_id: "",
      name: ""
    )

    finding = vulnerability_occurrences.create!(
      project_id: project_id,
      severity: 1,
      report_type: 1,
      scanner_id: scanner_id,
      primary_identifier_id: identifier.id,
      project_fingerprint: "",
      location_fingerprint: "",
      name: "name",
      metadata_version: "sast:1.0",
      raw_metadata: "",
      uuid: SecureRandom.uuid
    )

    attrs = {
      project_id: project_id,
      author_id: user.id,
      title: 'title',
      severity: 1,
      report_type: 1,
      finding_id: finding.id
    }

    vulnerability = vulnerabilities.create!(attrs)

    vulnerability_reads.create!(
      vulnerability_id: vulnerability.id,
      project_id: project_id,
      scanner_id: scanner_id,
      report_type: vulnerability.report_type,
      severity: vulnerability.severity,
      state: 1,
      uuid: SecureRandom.uuid
    )
  end
end
