# frozen_string_literal: true

require 'spec_helper'

RSpec.describe API::Entities::Security::VulnerabilityScanning::SbomScan, feature_category: :software_composition_analysis do
  let(:sbom_scan) { build_stubbed(:sbom_scan) }

  subject(:output) { described_class.new(sbom_scan).as_json }

  it 'format the sbom_scan as expected', :aggregate_failures do
    expect(output[:id]).to eq(sbom_scan.id)
    expect(output[:download_url]).to end_with("/api/v4/jobs/#{sbom_scan.build_id}/sbom_scans/#{sbom_scan.id}")
    expect(output).not_to have_key(:throttled)
    expect(output).not_to have_key(:project_throttling_resets_in)
  end

  context 'when throttling options are provided' do
    subject(:output) do
      described_class.new(sbom_scan, throttled: true, project_throttling_resets_in: 300).as_json
    end

    it 'includes throttling information', :aggregate_failures do
      expect(output[:throttled]).to be(true)
      expect(output[:project_throttling_resets_in]).to eq(300)
    end
  end

  context 'when throttled is false' do
    subject(:output) do
      described_class.new(sbom_scan, throttled: false, project_throttling_resets_in: 0).as_json
    end

    it 'does not include throttling information', :aggregate_failures do
      expect(output).not_to have_key(:throttled)
      expect(output).not_to have_key(:project_throttling_resets_in)
    end
  end

  context 'when advisory db state is provided' do
    subject(:output) do
      described_class.new(sbom_scan, advisory_db_state: { sync_status: { npm: 123, maven: 456 } }).as_json
    end

    it 'includes this data' do
      expect(output[:advisory_db_state]).to eq({ sync_status: { npm: 123, maven: 456 } })
    end
  end
end
