# frozen_string_literal: true

require 'fast_spec_helper'

RSpec.describe Security::VulnerabilityManagementPolicies::Rule, feature_category: :security_policy_management do
  describe '#type' do
    context 'when type is no_longer_detected' do
      it 'returns no_longer_detected' do
        rule = described_class.new({ type: 'no_longer_detected', scanners: ['sast'], severity_levels: ['low'] })
        expect(rule.type).to eq('no_longer_detected')
      end
    end

    context 'when type is detected' do
      it 'returns detected' do
        rule = described_class.new({ type: 'detected', criteria: [{ type: 'file_path', value: '**/*' }] })
        expect(rule.type).to eq('detected')
      end
    end

    context 'when type is not present' do
      it 'returns nil' do
        rule = described_class.new({ scanners: ['sast'] })
        expect(rule.type).to be_nil
      end
    end
  end

  describe '#scanners' do
    context 'when scanners is present' do
      it 'returns the scanners array' do
        rule = described_class.new({ type: 'no_longer_detected', scanners: %w[sast dast], severity_levels: ['low'] })
        expect(rule.scanners).to match_array(%w[sast dast])
      end

      it 'handles all valid scanner types' do
        scanners = %w[sast secret_detection dependency_scanning container_scanning dast coverage_fuzzing api_fuzzing]
        rule = described_class.new({ type: 'no_longer_detected', scanners: scanners, severity_levels: ['low'] })
        expect(rule.scanners).to match_array(scanners)
      end
    end

    context 'when scanners is not present' do
      it 'returns an empty array' do
        rule = described_class.new({ type: 'no_longer_detected', severity_levels: ['low'] })
        expect(rule.scanners).to eq([])
      end
    end
  end

  describe '#severity_levels' do
    context 'when severity_levels is present' do
      it 'returns the severity_levels array' do
        rule = described_class.new({ type: 'no_longer_detected', scanners: ['sast'], severity_levels: %w[low medium] })
        expect(rule.severity_levels).to match_array(%w[low medium])
      end

      it 'handles all valid severity levels' do
        severity_levels = %w[critical high medium low info unknown]
        rule = described_class.new({ type: 'no_longer_detected', scanners: ['sast'], severity_levels: severity_levels })
        expect(rule.severity_levels).to match_array(severity_levels)
      end
    end

    context 'when severity_levels is not present' do
      it 'returns an empty array' do
        rule = described_class.new({ type: 'no_longer_detected', scanners: ['sast'] })
        expect(rule.severity_levels).to eq([])
      end
    end
  end

  describe '#criteria' do
    context 'when criteria is present' do
      it 'returns an array of criteria hashes' do
        rule = described_class.new({
          type: 'detected',
          criteria: [
            { type: 'file_path', value: '**/*' },
            { type: 'directory', value: 'test/' }
          ]
        })
        expect(rule.criteria).to be_an(Array)
        expect(rule.criteria.length).to eq(2)
        expect(rule.criteria.first).to be_a(Hash)
        expect(rule.criteria.last).to be_a(Hash)
      end

      it 'handles file_path criteria' do
        rule = described_class.new({
          type: 'detected',
          criteria: [{ type: 'file_path', value: 'app/**/*.rb' }]
        })
        criterion = rule.criteria.first
        expect(criterion[:type]).to eq('file_path')
        expect(criterion[:value]).to eq('app/**/*.rb')
      end

      it 'handles directory criteria' do
        rule = described_class.new({
          type: 'detected',
          criteria: [{ type: 'directory', value: 'test/' }]
        })
        criterion = rule.criteria.first
        expect(criterion[:type]).to eq('directory')
        expect(criterion[:value]).to eq('test/')
      end

      it 'handles identifier criteria' do
        rule = described_class.new({
          type: 'detected',
          criteria: [{ type: 'identifier', value: 'CVE-2025-12345' }]
        })
        criterion = rule.criteria.first
        expect(criterion[:type]).to eq('identifier')
        expect(criterion[:value]).to eq('CVE-2025-12345')
      end
    end

    context 'when criteria is not present' do
      it 'returns an empty array' do
        rule = described_class.new({ type: 'detected' })
        expect(rule.criteria).to eq([])
      end
    end
  end

  describe 'no_longer_detected type rule' do
    it 'handles complete no_longer_detected rule' do
      rule_data = {
        type: 'no_longer_detected',
        scanners: %w[sast dependency_scanning],
        severity_levels: %w[low medium]
      }
      rule = described_class.new(rule_data)

      expect(rule.type).to eq('no_longer_detected')
      expect(rule.scanners).to match_array(%w[sast dependency_scanning])
      expect(rule.severity_levels).to match_array(%w[low medium])
      expect(rule.criteria).to be_empty
    end
  end

  describe 'detected type rule' do
    it 'handles complete detected rule with criteria' do
      rule_data = {
        type: 'detected',
        criteria: [
          { type: 'file_path', value: 'app/**/*.rb' },
          { type: 'identifier', value: 'CVE-2025-*' }
        ]
      }
      rule = described_class.new(rule_data)

      expect(rule.type).to eq('detected')
      expect(rule.criteria.length).to eq(2)
      expect(rule.criteria.first[:type]).to eq('file_path')
      expect(rule.criteria.first[:value]).to eq('app/**/*.rb')
      expect(rule.criteria.last[:type]).to eq('identifier')
      expect(rule.criteria.last[:value]).to eq('CVE-2025-*')
      expect(rule.scanners).to be_empty
      expect(rule.severity_levels).to be_empty
    end
  end
end
