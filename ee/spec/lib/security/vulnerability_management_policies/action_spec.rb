# frozen_string_literal: true

require 'fast_spec_helper'

RSpec.describe Security::VulnerabilityManagementPolicies::Action, feature_category: :security_policy_management do
  describe '#type' do
    context 'when type is present' do
      it 'returns the type value' do
        action = described_class.new({ type: 'auto_dismiss', dismissal_reason: 'false_positive' })
        expect(action.type).to eq('auto_dismiss')
      end

      it 'handles auto_resolve type' do
        action = described_class.new({ type: 'auto_resolve' })
        expect(action.type).to eq('auto_resolve')
      end
    end

    context 'when type is not present' do
      it 'returns nil' do
        action = described_class.new({ dismissal_reason: 'false_positive' })
        expect(action.type).to be_nil
      end
    end
  end

  describe '#dismissal_reason' do
    context 'when dismissal_reason is present' do
      it 'returns the dismissal_reason value' do
        action = described_class.new({ type: 'auto_dismiss', dismissal_reason: 'false_positive' })
        expect(action.dismissal_reason).to eq('false_positive')
      end

      it 'handles all valid dismissal reasons' do
        %w[acceptable_risk false_positive mitigating_control used_in_tests not_applicable].each do |reason|
          action = described_class.new({ type: 'auto_dismiss', dismissal_reason: reason })
          expect(action.dismissal_reason).to eq(reason)
        end
      end
    end

    context 'when dismissal_reason is not present' do
      it 'returns nil' do
        action = described_class.new({ type: 'auto_resolve' })
        expect(action.dismissal_reason).to be_nil
      end
    end
  end

  describe 'complete action' do
    it 'handles action with all fields' do
      action_data = {
        type: 'auto_dismiss',
        dismissal_reason: 'false_positive'
      }
      action = described_class.new(action_data)

      expect(action.type).to eq('auto_dismiss')
      expect(action.dismissal_reason).to eq('false_positive')
    end

    it 'handles action with only type field' do
      action_data = {
        type: 'auto_resolve'
      }
      action = described_class.new(action_data)

      expect(action.type).to eq('auto_resolve')
      expect(action.dismissal_reason).to be_nil
    end

    context 'when action is nil' do
      it 'handles nil gracefully' do
        action = described_class.new(nil)
        expect(action.type).to be_nil
        expect(action.dismissal_reason).to be_nil
      end
    end
  end
end
