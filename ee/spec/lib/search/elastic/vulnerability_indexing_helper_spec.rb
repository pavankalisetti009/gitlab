# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Search::Elastic::VulnerabilityIndexingHelper, feature_category: :vulnerability_management do
  describe '.vulnerability_indexing_allowed?' do
    let(:elasticsearch_indexing) { true }
    let(:advanced_search_available) { true }

    before do
      # Reset the memoized value before each test
      described_class.instance_variable_set(:@vulnerability_indexing_allowed, nil)

      allow(Gitlab::CurrentSettings).to receive(:elasticsearch_indexing?).and_return(elasticsearch_indexing)
      allow(Gitlab::Saas).to receive(:feature_available?).with(:advanced_search).and_return(advanced_search_available)
    end

    context 'when elasticsearch indexing is enabled and advanced search is available' do
      it 'returns true' do
        expect(described_class.vulnerability_indexing_allowed?).to be(true)
      end
    end

    context 'when elasticsearch indexing is disabled' do
      let(:elasticsearch_indexing) { false }

      it 'returns false' do
        expect(described_class.vulnerability_indexing_allowed?).to be(false)
      end
    end

    context 'when advanced search is not available' do
      let(:advanced_search_available) { false }

      it 'returns false' do
        expect(described_class.vulnerability_indexing_allowed?).to be(false)
      end
    end

    context 'when both elasticsearch indexing is disabled and advanced search is not available' do
      let(:elasticsearch_indexing) { false }
      let(:advanced_search_available) { false }

      it 'returns false' do
        expect(described_class.vulnerability_indexing_allowed?).to be(false)
      end
    end
  end
end
