# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Search::Elastic::VulnerabilityIndexingHelper, feature_category: :vulnerability_management do
  describe '.vulnerability_indexing_allowed?' do
    before do
      # Reset the memoized value before each test
      described_class.instance_variable_set(:@vulnerability_indexing_allowed, nil)

      # Default all conditions to false
      allow(Gitlab::Saas).to receive(:feature_available?).with(:advanced_search).and_return(false)
      allow(Gitlab::CurrentSettings).to receive_messages(elasticsearch_indexing?: false,
        gitlab_dedicated_instance?: false)
    end

    context 'when SaaS with Elasticsearch is configured' do
      before do
        allow(Gitlab::CurrentSettings).to receive(:elasticsearch_indexing?).and_return(true)
        allow(Gitlab::Saas).to receive(:feature_available?).with(:advanced_search).and_return(true)
      end

      it 'returns true' do
        expect(described_class.vulnerability_indexing_allowed?).to be(true)
      end
    end

    context 'when dedicated instance with Elasticsearch is configured' do
      before do
        allow(Gitlab::CurrentSettings).to receive_messages(elasticsearch_indexing?: true,
          gitlab_dedicated_instance?: true)
      end

      it 'returns true' do
        expect(described_class.vulnerability_indexing_allowed?).to be(true)
      end
    end

    context 'when both SaaS and dedicated instance conditions are true' do
      before do
        allow(Gitlab::Saas).to receive(:feature_available?).with(:advanced_search).and_return(true)
        allow(Gitlab::CurrentSettings).to receive_messages(elasticsearch_indexing?: true,
          gitlab_dedicated_instance?: true)
      end

      it 'returns true' do
        expect(described_class.vulnerability_indexing_allowed?).to be(true)
      end
    end

    context 'when elasticsearch indexing is disabled' do
      before do
        allow(Gitlab::CurrentSettings).to receive(:elasticsearch_indexing?).and_return(false)
      end

      context 'when SaaS advanced search is available' do
        before do
          allow(Gitlab::Saas).to receive(:feature_available?).with(:advanced_search).and_return(true)
        end

        it 'returns false' do
          expect(described_class.vulnerability_indexing_allowed?).to be(false)
        end
      end

      context 'when it is a GitLab dedicated instance' do
        before do
          allow(Gitlab::CurrentSettings).to receive(:gitlab_dedicated_instance?).and_return(true)
        end

        it 'returns false' do
          expect(described_class.vulnerability_indexing_allowed?).to be(false)
        end
      end
    end

    context 'when neither SaaS nor dedicated instance conditions are met' do
      context 'when elasticsearch indexing is enabled' do
        before do
          allow(Gitlab::CurrentSettings).to receive(:elasticsearch_indexing?).and_return(true)
        end

        it 'returns false' do
          expect(described_class.vulnerability_indexing_allowed?).to be(false)
        end
      end

      context 'when elasticsearch indexing is disabled' do
        it 'returns false' do
          expect(described_class.vulnerability_indexing_allowed?).to be(false)
        end
      end
    end
  end
end
