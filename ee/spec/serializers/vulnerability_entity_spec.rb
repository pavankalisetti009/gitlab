# frozen_string_literal: true

require 'spec_helper'

RSpec.describe VulnerabilityEntity do
  let(:vulnerability) { create(:vulnerability, project: project, author: user) }
  let(:project) { create(:project) }
  let(:user) { create(:user) }

  subject { described_class.new(vulnerability).as_json }

  it 'exposes vulnerability-specific elements' do
    expect(subject).to include(
      id: vulnerability.id,
      title: vulnerability.title,
      state: vulnerability.state,
      severity: vulnerability.severity,
      report_type: vulnerability.report_type,
      resolved_on_default_branch: vulnerability.resolved_on_default_branch,
      project_default_branch: vulnerability.project_default_branch,
      resolved_at: vulnerability.resolved_at,
      resolved_by_id: vulnerability.resolved_by_id,
      dismissed_at: vulnerability.dismissed_at,
      dismissed_by_id: vulnerability.dismissed_by_id,
      confirmed_at: vulnerability.confirmed_at,
      confirmed_by_id: vulnerability.confirmed_by_id,
      detected_at: vulnerability.created_at,
      reachability: vulnerability.reachability
    )
  end

  it 'exposes state_transitions, issue_links and merge_request_links' do
    expect(subject).to include(:state_transitions, :issue_links, :merge_request_links)
  end

  context 'with dependency_paths' do
    let(:vulnerability) { create(:vulnerability, report_type: 'dependency_scanning', project: project) }
    let_it_be(:component_1) { create(:sbom_component, name: "activestorage") }
    let_it_be(:component_version_1) { create(:sbom_component_version, component: component_1, version: '1.2.3') }

    let_it_be(:component_2) { create(:sbom_component, name: "activesupport") }
    let_it_be(:component_version_2) { create(:sbom_component_version, component: component_2, version: '1.2.3') }

    let(:occurrence) do
      create(
        :sbom_occurrence,
        vulnerabilities: [vulnerability],
        component_version: component_version_1,
        component: component_1,
        project: project,
        ancestors: [{ name: component_2.name, version: component_version_2.version }]
      )
    end

    let(:paths) do
      [{
        path: [
          { name: component_2.name, version: component_version_2.version },
          { name: component_1.name, version: component_version_1.version }
        ],
        is_cyclic: false,
        max_depth_reached: false
      }]
    end

    before do
      vulnerability.sbom_occurrences = [occurrence]
    end

    it 'exposes dependency_paths and dependency_paths_limit_exceeded' do
      expect(subject).to include(
        dependency_paths: paths,
        dependency_paths_limit_exceeded: false
      )
    end
  end
end
