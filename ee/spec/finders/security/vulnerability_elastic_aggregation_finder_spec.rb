# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Security::VulnerabilityElasticAggregationFinder, :elastic_clean, :sidekiq_inline, feature_category: :vulnerability_management do
  let_it_be_with_reload(:project) { create(:project) }

  let_it_be(:low_severity_vuln_read) do
    create(
      :vulnerability,
      :with_finding, :with_issue_links, :with_merge_request_links,
      severity: :low,
      report_type: :sast,
      state: :detected,
      project: project
    ).vulnerability_read.tap { |read| read.update!(has_vulnerability_resolution: true) }
  end

  let_it_be(:high_severity_vuln_read) do
    create(:vulnerability, :with_finding, resolved_on_default_branch: true, severity: :high,
      report_type: :dependency_scanning, state: :confirmed, project: project).vulnerability_read
  end

  let_it_be(:medium_severity_vuln_read) do
    create(:vulnerability, :with_finding, severity: :medium, report_type: :dast, state: :dismissed,
      project: project).vulnerability_read
  end

  let(:params) { {} }
  let(:vulnerable) { project }

  subject(:execute) { described_class.new(vulnerable, params).execute(aggregation) }

  before do
    stub_ee_application_setting(elasticsearch_search: true, elasticsearch_indexing: true)
  end

  describe '#execute' do
    context "when aggregation is count_by_severity" do
      let(:aggregation) { :count_by_severity }

      before do
        Elastic::ProcessBookkeepingService.track!(
          low_severity_vuln_read,
          high_severity_vuln_read,
          medium_severity_vuln_read
        )
        ensure_elasticsearch_index!
      end

      it "fetches count by each severity" do
        is_expected.to eq("low" => 1, "medium" => 1, "high" => 1)
      end

      it_behaves_like 'a vulnerability elastic finder'
    end
  end

  context "when aggregation is search_identifier_name" do
    let_it_be(:vulnerability_read_1) do
      create(:vulnerability_read, identifier_names: ['CWE-23'], project: project)
    end

    let_it_be(:vulnerability_read_2) do
      create(:vulnerability_read, identifier_names: ['CWE-25'], project: project)
    end

    let_it_be(:vulnerability_read_3) do
      create(:vulnerability_read, identifier_names: %w[CWE-24 test], project: project)
    end

    let_it_be(:vulnerability_read_4) do
      create(:vulnerability_read, identifier_names: ['CWE-26'], project: project)
    end

    let(:aggregation) { :search_identifier_name }
    let(:params) { { partial_identifier_name: "CWE" } }

    before do
      Elastic::ProcessBookkeepingService.track!(
        vulnerability_read_1, vulnerability_read_2, vulnerability_read_3, vulnerability_read_4
      )
      ensure_elasticsearch_index!
    end

    it "fetches unique identifer names" do
      is_expected.to match_array(%w[CWE-23 CWE-25 CWE-24 CWE-26])
    end

    it_behaves_like 'a vulnerability elastic finder'
  end
end
