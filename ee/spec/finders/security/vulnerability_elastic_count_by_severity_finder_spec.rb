# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Security::VulnerabilityElasticCountBySeverityFinder, :elastic_delete_by_query, :sidekiq_inline, feature_category: :vulnerability_management do
  let_it_be_with_reload(:project) { create(:project) }

  let_it_be(:low_severity_vulnerability) do
    create(
      :vulnerability,
      :with_finding, :with_issue_links, :with_merge_request_links,
      severity: :low,
      report_type: :sast,
      state: :detected,
      project: project
    )
  end

  let_it_be(:high_severity_vulnerability) do
    create(:vulnerability, :with_finding, resolved_on_default_branch: true, severity: :high,
      report_type: :dependency_scanning, state: :confirmed, project: project)
  end

  let_it_be(:medium_severity_vulnerability) do
    create(:vulnerability, :with_finding, severity: :medium, report_type: :dast, state: :dismissed,
      project: project)
  end

  let(:params) { {} }

  subject(:execute) { described_class.new(project, params).execute }

  before do
    stub_ee_application_setting(elasticsearch_search: true, elasticsearch_indexing: true)
    # Ensure the migration is marked as completed so age stats are included
    set_elasticsearch_migration_to(:add_detected_at_field_to_vulnerability)
  end

  describe '#execute' do
    before do
      Elastic::ProcessBookkeepingService.track!(
        low_severity_vulnerability,
        high_severity_vulnerability,
        medium_severity_vulnerability
      )
      ensure_elasticsearch_index!
    end

    it "fetches count by each severity" do
      expect(execute["low"]["count"]).to eq(1)
      expect(execute["medium"]["count"]).to eq(1)
      expect(execute["high"]["count"]).to eq(1)
    end

    it "includes age aggregations in the result for each severity", :aggregate_failures do
      result = execute

      expect(result["low"]["avg_detected_at"]).to have_key("value")
      expect(result["low"]["median_detected_at"]).to have_key("values")
      expect(result["medium"]["avg_detected_at"]).to have_key("value")
      expect(result["medium"]["median_detected_at"]).to have_key("values")
      expect(result["high"]["avg_detected_at"]).to have_key("value")
      expect(result["high"]["median_detected_at"]).to have_key("values")
    end

    it_behaves_like 'a vulnerability elastic finder'
  end
end
