# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Security::VulnerabilityManagementPolicyRule, feature_category: :security_policy_management do
  it_behaves_like 'policy rule' do
    let(:rule_hash) { build(:vulnerability_management_policy)[:rules].first }
    let(:policy_type) { :vulnerability_management_policy }
  end

  describe 'associations' do
    it { is_expected.to belong_to(:security_policy) }
  end

  describe 'validations' do
    describe 'content' do
      subject(:rule) { build(:vulnerability_management_policy_rule, trait) }

      context 'when no_longer_detected' do
        let(:trait) { :no_longer_detected }

        it { is_expected.to be_valid }
      end
    end
  end

  describe '#match?' do
    context 'when rule type is no_longer_detected' do
      def severity_wildcard_should_match_all_severities
        ::Enums::Vulnerability.severity_levels.keys.map do |severity|
          [['sast'], [], :sast, severity, true]
        end
      end

      def scanner_wildcard_should_match_all_scanners
        ::Enums::Vulnerability.report_types.keys.map do |report_type|
          [[], ['critical'], report_type, 'critical', true]
        end
      end

      def should_match_if_partials_match
        [
          [%w[dependency_scanning container_scanning], %w[info low], :dependency_scanning, :info, true],
          [%w[dependency_scanning container_scanning], %w[info low], :dependency_scanning, :low, true],
          [%w[dependency_scanning container_scanning], %w[info low], :container_scanning, :info, true],
          [%w[dependency_scanning container_scanning], %w[info low], :container_scanning, :low, true]
        ]
      end

      def should_not_match_if_partials_dont_match
        [
          [%w[dependency_scanning container_scanning], %w[info low], :sast, :info, false],
          [%w[dependency_scanning container_scanning], %w[info low], :dependency_scanning, :critical, false],
          [%w[dependency_scanning container_scanning], %w[info low], :sast, :critical, false]
        ]
      end

      where(:policy_scanners, :policy_severities, :vulnerability_report_type, :vulnerability_severity, :expected) do
        severity_wildcard_should_match_all_severities +
          scanner_wildcard_should_match_all_scanners +
          should_match_if_partials_match +
          should_not_match_if_partials_dont_match
      end

      with_them do
        specify do
          rule = build_stubbed(:vulnerability_management_policy_rule,
            type: :no_longer_detected,
            content: { 'scanners' => policy_scanners, 'severity_levels' => policy_severities }
          )

          vulnerability = build_stubbed(:vulnerability,
            report_type: vulnerability_report_type,
            severity: vulnerability_severity
          )

          expect(rule.match?(vulnerability)).to eq(expected)
        end
      end
    end

    context 'when rule type is detected' do
      subject { rule.match?(vulnerability) }

      let_it_be(:project) { create(:project) }
      let!(:vulnerability) { finding.vulnerability }
      let(:rule) do
        build_stubbed(:vulnerability_management_policy_rule, type: :detected, content: rule_content)
      end

      shared_examples_for 'finding without file location' do
        context 'when finding has location but not file' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_dependency_scanning_metadata, project: project, file: nil)
          end

          it { is_expected.to be false }
        end

        context 'when finding has no location' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, raw_metadata: {}, location: nil)
          end

          it { is_expected.to be false }
        end
      end

      context 'with file_path criteria' do
        let(:rule_content) do
          {
            'criteria' => [
              {
                'type' => 'file_path',
                'value' => 'test/**/*'
              }
            ]
          }
        end

        context 'when finding matches file path pattern' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_dependency_scanning_metadata,
              project: project,
              file: 'test/spec/example_spec.rb')
          end

          it { is_expected.to be true }
        end

        context 'when finding does not match file path pattern' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_dependency_scanning_metadata,
              project: project,
              file: 'src/main.rb')
          end

          it { is_expected.to be false }
        end

        it_behaves_like 'finding without file location'
      end

      context 'with directory criteria' do
        let(:rule_content) do
          {
            'criteria' => [
              {
                'type' => 'directory',
                'value' => 'test'
              }
            ]
          }
        end

        context 'when finding is in matching directory' do
          let(:finding) do
            create(:vulnerabilities_finding,
              :detected, :with_dependency_scanning_metadata,
              project: project,
              file: 'test/example_spec.rb')
          end

          it { is_expected.to be true }
        end

        context 'when finding is in subdirectory of matching directory' do
          let(:finding) do
            create(:vulnerabilities_finding,
              :detected, :with_dependency_scanning_metadata,
              project: project,
              file: 'test/unit/example_spec.rb')
          end

          it { is_expected.to be true }
        end

        context 'when finding is in a non-matching directory' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_dependency_scanning_metadata,
              project: project, file: 'src/main.rb')
          end

          it { is_expected.to be false }
        end

        it_behaves_like 'finding without file location'
      end

      context 'with identifier criteria' do
        let(:rule_content) do
          {
            'criteria' => [
              {
                'type' => 'identifier',
                'value' => 'CVE-2023-*'
              }
            ]
          }
        end

        context 'when finding has matching identifier' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_cve, project: project, cve_value: 'CVE-2023-12345')
          end

          it { is_expected.to be true }
        end

        context 'when finding has non-matching identifier' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_cve, project: project, cve_value: 'CWE-79')
          end

          it { is_expected.to be false }
        end

        context 'when finding has no identifiers' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, project: project)
          end

          it { is_expected.to be false }
        end
      end

      context 'with multiple criteria (AND logic)' do
        let(:rule_content) do
          {
            'criteria' => [
              {
                'type' => 'file_path',
                'value' => 'test/**/*'
              },
              {
                'type' => 'identifier',
                'value' => 'CVE-2023-*'
              }
            ]
          }
        end

        context 'when finding matches all criteria' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_cve,
              project: project,
              location: { 'file' => 'test/spec/example_spec.rb' },
              cve_value: 'CVE-2023-12345')
          end

          it { is_expected.to be true }
        end

        context 'when finding matches only some criteria' do
          let(:finding) do
            create(:vulnerabilities_finding, :detected, :with_cve,
              project: project,
              location: { 'file' => 'src/main.rb' },
              cve_value: 'CVE-2023-12345')
          end

          it { is_expected.to be false }
        end
      end

      context 'with empty criteria' do
        let(:rule_content) do
          {
            'criteria' => []
          }
        end

        let(:finding) do
          create(:vulnerabilities_finding, :detected, project: project)
        end

        it { is_expected.to be false }
      end

      context 'with invalid criteria type' do
        let(:rule_content) do
          {
            'criteria' => [
              {
                'type' => 'invalid_criteria',
                'value' => 'some_value'
              }
            ]
          }
        end

        let(:finding) do
          create(:vulnerabilities_finding, :detected, project: project)
        end

        it { is_expected.to be false }
      end
    end
  end
end
