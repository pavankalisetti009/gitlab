# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Vulnerabilities::EnforceVulnerabilityReadDbTriggerFf, feature_category: :vulnerability_management do
  let_it_be(:project) { create(:project) }

  # Create a test class that extends the concern to test the transaction method
  let(:test_class) do
    Class.new(SecApplicationRecord) do
      extend Vulnerabilities::EnforceVulnerabilityReadDbTriggerFf
      self.table_name = 'vulnerability_occurrences'
    end
  end

  describe '.transaction' do
    context 'when in test environment' do
      before do
        allow(Rails.env).to receive(:test?).and_return(true)
      end

      context 'when db trigger flag is not set' do
        before do
          allow(test_class).to receive(:db_trigger_flag_not_set?).and_return(true)
        end

        it 'raises UnflaggedVulnReadDatabaseTriggerTransaction error' do
          expect do
            test_class.transaction do
              # Some transaction code
            end
          end.to raise_error(
            Vulnerabilities::EnforceVulnerabilityReadDbTriggerFf::UnflaggedVulnReadDatabaseTriggerTransaction,
            'This transaction is not passing the needed feature flag to the vulnerability read db trigger.'
          )
        end
      end

      context 'when db trigger flag is set' do
        before do
          allow(test_class).to receive(:db_trigger_flag_not_set?).and_return(false)
        end

        it 'executes the transaction successfully' do
          result = nil
          expect do
            result = test_class.transaction do
              'transaction_result'
            end
          end.not_to raise_error

          expect(result).to eq('transaction_result')
        end
      end
    end

    context 'when not in test environment' do
      before do
        allow(Rails.env).to receive(:test?).and_return(false)
        allow(test_class).to receive(:db_trigger_flag_not_set?).and_return(true)
      end

      context 'when db trigger flag is not set' do
        before do
          allow(test_class).to receive(:db_trigger_flag_not_set?).and_return(true)
        end

        it 'log a warning that an unflagged transaction was executed' do
          expect(Gitlab::AppLogger).to receive(:warn).with(
            "Sec transaction executed without setting vulnerability read db trigger feature flag!"
          )

          test_class.transaction do
            # Some transaction code
          end
        end
      end

      context 'when db trigger flag is set' do
        before do
          allow(test_class).to receive(:db_trigger_flag_not_set?).and_return(false)
        end

        it 'executes the transaction successfully' do
          expect(Gitlab::AppLogger).not_to receive(:warn)
          result = nil

          expect do
            result = test_class.transaction do
              'transaction_result'
            end
          end.not_to raise_error

          expect(result).to eq('transaction_result')
        end
      end
    end

    context 'when transaction fails' do
      before do
        allow(Rails.env).to receive(:test?).and_return(true)
        allow(test_class).to receive(:db_trigger_flag_not_set?).and_return(false)
      end

      it 'propagates the original error' do
        expect do
          test_class.transaction do
            raise StandardError, 'original error'
          end
        end.to raise_error(StandardError, 'original error')
      end
    end
  end
end
