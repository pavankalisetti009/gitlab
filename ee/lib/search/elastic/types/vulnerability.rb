# frozen_string_literal: true

module Search
  module Elastic
    module Types
      class Vulnerability
        class << self
          def index_name
            Search::Elastic::References::Vulnerability.index
          end

          def mappings
            mappings = base_mappings

            {
              dynamic: 'strict',
              properties: mappings
            }
          end

          def settings
            base_settings
          end

          private

          def base_mappings
            {
              type: { type: 'keyword' },
              id: { type: 'long' },
              vulnerability_id: { type: 'long' },
              created_at: { type: 'date' },
              updated_at: { type: 'date' },
              project_id: { type: 'long' },
              scanner_id: { type: 'long' },
              scanner_external_id: { type: 'text' },
              report_type: { type: 'short' }, # enum
              severity: { type: 'short' }, # enum
              state: { type: 'short' }, # enum
              has_issues: { type: 'boolean' },
              resolved_on_default_branch: { type: 'boolean' },
              uuid: { type: 'binary' },
              location_image: { type: 'text' },
              cluster_agent_id: { type: 'text' },
              casted_cluster_agent_id: { type: 'long' },
              dismissal_reason: { type: 'short' }, # enum
              has_merge_request: { type: 'boolean' },
              has_remediations: { type: 'boolean' },
              traversal_ids: { type: 'keyword' },
              archived: { type: 'boolean' },
              has_vulnerability_resolution: { type: 'boolean' },
              auto_resolved: { type: 'boolean' },
              identifier_names: { type: 'keyword' },
              epss_scores: { type: 'float' },
              schema_version: { type: 'short' }
            }
          end

          def base_settings
            ::Elastic::Latest::Config.settings.to_hash.deep_merge(
              index: ::Elastic::Latest::Config.separate_index_specific_settings(index_name)
            )
          end
        end
      end
    end
  end
end
