# frozen_string_literal: true

module Search
  module Elastic
    class VulnerabilityQueryBuilder < QueryBuilder
      extend ::Gitlab::Utils::Override

      DOC_TYPE = 'Vulnerability'

      def build
        query_hash = { query: { bool: ::Search::Elastic::BoolExpr.new } }

        query_hash = ::Search::Elastic::Filters.by_traversal_ids(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_archived_projects(
          query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_cluster_agent_id(
          query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_dismissal_reason(
          query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_has_ai_resolution(
          query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_has_issues(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_has_merge_request(
          query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_has_remediations(
          query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_has_resolution(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_identifier_names(
          query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_image(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_projects(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_report_type(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_scanner_ids(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_severities(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::VulnerabilityFilters.by_state(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::Formats.source_fields(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::Formats.page(query_hash: query_hash, options: options)
        query_hash = ::Search::Elastic::Formats.size(query_hash: query_hash, options: options)

        ::Search::Elastic::Sorts.sort_by(query_hash: query_hash, options: options)
      end

      private

      override :extra_options
      def extra_options
        {
          doc_type: DOC_TYPE,
          traversal_ids_prefix: :namespace_ancestry_ids
        }
      end
    end
  end
end
