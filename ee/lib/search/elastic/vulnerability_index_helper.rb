# frozen_string_literal: true

module Search
  module Elastic
    module VulnerabilityIndexHelper
      class << self
        def indexing_allowed?
          Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        # Used by the policy, which the ability flag uses to show or hide features on the UI.
        def advanced_vulnerability_management_allowed?
          saas_with_es? || dedicated_with_es? || self_managed_and_first_backfill_completed?
        end

        def self_managed_with_es?
          self_managed? && Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        def self_managed_and_first_backfill_completed?
          self_managed_with_es? &&
            ::Elastic::DataMigrationService.migration_has_finished?(
              :backfill_vulnerabilities_for_self_managed)
        end

        def backfill_migration_completed?(migration_name)
          # dependent_migrations will be skipped on self-managed.
          # `backfill_vulnerabilities_for_self_managed` completion status supercedes dependent migrations status.
          if dependent_migration?(migration_name)
            return true if migration_finished?(migration_name)

            return migration_finished?(:backfill_vulnerabilities_for_self_managed)
          end

          migration_finished?(migration_name)
        end

        def backfill_risk_score_completed?
          [:backfill_risk_score_in_vulnerabilities,
            :backfill_risk_score_in_vulnerabilities_no_saas].any? do |migration|
            migration_finished?(migration)
          end
        end

        private

        def saas_with_es?
          saas? && Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        def dedicated_with_es?
          dedicated? && Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        def saas?
          Gitlab::Saas.feature_available?(:advanced_search)
        end

        def dedicated?
          Gitlab::CurrentSettings.gitlab_dedicated_instance?
        end

        def self_managed?
          !saas? && !dedicated?
        end

        def dependent_migration?(migration_name)
          dependent_migrations = [
            :backfill_token_status_by_report_types_in_vulnerabilities
          ]

          dependent_migrations.include?(migration_name.to_sym)
        end

        def migration_finished?(migration_name)
          ::Elastic::DataMigrationService.migration_has_finished?(migration_name)
        end
      end
    end
  end
end
