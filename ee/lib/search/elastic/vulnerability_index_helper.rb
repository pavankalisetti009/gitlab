# frozen_string_literal: true

module Search
  module Elastic
    module VulnerabilityIndexHelper
      class << self
        def indexing_allowed?
          Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        # Used by the policy, which the ability flag uses to show or hide features on the UI.
        def advanced_vulnerability_management_allowed?
          saas_with_es? || dedicated_with_es? || self_managed_and_first_backfill_completed?
        end

        def self_managed_and_first_backfill_completed?
          self_managed_with_es? &&
            ::Elastic::DataMigrationService.migration_has_finished?(
              :backfill_vulnerabilities_for_self_managed)
        end

        private

        def saas_with_es?
          saas? && Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        def dedicated_with_es?
          dedicated? && Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        def self_managed_with_es?
          !saas? && !dedicated? && Gitlab::CurrentSettings.elasticsearch_indexing?
        end

        def saas?
          Gitlab::Saas.feature_available?(:advanced_search)
        end

        def dedicated?
          Gitlab::CurrentSettings.gitlab_dedicated_instance?
        end
      end
    end
  end
end
