# frozen_string_literal: true

module Search
  module Elastic
    module Preloaders
      module Vulnerability
        # Preloads token status information for vulnerability records.
        #
        # This preloader:
        # 1. Fetches token status values for a batch of vulnerability IDs
        # 2. Returns a hash mapping vulnerability_id to its token status
        class TokenStatus < Base
          # Preload token status data for all records
          #
          # @return [Hash{Integer => Integer}] vulnerability_id => status
          def perform_preload
            vulnerability_ids = record_identifiers
            return {} if vulnerability_ids.empty?

            fetch_token_status_data(vulnerability_ids)
          end

          private

          # Fetch token status information for findings linked to vulnerabilities.
          #
          # @param vulnerability_ids [Array<Integer>]
          # @return [Hash{Integer => Integer}] vulnerability_id => status
          def fetch_token_status_data(vulnerability_ids)
            ::Vulnerabilities::Finding
              .by_vulnerability(vulnerability_ids)
              .by_report_types(:secret_detection)
              .with_token_status
              .each_with_object({}) do |finding, result|
              result[finding.vulnerability_id] = finding.token_status
            end
          end
        end
      end
    end
  end
end
