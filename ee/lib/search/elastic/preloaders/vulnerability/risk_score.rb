# frozen_string_literal: true

module Search
  module Elastic
    module Preloaders
      module Vulnerability
        # Preloads risk score information for vulnerability records.
        #
        # This preloader:
        # 1. Fetches risk score values for a batch of vulnerability IDs
        # 2. Returns a hash mapping vulnerability_id to its risk score
        class RiskScore < Base
          # Preload risk score data for all records
          #
          # @return [Hash{Integer => Integer}] vulnerability_id => status
          def perform_preload
            vulnerability_ids = record_identifiers
            return {} if vulnerability_ids.empty?

            fetch_risk_score_data(vulnerability_ids)
          end

          private

          # Fetch risk score information for findings linked to vulnerabilities.
          #
          # @param vulnerability_ids [Array<Integer>]
          # @return [Hash{Integer => Integer}] vulnerability_id => risk_score
          def fetch_risk_score_data(vulnerability_ids)
            ::Vulnerabilities::Finding
              .by_vulnerability(vulnerability_ids)
              .with_risk_score
              .each_with_object({}) do |finding, result|
              result[finding.vulnerability_id] = finding.risk_score
            end
          end
        end
      end
    end
  end
end
