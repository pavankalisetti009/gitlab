# frozen_string_literal: true

module Search
  module Elastic
    module Preloaders
      module Vulnerability
        class PolicyViolations < Base
          def perform_preload
            security_findings_uuids = records.map(&:uuid)
            return {} if security_findings_uuids.empty?

            fetch_policy_violations_data(security_findings_uuids)
          end

          private

          def fetch_policy_violations_data(security_findings_uuids)
            project_ids = records.map(&:project_id)

            dismissed_uuids = ::Security::PolicyDismissal
                                .for_projects(project_ids)
                                .with_status(:preserved)
                                .for_security_findings_uuids(security_findings_uuids)
                                .pluck_security_findings_uuid.to_set

            records.each_with_object({}) do |record, result|
              result[record.vulnerability_id] = policy_violation(dismissed_uuids, record.uuid)
            end
          end

          def policy_violation(dismissed_uuids, uuid)
            is_dismissed = dismissed_uuids.include?(uuid)
            is_dismissed ? ::Security::PolicyViolations::DISMISSED_IN_MR : ::Security::PolicyViolations::NOT_APPLICABLE
          end
        end
      end
    end
  end
end
