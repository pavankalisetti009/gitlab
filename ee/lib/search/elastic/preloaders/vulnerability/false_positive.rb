# frozen_string_literal: true

module Search
  module Elastic
    module Preloaders
      module Vulnerability
        # Preloads whether vulnerabilities have a FalsePositive flag.
        #
        # Returns a Hash like:
        #   { 101 => true, 102 => false }
        class FalsePositive < Base
          # @return [Hash{Integer => Boolean}] vulnerability_id => has_false_positive_flag
          def perform_preload
            vulnerability_ids = record_identifiers
            return {} if vulnerability_ids.empty?

            fetch_false_positive_data(vulnerability_ids)
          end

          private

          def fetch_false_positive_data(vulnerability_ids)
            findings = ::Vulnerabilities::Finding
                         .by_vulnerability(vulnerability_ids)
                         .with_false_positive(true)
                         .select(:vulnerability_id)

            flagged_ids = findings.map(&:vulnerability_id).uniq

            vulnerability_ids.index_with do |id|
              flagged_ids.include?(id)
            end
          end
        end
      end
    end
  end
end
