# frozen_string_literal: true

module Search
  module Elastic
    module Preloaders
      module Vulnerability
        class PolicyAutoDismissed < Base
          def perform_preload
            # We need to preload the dismissed_by and group to avoid n+1 queries in
            # Vulnerability#dismissed_by_policy? check
            # The group is used to check if the auto_dismiss_vulnerability_policies
            # feature flag is enabled.
            # After removing the feature flag we can remove the group preload and the scope
            # with_group in the Vulnerability EE model
            vulnerabilities = ::Vulnerability.with_dismissed_by.with_group
                                             .by_ids(records.map(&:vulnerability_id))

            vulnerability_map = vulnerabilities.index_by(&:id)

            records.each_with_object({}) do |record, result|
              result[record.vulnerability_id] = vulnerability_map[record.vulnerability_id].dismissed_by_policy?
            end
          end
        end
      end
    end
  end
end
