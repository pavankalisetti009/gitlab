# frozen_string_literal: true

module Search
  module Elastic
    module Preloaders
      module Vulnerability
        # Preloads the undetected_since timestamp for vulnerabilities.
        #
        # Returns a Hash like:
        #   { vulnerability_id => undetected_since_timestamp }
        class UndetectedSince < Base
          # @return [Hash{Integer => date}] vulnerability_id => undetected_since_timestamp
          def perform_preload
            vulnerability_ids = record_identifiers

            return {} if vulnerability_ids.empty?

            fetch_undetected_since_data(vulnerability_ids)
          end

          private

          def fetch_undetected_since_data(vulnerability_ids)
            ::Vulnerabilities::Finding
              .by_vulnerability(vulnerability_ids)
              .with_latest_detection_transition
              .each_with_object({}) do |finding, result|
                next unless finding.vulnerability_id

                transition = finding.latest_detection_transition
                next if transition.nil? || transition.detected?

                result[finding.vulnerability_id] = transition.created_at
              end
          end
        end
      end
    end
  end
end
