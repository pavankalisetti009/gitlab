# frozen_string_literal: true

# Vulnerability::IdentifierNamesFinder
#
# Used to filter Vulnerability records for Vulnerabilities API from vulnerabilities elasticsearch index
#
# Arguments:
#   see in ee/lib/ee/search/advanced_finders/security/base_finder.rb

module Search
  module AdvancedFinders
    module Security
      module Vulnerability
        class IdentifierNamesFinder < BaseFinder
          def execute
            options = search_params.merge(
              {
                partial_identifier_name: params[:partial_identifier_name],
                search_identifier_names: true
              })

            query = ::Search::Elastic::VulnerabilityQueryBuilder.build(query: nil, options: options)
            Gitlab::Search::Client.execute_search(query: query, options: es_search_options) do |es_response|
              aggregations = ::Search::Elastic::ResponseMapper.new(es_response).aggregations
              parsed_aggregations = Gitlab::Search::AggregationParser.call(aggregations).first

              parsed_aggregations.buckets.pluck(:key) # rubocop:disable CodeReuse/ActiveRecord,-- not an active record object
            end
          end
        end
      end
    end
  end
end
