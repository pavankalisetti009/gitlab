# frozen_string_literal: true

module Gitlab
  module Llm
    module Templates
      module Vulnerabilities
        class ResolveVulnerabilityAnthropic < ResolveVulnerability
          include Gitlab::Llm::Chain::Concerns::AnthropicPrompt

          SYSTEM_MESSAGE = Gitlab::Llm::Chain::Utils::Prompt.as_system(
            <<~PROMPT.chomp
              You are a skilled security analyst and programmer tasked with resolving code security vulnerabilities.
              You will be given a vulnerability report and the corresponding source code. Your job is to analyze the report, determine if it's a false positive, and if not, provide a fix for the vulnerability.
            PROMPT
          )
          USER_MESSAGE = Gitlab::Llm::Chain::Utils::Prompt.as_user(
            <<~PROMPT.chomp
              First, carefully review the vulnerability report:

              <vulnerability_report>
              Name: %<name>s
              Description: %<vulnerability_description>s
              </vulnerability_report>

              %<identifiers>s

              Now, examine the source code from the file %<filename>s in question:

              <source_code>
              %<source_code>s
              </source_code>

              <vulnerable_code>
              %<vulnerable_code>s
              </vulnerable_code>

              Analyze the vulnerability report and the source code. Consider the following:
              1. The type of vulnerability reported (e.g., CWE, OWASP, linting rule)
              2. The specific part of the code that is flagged as vulnerable in the vulnerable_code section
              3. The potential security implications of the reported issue

              Consider the context of the code and whether the reported issue truly represents a security concern.

              <analysis>
              Provide your analysis here, explaining your reasoning. Ensure that it is markdown formatted with all the code highlighting if needed.
              </analysis>

              Provide a fix for the vulnerability. Your fix should:
              1. Address the specific security concern raised in the vulnerability report
              2. Maintain the original functionality of the code
              3. Follow best practices for secure coding

              <fixed_code>
              If applicable, provide your code fix here. Respond here only with fixed vulnerable code and no extra comments.
              Remember to keep original indentations! If no fix is needed or possible, leave it empty
              </fixed_code>

              Finally, provide a summary of your findings and actions:

              <summary>
              1. Briefly restate the reported vulnerability
              2. Summarize the fix you provided and explain how it addresses the security concern
              3. Ensure that it is markdown formatted with all the code highlighting if needed.
              </summary>

              Remember to be thorough in your analysis and clear in your explanations. Your goal is to ensure the security of the code while avoiding unnecessary changes.
              If you believe the vulnerability cannot be fixed without additional information, explain why in your analysis.
            PROMPT
          )

          private

          def max_code_length
            MAX_CHARACTERS / 10
          end

          def prompt
            {
              messages: Gitlab::Llm::Chain::Utils::Prompt.role_conversation(
                Gitlab::Llm::Chain::Utils::Prompt.format_conversation([USER_MESSAGE], variables)
              ),
              system: Gitlab::Llm::Chain::Utils::Prompt.no_role_text([SYSTEM_MESSAGE], variables),
              model: ::Gitlab::Llm::Anthropic::Client::CLAUDE_3_5_SONNET
            }
          end

          def variables
            {
              name: title,
              filename: filename,
              identifiers: formatted_identifiers,
              vulnerable_code: vulnerable_code.chomp,
              source_code: finding.source_code,
              vulnerability_description: vulnerability.description
            }
          end

          def formatted_identifiers
            identifiers = finding.identifier_names

            return '' if identifiers.empty?

            names = identifiers.join("\n* ")
            "<report_identifiers>\n * #{names}\n</report_identifiers>"
          end
        end
      end
    end
  end
end
