# frozen_string_literal: true

module API
  module Security
    module VulnerabilityScanning
      class SbomScans < ::API::Base
        helpers ::API::Ci::Helpers::Runner
        include ::API::Helpers::RelatedResourcesHelpers

        feature_category :software_composition_analysis
        urgency :low

        helpers do
          def check_feature_flag!(job)
            return if Feature.enabled?(:dependency_scanning_sbom_scan_api, job.project)

            forbidden!('Feature flag dependency_scanning_sbom_scan_api disabled for this project')
          end

          def check_license!(job)
            return if job.project.licensed_feature_available?(:dependency_scanning)

            forbidden!('License required for dependency scanning')
          end

          def handle_sbom_scan_status(sbom_scan)
            case sbom_scan.status_name
            when :created
              status 202
              { message: 'SBOM Vulnerability Scan has been queued and will start shortly' }
            when :running
              status 202
              { message: 'SBOM Vulnerability Scan is still in progress' }
            when :failed
              status 410
              { message: "SBOM Vulnerability Scan failed and results are not available. #{sbom_scan.error_message}" }
            when :finished
              present_carrierwave_file!(sbom_scan.result_file, content_type: 'application/json')
            else
              render_api_error!("Unexpected SBOM scan status: #{sbom_scan.status_name}", :internal_server_error)
            end
          end
        end

        resource :jobs do
          before { set_application_context }

          desc 'Authorize uploading SBOM file to be scanned' do
            tags ['software_composition_analysis']
            success code: 200, message: 'SBOM Upload allowed'
            failure [
              { code: 403, message: 'Forbidden' },
              { code: 413, message: 'File too large' }
            ]
          end
          params do
            requires :id, type: Integer, desc: "Job's ID"
            optional :filesize, type: Integer, desc: 'Size of artifact file'
          end
          post '/:id/sbom_scans/authorize' do
            require_gitlab_workhorse!

            job = authenticate_job!

            check_feature_flag!(job)
            check_license!(job)

            check_rate_limit! :dependency_scanning_sbom_scan_api_upload, scope: job.project

            result = ::Security::VulnerabilityScanning::CreateSbomScanService.new(job)
              .authorize(filesize: params[:filesize])

            if result.success?
              content_type Gitlab::Workhorse::INTERNAL_API_CONTENT_TYPE
              status :ok
              result.payload[:headers]
            else
              render_api_error!(result.message, result.reason)
            end
          end

          desc 'Upload an SBOM file to be scanned' do
            tags ['software_composition_analysis']
            success code: 201, model: ::API::Entities::Security::VulnerabilityScanning::SbomScan
            failure [
              { code: 400, message: 'Bad request' },
              { code: 403, message: 'Forbidden' },
              { code: 413, message: 'File too large' }
            ]
          end
          params do
            requires :id, type: Integer, desc: "Job's ID"
            requires :file, type: ::API::Validations::Types::WorkhorseFile, desc: "The sbom file to upload",
              documentation: { type: 'file' }
          end
          post '/:id/sbom_scans' do
            require_gitlab_workhorse!

            job = authenticate_job!

            check_feature_flag!(job)
            check_license!(job)

            result = ::Security::VulnerabilityScanning::CreateSbomScanService.new(job).execute(params[:file])

            if result.success?
              status :created

              present_options = { with: ::API::Entities::Security::VulnerabilityScanning::SbomScan }
              if result.payload[:throttled]
                present_options.merge!(result.payload.slice(:throttled, :project_throttling_resets_in))
              end

              present_options[:advisory_db_state] =
                { sync_status: PackageMetadata::Checkpoint.advisory_purl_type_sequences }

              present result.payload[:sbom_scan], present_options
            else
              render_api_error!(result.message, result.reason)
            end
          end

          desc 'Download an SBOM scan result file' do
            tags ['software_composition_analysis']
            success [
              { code: 200, model: ::API::Entities::Security::VulnerabilityScanning::SbomScan },
              { code: 202, message: 'Sbom Scan in progress' }
            ]
            failure [
              { code: 400, message: 'Bad request' },
              { code: 403, message: 'Forbidden' },
              { code: 410, message: 'Sbom Scan failed' }
            ]
            is_array true
          end
          params do
            requires :id, type: Integer, desc: "Job's ID"
            requires :sbom_scan_id, type: Integer, desc: "SBOM Scan's ID"
          end
          get '/:id/sbom_scans/:sbom_scan_id' do
            job = authenticate_job!

            check_feature_flag!(job)
            check_license!(job)

            check_rate_limit! :dependency_scanning_sbom_scan_api_download, scope: job.project

            sbom_scan = ::Security::VulnerabilityScanning::SbomScan.for_build(job).find(params[:sbom_scan_id])

            not_found!('SBOM Vulnerability Scan') if sbom_scan.nil?

            handle_sbom_scan_status(sbom_scan)
          end
        end
      end
    end
  end
end
