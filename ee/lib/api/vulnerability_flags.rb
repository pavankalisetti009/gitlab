# frozen_string_literal: true

module API
  class VulnerabilityFlags < ::API::Base
    include ::API::Helpers::VulnerabilitiesHelpers
    include APIGuard

    feature_category :vulnerability_management
    urgency :low

    allow_access_with_scope :ai_workflows

    before { authenticate! }

    helpers ::API::Helpers::VulnerabilitiesHelpers

    helpers do
      def find_vulnerability!
        Vulnerability.with_findings.find(params[:vulnerability_id])
      end
    end

    params do
      requires :vulnerability_id, type: String, desc: 'The ID of a vulnerability'
    end
    resource :vulnerabilities do
      route_param :vulnerability_id do
        resource :flags do
          desc 'Update AI SAST False Positive detection results' do
            detail 'This feature is currently in an experimental state. ' \
              'Updates the confidence score and explanation for AI-based SAST false positive detection.'
            success code: 200
            failure [
              { code: 400, message: 'Bad Request' },
              { code: 401, message: 'Unauthorized' },
              { code: 404, message: 'Not Found' }
            ]
            tags %w[vulnerabilities]
          end
          params do
            requires :confidence_score, type: Integer, desc: 'Confidence score from 0-100',
              values: 0..100
            requires :description, type: String, desc: 'Explanation for the detection result',
              allow_blank: false
          end
          post :ai_detection do
            vulnerability = find_and_authorize_vulnerability!(:admin_vulnerability)

            result = ::Vulnerabilities::Flags::UpdateAiDetectionService.new(
              current_user,
              vulnerability,
              declared_params(include_missing: false)).execute

            if result.success?
              if result.payload[:is_new_flag]
                status 201
              else
                status 200
              end

              { message: 'AI detection results updated successfully' }
            else
              render_api_error!(result.message, 400)
            end
          end
        end
      end
    end
  end
end
