# frozen_string_literal: true

module EE
  module Banzai
    module Filter
      module References
        # HTML filter that replaces vulnerability references with links. References to
        # vulnerabilities that do not exist are ignored.
        #
        # This filter supports cross-project/group references.
        module VulnerabilityReferenceFilter
          extend ActiveSupport::Concern

          def references_in(text, pattern = object_class.reference_pattern)
            replace_references_in_text_with_html(text.gsub(pattern)) do |match_data|
              symbol = match_data[object_sym]
              if object_class.reference_valid?(symbol)
                yield match_data[0], symbol.to_i, match_data[:project], match_data[:namespace], match_data
              end
            end
          end

          def url_for_object(vulnerability, project)
            urls = ::Gitlab::Routing.url_helpers
            urls.project_security_vulnerability_url(project, vulnerability, only_path: context[:only_path])
          end

          def data_attributes_for(original, project, object, link_content: false, link_reference: false)
            {
              original: original,
              link: link_content,
              link_reference: link_reference,
              project: project.id,
              object_sym => object.id
            }
          end

          def parent_records(parent, ids)
            return ::Vulnerability.none if ids.blank? || parent.nil?

            parent.vulnerabilities.id_in(ids.to_a)
          end

          def record_identifier(record)
            record.id.to_i
          end

          def parent_type
            :project
          end
        end
      end
    end
  end
end
