# frozen_string_literal: true

module EE
  module Gitlab
    module BackgroundMigration
      module SetProjectVulnerabilityCount
        extend ActiveSupport::Concern
        extend ::Gitlab::Utils::Override

        prepended do
          scope_to ->(relation) { relation.where("has_vulnerabilities IS TRUE") }
          operation_name :set_project_vulnerability_count
          feature_category :vulnerability_management
        end

        class ProjectStatistics < ApplicationRecord
          self.table_name = 'project_statistics'
        end

        class VulnerabilityRead < ApplicationRecord
          include EachBatch

          self.table_name = 'vulnerability_reads'
          self.primary_key = :vulnerability_id
        end

        override :perform

        def perform
          each_sub_batch do |sub_batch|
            sub_batch.each do |project_settings|
              project_statistics = ProjectStatistics.find_by(project_id: project_settings.project_id)
              latest_vulnerability_id = nil

              ProjectStatistics.transaction do
                project_statistics.lock!

                latest_vulnerability_id = VulnerabilityRead.where(project_id: project_settings.project_id).last&.id

                project_statistics.vulnerability_count = 0
                project_statistics.save!
              end

              next unless latest_vulnerability_id

              total_count = 0

              VulnerabilityRead.where('project_id = ? AND vulnerability_id <= ?',
                project_settings.project_id, latest_vulnerability_id).each_batch do |batch|
                total_count += batch.count
              end

              ProjectStatistics.connection.exec_query(update_query, 'UPDATE', [total_count, project_statistics.id])
            end
          end
        end

        def update_query
          <<~SQL
            UPDATE
              project_statistics
            SET
              vulnerability_count = vulnerability_count + $1
            WHERE
              id = $2
          SQL
        end
      end
    end
  end
end
