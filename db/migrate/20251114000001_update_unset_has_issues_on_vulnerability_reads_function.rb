# frozen_string_literal: true

class UpdateUnsetHasIssuesOnVulnerabilityReadsFunction < Gitlab::Database::Migration[2.3]
  milestone '18.6'

  def up
    execute <<~SQL
      CREATE OR REPLACE FUNCTION unset_has_issues_on_vulnerability_reads() RETURNS trigger
        LANGUAGE plpgsql
        AS $$
      BEGIN
        IF (SELECT current_setting('vulnerability_management.dont_execute_db_trigger', true) = 'true') THEN
          RETURN NULL;
        END IF;

        IF NOT EXISTS (
          SELECT 1 FROM vulnerability_issue_links
          WHERE vulnerability_id = OLD.vulnerability_id
        ) THEN
          UPDATE vulnerability_reads SET has_issues = false
          WHERE vulnerability_id = OLD.vulnerability_id;
        END IF;
        RETURN NULL;
      END
      $$;
    SQL
  end

  def down
    execute <<~SQL
      CREATE OR REPLACE FUNCTION unset_has_issues_on_vulnerability_reads() RETURNS trigger
        LANGUAGE plpgsql
        AS $$
      BEGIN
        IF NOT EXISTS (
          SELECT 1 FROM vulnerability_issue_links
          WHERE vulnerability_id = OLD.vulnerability_id
        ) THEN
          UPDATE vulnerability_reads SET has_issues = false
          WHERE vulnerability_id = OLD.vulnerability_id;
        END IF;
        RETURN NULL;
      END
      $$;
    SQL
  end
end
